var Rating=Class.create();Object.extend(Object.extend(Rating.prototype,MenuBase.prototype),{STAR_COUNT:10,initializeMenuDOM:function(){var f=new StringBuilder();for(var e=0,d=this.STAR_COUNT;e<d;e++){f.append('<li class="off"></li>')}this.menuRegion.innerHTML=f.toString();this.menuRegion=$(this.menuRegion);this.menus=this.menuRegion.immediateDescendants()},initializeMenu:function(){this._rating=this.rating;this.menuOn=null;this.menuIndex=-1;this.enableHandle=true},destroyMenu:function(){this.menuOn=null;this.menuIndex=null},render:function(){this.renderRating(this.rating)},setValue:function(b){this.rating=b;this.render()},hasChange:function(){if(this._rating!=this.rating){return true}return false},getValue:function(){return this.rating},onMenuOverCallback:function(e,d){if(!this.readonly&&this.enableHandle){var f=this.getRatingValue(d);this.renderRating(f);if(this.onOverRatingCallback){this.onOverRatingCallback(f)}}},onMenuOutCallback:function(d,c){this.renderRating(this.rating);if(this.onOutRatingCallback){this.onOutRatingCallback(this.rating)}},onClickMenuCallback:function(e,d){if(!this.readonly){if(this.enableHandle){var f=this.getRatingValue(d);this.rating=f;this.renderRating(f);if(this.onRatingCallback){this.onRatingCallback(f)}}else{}}},renderRating:function(j){var i=this.menus,l=null,k=0;for(var h=0,g=i.length;h<g;h++){l=i[h];k=h+1;if(k<=Math.ceil(j)){l.className=k<=j?"on":"half"}else{l.className="off"}}},getRatingValue:function(b){return b+1}});var RatingDialog=Class.create();RatingDialog.prototype={MIN_COMMENT_COUNT:5,MIN_COMMENT_DESCRIPTION:"你的点评字数不应该小于{0}字",MAX_COMMENT_COUNT:210,MAX_COMMENT_DESCRIPTION:"你的点评字数不应该大于{0}字",MAX_FAVORITEREASON_COUNT:210,MAX_FAVORITEREASON_DESCRIPTION:"收藏理由字数不应该大于{0}字",server:{getTags:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","GetTags2",[f,e],d,"/database/databaseService.m?Ajax_CallBack=true","get","20000")},getFavoriteCategorys:function(h,g,f,e){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","GetFavoriteCategorys2",[h,g,f],e,"/database/databaseService.m?Ajax_CallBack=true","get","20000")},createCategory:function(c,d){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","CreateFavoriteCategory2",[c],d,"/database/databaseService.m?Ajax_CallBack=true","post","20000")},rating:function(F,T,ad,O,D,L,U,aa,Z,I,Y,X,K,H,N,ac,M,C,Q,P,S,J,R,W,V,E,ab,G){return Mtime.Component.Ajax.getCrossDomain("Mtime.Community.Controls.CommunityPages.DatabaseService","RatingMovieAll",[F,T,ad,O,D,L,U,aa,Z,I,Y,X,K,H,N,ac,M,C,Q,P,S,J,R,W,V,E],G,"/database/databaseService.m?Ajax_CallBack=true","post","20000",ab)}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){$loadJs("/js/08/theaterSearchBox.js",function(){this.setOptions(b);this.showDialog()}.bind(this))},showDialog:function(){this.dialog=new Dialog({windowStyle:"width: 625px;",content:Builder.node("div",{className:"clearfix ml15 mr15"},[Builder.node("div",{id:"w_totalRatingRegion",style:"display:none;"},[Builder.node("div",{className:"clearfix"},[Builder.node("strong",["我的评分："]),Builder.node("b",{id:"w_userRatingDescriptionLabel",className:"c_a5"})]),Builder.node("div",{className:"clearfix mt9"},[Builder.node("em",{className:"c_666 fl mr6"},["已看过"]),Builder.node("div",{className:"fl"},[Builder.node("ul",{id:"w_totalRatingContainer",className:"clearfix grating fl"},[])]),Builder.node("p",{className:"movie_ratenum_s c_green fl tahoma lh30 ml15"},[Builder.node("span",{id:"w_userRatingBigLabel",className:"s fl"}),Builder.node("span",{id:"w_userRatingSmallLabel",className:"g fl"})]),Builder.node("p",{className:"fl mt3 ml20"},[Builder.node("a",{id:"w_ratingDetailButton",href:"#",className:"c_green",onclick:"return false;"},["分项评分"]),Builder.node("span",{className:"gt c_green"},[">>"])])])]),Builder.node("div",{id:"w_detailRatingRegion",style:"display:none;"},[Builder.node("div",{className:"clearfix"},[Builder.node("strong",{className:"fl"},["我的评分："]),Builder.node("p",{className:"movie_ratenum_s c_green fl tahoma lh30 ml15"},[Builder.node("span",{id:"w_userRatingBig2Label",className:"s fl"}),Builder.node("span",{id:"w_userRatingSmall2Label",className:"g fl"})]),Builder.node("span",{id:"w_userRatingDescription2Label",className:"c_a5 fl ml15"})]),Builder.node("p",{className:"line_dot mt9"},[]),Builder.node("div",{className:"clearfix mt9"},[Builder.node("div",{className:"fl w295"},[Builder.node("ul",[Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["印象："]),Builder.node("ul",{id:"userImpressRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userImpressRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userImpressRatingLabel",className:"ml9 fl c_666"})]),Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["故事："]),Builder.node("ul",{id:"userStoryRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userStoryRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userStoryRatingLabel",className:"ml9 fl c_666"})]),Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["表演："]),Builder.node("ul",{id:"userShowRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userShowRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userShowRatingLabel",className:"ml9 fl c_666"})])])]),Builder.node("div",{className:"fr w295"},[Builder.node("ul",[Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["导演："]),Builder.node("ul",{id:"userDirectorRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userDirectorRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userDirectorRatingLabel",className:"ml9 fl c_666"})]),Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["画面："]),Builder.node("ul",{id:"userPictureRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userPictureRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userPictureRatingLabel",className:"ml9 fl c_666"})]),Builder.node("li",{className:"mt9 clearfix"},[Builder.node("h5",{className:"normal fl"},["音乐："]),Builder.node("ul",{id:"userMusicRatingContainer",className:"clearfix grating fl"}),Builder.node("span",{id:"userMusicRatingSpan",className:"fl bold c_green ml9"}),Builder.node("strong",{id:"userMusicRatingLabel",className:"ml9 fl c_666"})])])])])]),Builder.node("p",{className:"line_dot mt9"}),Builder.node("div",{className:"clearfix mt9"},[Builder.node("div",{className:"fl w255"},[Builder.node("p",["添加一句话影评",Builder.node("b",{className:"c_a5"},["(可选)"])]),Builder.node("p",{className:"mt6"},[Builder.node("textarea",{id:"w_commentText",rows:"4",className:"w245 bor_a5 c_a5"},["输入你的点评文字，最少不少于5个字.."])]),Builder.node("p",{className:"mt20"},["添加标签",Builder.node("b",{className:"c_a5"},["(可选)"])]),Builder.node("p",{className:"mt6"},[Builder.node("input",{id:"w_tagText",type:"text",className:"w245 bor_a5 c_a5"})]),Builder.node("p",{id:"w_TagRegion",className:"mt3"},[Builder.node("a",{href:"#",onclick:"return false;",method:"show"},["从使用最频繁的标签中选择"])])]),Builder.node("div",{className:"fr w330"},[Builder.node("p",[Builder.node("input",{id:"w_hasMoviegoingLogCheckbox",type:"checkbox",className:"mr6"}),"观影方式"]),Builder.node("div",{id:"w_moviegoingLogRegion",className:"p_r"},[Builder.node("div",{id:"w_moviegoingLogOverlap",style:"background:#fff; filter:alpha(opacity=70); -moz-opacity:0.7; opacity:0.7; position:absolute; width:330px; height:130px;+height:150px; z-index:100;"}),Builder.node("p",{className:"mt6"},[Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType1",type:"radio",className:"mr6",checked:"checked",value:"1"}),Builder.node("label",{htmlFor:"radioMoviegoingType1",className:"mr9"},["电影院"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType2",type:"radio",className:"mr6",value:"2"}),Builder.node("label",{htmlFor:"radioMoviegoingType2",className:"mr9"},["DVD"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType3",type:"radio",className:"mr6",value:"3"}),Builder.node("label",{htmlFor:"radioMoviegoingType3",className:"mr9"},["下载"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType4",type:"radio",className:"mr6",value:"4"}),Builder.node("label",{htmlFor:"radioMoviegoingType4",className:"mr9"},["在线观看"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType5",type:"radio",className:"mr6",value:"5"}),Builder.node("label",{htmlFor:"radioMoviegoingType5",className:"mr9"},["电视台"])]),Builder.node("div",{className:"bor_a5 p6 mt12"},[Builder.node("p",{id:"moviegoingCinemaRegion"},["观影地点：",Builder.node("input",{id:"iptMoviegoingCinema",type:"text",value:"点击选择影院",className:"c_666 w110"})]),Builder.node("p",{className:"mt12"},["观影时间：",Builder.node("input",{id:"iptMoviegoingYear",type:"text",size:"5",maxlength:4,style:"ime-mode: disabled"}),"年",Builder.node("input",{id:"iptMoviegoingMonth",type:"text",size:"3",maxlength:2,style:"ime-mode: disabled"}),"月",Builder.node("input",{id:"iptMoviegoingDay",type:"text",size:"3",maxlength:2,style:"ime-mode: disabled"}),"日"]),Builder.node("p",{className:"mt12 clearfix c_a5 tr"},["以上非必填"])])]),Builder.node("p",{className:"mt9"},[Builder.node("input",{id:"w_isAddToFavoriteCheckbox",type:"checkbox",className:"mr6"}),"添加到我的收藏"]),Builder.node("div",{id:"w_favoriteRegion",className:"p_r",style:"display:none"},[Builder.node("div",{id:"createFavoriteCategoryWindow",className:"m_winpop2",style:"visibility:hidden; position: absolute; width: 200px; left: 48px; top: 30px; z-index: 1;"},[Builder.node("img",{alt:"",className:"top_icon",src:"/images08/m_popt_r.gif"}),Builder.node("h4",{className:"normal"},["分类名称："]),Builder.node("input",{id:"favoriteCategoryText",type:"text",className:"bor_a5 mt3",style:"width:190px;"}),Builder.node("p",{className:"mt10 tc"},[Builder.node("input",{id:"confirmCreateFavoriteCategoryButton",type:"button",value:"确 认",className:"btn_square_hover mr15"}),Builder.node("input",{id:"cancelCreateFavoriteCategoryButton",type:"button",value:"取 消",className:"btn_square",onmouseover:"this.className='btn_square_hover';",onmouseout:"this.className='btn_square';"})])]),Builder.node("div",{id:"w_favoriteOverlap",style:"background:#fff; filter:alpha(opacity=70); -moz-opacity:0.7; opacity:0.7; position:absolute; width:290px; height:175px; z-index:100;"}),Builder.node("p",{className:"mt6"},[Builder.node("label",{htmlFor:"w_favoriteCategory"},["请选择收藏分类"]),Builder.node("select",{id:"w_favoriteCategory",className:"ml9 mr9 w126",disabled:"disabled"},[Builder.node("option"),"不放入任何分类"]),Builder.node("a",{id:"w_addFavoriteCategoryButton",href:"#",onclick:"return false;"},["添加新分类"])]),Builder.node("p",{className:"mt6"},["我有",Builder.node("label",{className:"ml9",htmlFor:"w_hasDvdCheckbox"},[Builder.node("input",{id:"w_hasDvdCheckbox",type:"checkbox",className:"mr5"}),"DVD"]),Builder.node("label",{className:"ml9",htmlFor:"w_hasCdCheckbox"},[Builder.node("input",{id:"w_hasCdCheckbox",type:"checkbox",className:"mr5"}),"CD"]),Builder.node("label",{className:"ml9",htmlFor:"w_hasPosterCheckbox"},[Builder.node("input",{id:"w_hasPosterCheckbox",type:"checkbox",className:"mr5"}),"海报"])]),Builder.node("p",{className:"mt9"},["收藏理由：",Builder.node("textarea",{id:"w_favoriteReasonText",className:"block bor_a5",cols:"40",rows:"6",style:"height:85px;width:280px;"})])])])]),Builder.node("p",{id:"hint",className:"mt9 c_red tc"}),Builder.node("p",{className:"line_dot mt12"})]),buttonRegionClass:"mt15 mb15 tc",buttons:[{title:"确定",buttonStyle:"btn_square_hover mr15",callback:this.onConfirmRating.bind(this)},{title:"取消",onmouseover:"this.className='btn_square_hover'",onmouseout:"this.className='btn_square'",buttonStyle:"btn_square",callback:function(b){if(this.cancelCallback){this.cancelCallback(b)}b.close()}.bind(this)}],readyCallback:this.onDialogReady.bind(this),closeCallback:this.onDialogClose.bind(this),onClickCloseCallback:this.closeCallback||Prototype.emptyFunction})},onDialogReady:function(b){this.initializeField();this.initializeDOM(b);this.initializeEvent();this.initializeControl();this.load()},onDialogClose:function(b){this.destroyControl();this.destroyEvent();this.destroyDOM()},initializeField:function(){this._rating=this.rating;this._userRating=this.userRating},initializeDOM:function(b){this.hint=b.getEl("hint");this.totalRatingRegion=b.getEl("w_totalRatingRegion");this.userRatingDescriptionLabel=b.getEl("w_userRatingDescriptionLabel");this.totalRatingContainer=b.getEl("w_totalRatingContainer");this.userRatingBigLabel=b.getEl("w_userRatingBigLabel");this.userRatingSmallLabel=b.getEl("w_userRatingSmallLabel");this.ratingDetailButton=b.getEl("w_ratingDetailButton");this.detailRatingRegion=b.getEl("w_detailRatingRegion");this.userRatingBig2Label=b.getEl("w_userRatingBig2Label");this.userRatingSmall2Label=b.getEl("w_userRatingSmall2Label");this.userRatingDescription2Label=b.getEl("w_userRatingDescription2Label");this.userImpressRatingContainer=b.getEl("userImpressRatingContainer");this.userImpressRatingSpan=b.getEl("userImpressRatingSpan");this.userImpressRatingLabel=b.getEl("userImpressRatingLabel");this.userStoryRatingContainer=b.getEl("userStoryRatingContainer");this.userStoryRatingSpan=b.getEl("userStoryRatingSpan");this.userStoryRatingLabel=b.getEl("userStoryRatingLabel");this.userShowRatingContainer=b.getEl("userShowRatingContainer");this.userShowRatingSpan=b.getEl("userShowRatingSpan");this.userShowRatingLabel=b.getEl("userShowRatingLabel");this.userDirectorRatingContainer=b.getEl("userDirectorRatingContainer");this.userDirectorRatingSpan=b.getEl("userDirectorRatingSpan");this.userDirectorRatingLabel=b.getEl("userDirectorRatingLabel");this.userPictureRatingContainer=b.getEl("userPictureRatingContainer");this.userPictureRatingSpan=b.getEl("userPictureRatingSpan");this.userPictureRatingLabel=b.getEl("userPictureRatingLabel");this.userMusicRatingContainer=b.getEl("userMusicRatingContainer");this.userMusicRatingSpan=b.getEl("userMusicRatingSpan");this.userMusicRatingLabel=b.getEl("userMusicRatingLabel");this.commentText=b.getEl("w_commentText");this.tagText=b.getEl("w_tagText");this.tagRegion=b.getEl("w_TagRegion");this.hasMoviegoingLogCheckbox=b.getEl("w_hasMoviegoingLogCheckbox");this.moviegoingLogRegion=b.getEl("w_moviegoingLogRegion");this.moviegoingLogOverlap=b.getEl("w_moviegoingLogOverlap");this.moviegoingCinemaRegion=b.getEl("moviegoingCinemaRegion");this.iptMoviegoingCinema=b.getEl("iptMoviegoingCinema");this.iptMoviegoingYear=b.getEl("iptMoviegoingYear");this.iptMoviegoingMonth=b.getEl("iptMoviegoingMonth");this.iptMoviegoingDay=b.getEl("iptMoviegoingDay");this.isAddToFavoriteCheckbox=b.getEl("w_isAddToFavoriteCheckbox");this.favoriteRegion=b.getEl("w_favoriteRegion");this.favoriteOverlap=b.getEl("w_favoriteOverlap");this.favoriteCategory=b.getEl("w_favoriteCategory");this.addFavoriteCategoryButton=b.getEl("w_addFavoriteCategoryButton");this.hasDvdCheckbox=b.getEl("w_hasDvdCheckbox");this.hasCdCheckbox=b.getEl("w_hasCdCheckbox");this.hasPosterCheckbox=b.getEl("w_hasPosterCheckbox");this.favoriteReasonText=b.getEl("w_favoriteReasonText");this.createCategoryWindow=b.getEl("createFavoriteCategoryWindow");this.categoryText=b.getEl("favoriteCategoryText");this.confirmCreateCategoryButton=b.getEl("confirmCreateFavoriteCategoryButton");this.cancelCreateCategoryButton=b.getEl("cancelCreateFavoriteCategoryButton")},destroyDOM:function(){this.hint=null;this.totalRatingRegion=null;this.userRatingDescriptionLabel=null;this.totalRatingContainer=null;this.userRatingBigLabel=null;this.userRatingSmallLabel=null;this.ratingDetailButton=null;this.detailRatingRegion=null;this.userRatingBig2Label=null;this.userRatingSmall2Label=null;this.userRatingDescription2Label=null;this.commentText=null;this.tagText=null;this.tagRegion=null;this.hasMoviegoingLogCheckbox=null;this.moviegoingLogRegion=null;this.moviegoingLogOverlap=null;this.moviegoingCinemaRegion=null;this.iptMoviegoingCinema=null;this.iptMoviegoingYear=null;this.iptMoviegoingMonth=null;this.iptMoviegoingDay=null;this.isAddToFavoriteCheckbox=null;this.favoriteRegion=null;this.favoriteOverlap=null;this.favoriteCategory=null;this.addFavoriteCategoryButton=null;this.hasDvdCheckbox=null;this.hasCdCheckbox=null;this.hasPosterCheckbox=null;this.favoriteReasonText=null;this.userImpressRatingContainer=null;this.userImpressRatingLabel=null;this.userStoryRatingContainer=null;this.userStoryRatingLabel=null;this.userShowRatingContainer=null;this.userShowRatingLabel=null;this.userDirectorRatingContainer=null;this.userDirectorRatingLabel=null;this.userPictureRatingContainer=null;this.userPictureRatingLabel=null;this.userMusicRatingContainer=null;this.userMusicRatingLabel=null;this.commentText=null;this.createCategoryWindow=null;this.categoryText=null;this.confirmCreateCategoryButton=null;this.cancelCreateCategoryButton=null},initializeEvent:function(){this.onClickRatingDetailButtonHandler=this.onClickRatingDetailButton.bind(this);this.ratingDetailButton.observe("click",this.onClickRatingDetailButtonHandler);this.onClickTagRegionHandler=this.onClickTagRegion.bindAsEventListener(this);this.tagRegion.observe("click",this.onClickTagRegionHandler);this.onHasMoviegoingLogCheckBoxClickHandler=this.onHasMoviegoingLogCheckBoxClick.bindAsEventListener(this);this.hasMoviegoingLogCheckbox.observe("click",this.onHasMoviegoingLogCheckBoxClickHandler);this.onMoviegoingLogRegionClickHandler=this.onMoviegoingLogRegionClick.bindAsEventListener(this);this.moviegoingLogRegion.observe("click",this.onMoviegoingLogRegionClickHandler);this.onMoviegoingDateBlurHandler=this.onMoviegoingDateBlur.bindAsEventListener(this);this.iptMoviegoingYear.observe("blur",this.onMoviegoingDateBlurHandler);this.iptMoviegoingMonth.observe("blur",this.onMoviegoingDateBlurHandler);this.iptMoviegoingDay.observe("blur",this.onMoviegoingDateBlurHandler);this.onClickIsAddToFavoriteCheckboxHandler=this.onClickIsAddToFavoriteCheckbox.bind(this);this.isAddToFavoriteCheckbox.observe("click",this.onClickIsAddToFavoriteCheckboxHandler);this.onClickAddFavoriteCategoryButtonHandler=this.onClickAddFavoriteCategoryButton.bind(this);this.addFavoriteCategoryButton.observe("click",this.onClickAddFavoriteCategoryButtonHandler);this.onClickConfirmCreateCategoryButtonHandler=this.onClickConfirmCreateCategoryButton.bind(this);this.confirmCreateCategoryButton.observe("click",this.onClickConfirmCreateCategoryButtonHandler);this.onClickCancelCreateCategoryButtonHandler=this.onClickCancelCreateCategoryButton.bind(this);this.cancelCreateCategoryButton.observe("click",this.onClickCancelCreateCategoryButtonHandler)},destroyEvent:function(){this.ratingDetailButton.stopObserving("click",this.onClickRatingDetailButtonHandler);this.tagRegion.stopObserving("click",this.onClickTagRegionHandler);this.hasMoviegoingLogCheckbox.stopObserving("click",this.onHasMoviegoingLogCheckBoxClickHandler);this.moviegoingLogRegion.stopObserving("click",this.onMoviegoingLogRegionClickHandler);this.iptMoviegoingYear.stopObserving("blur",this.onMoviegoingDateBlurHandler);this.iptMoviegoingMonth.stopObserving("blur",this.onMoviegoingDateBlurHandler);this.iptMoviegoingDay.stopObserving("blur",this.onMoviegoingDateBlurHandler);this.isAddToFavoriteCheckbox.stopObserving("click",this.onClickIsAddToFavoriteCheckboxHandler);this.addFavoriteCategoryButton.stopObserving("click",this.onClickAddFavoriteCategoryButtonHandler);this.confirmCreateCategoryButton.stopObserving("click",this.onClickConfirmCreateCategoryButtonHandler);this.cancelCreateCategoryButton.stopObserving("click",this.onClickCancelCreateCategoryButtonHandler)},initializeControl:function(){this.totalRatingControl=null;var b=function(d){this.userRatingDescriptionLabel.innerHTML=this.getUserRatingDescription(d);var a=this.getRating(d);this.renderUserTotalRating(a)}.bind(this);this.totalRatingControl=new Rating({menuRegion:this.totalRatingContainer,rating:this.rating,readonly:false,onOverRatingCallback:b,onOutRatingCallback:b});b(this.rating);this.userImpressRatingControl=null;this.userStoryRatingControl=null;this.userShowRatingControl=null;this.userDirectorRatingControl=null;this.userPictureRatingControl=null;this.userMusicRatingControl=null;if(this.isShowDetailRating){this.initializeDetailRatingControl()}this.commentTextbox=new Textbox({text:this.commentText,watermarkText:"输入你的点评文字，最少不少于5个字..",focusClassName:"c_000",blurClassName:"c_a5",onKeyupCallback:null});this.tagTextbox=new Textbox({text:this.tagText,watermarkText:"标签之间用空格分隔(标签数不能超过10个)",focusClassName:"c_000",blurClassName:"c_a5",onKeyupCallback:null})},destroyControl:function(){if(this.totalRatingControl){this.totalRatingControl.close()}if(this.userImpressRatingControl){this.userImpressRatingControl.close()}if(this.userStoryRatingControl){this.userStoryRatingControl.close()}if(this.userShowRatingControl){this.userShowRatingControl.close()}if(this.userDirectorRatingControl){this.userDirectorRatingControl.close()}if(this.userPictureRatingControl){this.userPictureRatingControl.close()}if(this.userMusicRatingControl){this.userMusicRatingControl.close()}this.commentTextbox.close();this.tagTextbox.close()},load:function(){if(this.isShowDetailRating){this.detailRatingRegion.show()}else{this.totalRatingRegion.show()}},renderUserTotalRating:function(b){this.userRatingBigLabel.innerHTML=b.big;this.userRatingSmallLabel.innerHTML=b.small;this.userRatingBig2Label.innerHTML=b.big;this.userRatingSmall2Label.innerHTML=b.small;this.userRatingDescription2Label.innerHTML=this.getUserRatingDescription(parseFloat(b.big+b.small))},initializeDetailRatingControl:function(){this.userImpressRatingControl=this.initializeParticularRatingControl(this.userImpressRatingContainer,this.userImpressRatingSpan,this.userImpressRatingLabel,this.userRating.Rtotal);this.userStoryRatingControl=this.initializeParticularRatingControl(this.userStoryRatingContainer,this.userStoryRatingSpan,this.userStoryRatingLabel,this.userRating.Rstory);this.userShowRatingControl=this.initializeParticularRatingControl(this.userShowRatingContainer,this.userShowRatingSpan,this.userShowRatingLabel,this.userRating.Rshow);this.userDirectorRatingControl=this.initializeParticularRatingControl(this.userDirectorRatingContainer,this.userDirectorRatingSpan,this.userDirectorRatingLabel,this.userRating.Rdirector);this.userPictureRatingControl=this.initializeParticularRatingControl(this.userPictureRatingContainer,this.userPictureRatingSpan,this.userPictureRatingLabel,this.userRating.Rpicture);this.userMusicRatingControl=this.initializeParticularRatingControl(this.userMusicRatingContainer,this.userMusicRatingSpan,this.userMusicRatingLabel,this.userRating.Rother)},initializeParticularRatingControl:function(f,j,g,i){var h=function(a){if(j){j.innerHTML=a>0?a:""}g.innerHTML=MovieRatingHelper.getUserParticularRatingDescription(a);this.previewUserRating()}.bind(this);if(j){j.innerHTML=i>0?i:""}g.innerHTML=MovieRatingHelper.getUserParticularRatingDescription(i);return new Rating({menuRegion:f,rating:i,readonly:false,onOverRatingCallback:h,onOutRatingCallback:h})},previewUserRating:function(){var k=this.userImpressRatingControl.getValue();var p=this.userStoryRatingControl.getValue();var o=this.userShowRatingControl.getValue();var i=this.userDirectorRatingControl.getValue();var m=this.userPictureRatingControl.getValue();var l=this.userMusicRatingControl.getValue();var j=(k>0||p>0||o>0||i>0||m>0||l>0);var n=this.totalRatingControl.getValue();if(j){n=k*0.2307+i*0.2364+p*0.1912+m*0.1182+o*0.174+l*0.0495}var n=this.getRating(n);this.renderUserTotalRating(n)},onClickRatingDetailButton:function(){this.initializeDetailRatingControl();this.detailRatingRegion.show();this.totalRatingRegion.hide()},onClickTagRegion:function(e){var d=Event.element(e);if(d&&d.readAttribute){var f=d.readAttribute("method");if(f&&f.length>0){switch(f){case"show":this.showMovieTags();break;case"select":this.selectTag(d)}}}},showMovieTags:function(){this.server.getTags(this.type,this.id,function(){var i=getTagsResult;if(i&&i.value&&i.value.List){var l=i.value.List;if(l.length>0){var k=new StringBuilder(),j=null;for(var h=0,g=l.length;h<g;++h){j=l[h];k.append(String.Format('<a class="mr5" href="#" onclick="return false;" method="select">{0}</a>',j.TagName));k.append(" ")}this.tagRegion.addClassName("w245");this.tagRegion.innerHTML=k.toString()}else{this.tagRegion.addClassName("c_brown");this.tagRegion.innerHTML="此电影未添加任何标签"}}}.bind(this))},selectTag:function(g){var e=g.innerHTML,f=this.tagTextbox.getValue();var h=f.split(" ");if(h.indexOf(e)>=0){h=h.findAll(function(a){return(a.trim()!=e.trim()&&a.trim()!="")})}else{h.push(e);h=h.findAll(function(a){return(a.trim()!="")});if(h.length>10){h.pop()}}this.tagTextbox.setValue(h.join(" "))},onHasMoviegoingLogCheckBoxClick:function(b){if(this.hasMoviegoingLogCheckbox.checked){$show(this.moviegoingLogRegion);$hide(this.moviegoingLogOverlap)}else{$show(this.moviegoingLogOverlap)}},onMoviegoingLogRegionClick:function(d){var c=Event.findElement(d,"input");if(!c||!c.readAttribute){return}if(c.name=="radioMoviegoingType"){if(c.value=="1"){$show(this.moviegoingCinemaRegion)}else{$hide(this.moviegoingCinemaRegion)}}else{if(c.id=="iptMoviegoingCinema"){if(TheaterDialog){new TheaterDialog({theaterId:0,selectedCallback:function(a){this.iptMoviegoingCinema.value=a.selectedTheater.NameCn;this.iptMoviegoingCinema.theaterid=a.selectedTheater.Id}.bind(this)})}}}},onMoviegoingDateBlur:function(h){var j=this.iptMoviegoingYear.value.trim();var i=this.iptMoviegoingMonth.value.trim();var f=this.iptMoviegoingDay.value.trim();var g=[];if(!this.validateMoviegoingDate(j,i,f,g)){this.setHint(g.join(""))}},validateMoviegoingDate:function(n,l,i,k){var m=new Date();if(n||l||i){n=parseInt(n,10);if(isNaN(n)||n<1960||n>m.getFullYear()){k.push("观影年份请输入4位数字，如：2009，且不能大于今年");return false}else{if(l||i){l=parseInt(l,10);if(isNaN(l)||l<1||l>12||(n==m.getFullYear()&&l>m.getMonth()+1)){k.push("观影月份请输入1-12之间的数字，且不能大于本月");return false}else{if(i){i=parseInt(i,10);if(isNaN(i)||i<1||i>31||(n==m.getFullYear()&&l==m.getMonth()+1&&i>m.getDate())){k.push("观影日期请输入1-31之间的数字，且不能大于今天");return false}else{try{var e=new Date(n,l-1,i);if(e.getFullYear()!=n||e.getMonth()+1!=l||e.getDate()!=i){k.push("观影时间不存在");return false}}catch(j){k.push("观影时间不存在");return false}}}}}}}return true},getMoviegoingLog:function(){var h={hasMoviegoingLog:false,moviegoingType:1,moviegoingDate:0,cinemaId:0,errorMessages:[]};h.hasMoviegoingLog=this.hasMoviegoingLogCheckbox.checked;if(h.hasMoviegoingLog){h.moviegoingType=parseInt(this.moviegoingLogRegion.getElementsBySelector("input[type='radio'][name='radioMoviegoingType']").find(function(a){return a.checked}).value,10);switch(h.moviegoingType){case 1:var i=this.iptMoviegoingCinema.theaterid;if(i){h.cinemaId=parseInt(i,10)}default:var j=this.iptMoviegoingYear.value.trim();var g=this.iptMoviegoingMonth.value.trim();var f=this.iptMoviegoingDay.value.trim();if(!this.validateMoviegoingDate(j,g,f,h.errorMessages)){return h}h.moviegoingDate=(j?parseInt(j,10):0)*10000+(g?parseInt(g,10):0)*100+(f?parseInt(f,10):0);break}}return h},onClickIsAddToFavoriteCheckbox:function(){if(this.isAddToFavoriteCheckbox.checked){this.favoriteRegion.show();this.favoriteOverlap.hide();this.favoriteCategory.disabled=false;this.showFavoriteCategory()}else{this.favoriteOverlap.show();this.favoriteCategory.disabled=true}},showFavoriteCategory:function(){this.getStatusWhenCategory=true;if(!this.favoriteCategorys){this.server.getFavoriteCategorys(this.type,this.id,this.getStatusWhenCategory,function(){var b=getFavoriteCategorysResult;if(b&&b.value){this.favoriteCategorys=b.value.categorys.List;if(this.getStatusWhenCategory){this.hasFavorite=b.value.hasFavorited}this.renderFavoriteCategory()}}.bind(this))}},renderFavoriteCategory:function(){var i=this.favoriteCategorys;var o=this.favoriteCategory.options,n=0,p=false;o.length=0;var k=document.createElement("option");k.text="不放入任何分类";k.value=0;o[n]=k;if(!Globals.isNullOrEmpty(i)){var j=null;for(var m=0,l=i.length;m<l;m++){j=i[m];var k=document.createElement("option");k.text=j.Name;k.value=j.Id;o[++n]=k}}},onClickAddFavoriteCategoryButton:function(){if(this.createCategoryWindow.style.visibility!=="visible"){this.createCategoryWindow.style.visibility="visible"}else{this.createCategoryWindow.style.visibility="hidden"}},onClickConfirmCreateCategoryButton:function(){var b=this.categoryText.value.trim();if(b.length>0){if(b.bytelength()>50){this.setHint("分类名不要超过25个汉字！");return false}this.server.createCategory(b,function(){var n=createFavoriteCategoryResult;if(n&&n.value&&n.value.id>0){var k=n.value;var a=k.id;var i=k.name;this.favoriteCategorys.push({Id:a,Name:i});var m=this.favoriteCategory.options,l=0;var j=document.createElement("option");j.text=i;j.value=a;m[m.length]=j;m[m.length-1].selected=true;this.createCategoryWindow.style.visibility="hidden";if(this.onAddFavoriteCategorySuccessCallback){this.onAddFavoriteCategorySuccessCallback(k)}}else{this.setHint("添加分类失败，请稍候重试")}}.bind(this))}},onClickCancelCreateCategoryButton:function(){this.createCategoryWindow.style.visibility="hidden";this.categoryText.value=""},onConfirmRating:function(y,M){var A=[];this.hasBeenTotalRating=false;var P=0;if(!this.isDetailRating()){P=this.totalRatingControl.getValue();if(P>0){this.hasBeenTotalRating=true}}this.hasBeenDetailRating=false;var G=0;var L=0;var K=0;var z=0;var J=0;var I=0;if(this.isDetailRating()){G=this.userImpressRatingControl.getValue();L=this.userStoryRatingControl.getValue();K=this.userShowRatingControl.getValue();z=this.userDirectorRatingControl.getValue();J=this.userPictureRatingControl.getValue();I=this.userMusicRatingControl.getValue();if(P>0||L>0||K>0||z>0||J>0||I>0){this.hasBeenDetailRating=true}}this.hasBeenComment=false;var w=this.commentTextbox.getValue();var x=w.bytelength();if(x>0){if(x<this.MIN_COMMENT_COUNT*2){A.push(String.Format(this.MIN_COMMENT_DESCRIPTION,this.MIN_COMMENT_COUNT))}else{if(x>this.MAX_COMMENT_COUNT*2){A.push(String.Format(this.MAX_COMMENT_DESCRIPTION,this.MAX_COMMENT_COUNT))}else{this.hasBeenComment=true}}}this.hasMoviegoingLog=false;var H=this.getMoviegoingLog();if(H.errorMessages.length>0){A=A.concat(H.errorMessages)}else{this.hasMoviegoingLog=H.hasMoviegoingLog}this.hasBeenTag=false;var N=this.tagTextbox.getValue(),O=[];if(N.length>0){O=Validator.filterTagToArray(N);if(O.length===0){A.push("你输入标签不合法，请重新输入")}else{if(O.length>10){A.push("标签个数不能大于10个")}else{this.hasBeenTag=true}}}this.hasBeenFavorite=false;var v=0,E=false,D=false,F=false,B="";if(this.isAddToFavoriteCheckbox.checked){var v=this.favoriteCategory.value;var E=this.hasDvdCheckbox.checked;var D=this.hasCdCheckbox.checked;var F=this.hasPosterCheckbox.checked;var B=this.favoriteReasonText.value;var C=B.bytelength();if(C>this.MAX_FAVORITEREASON_COUNT*2){A.push(String.Format(this.MAX_FAVORITEREASON_DESCRIPTION,this.MAX_FAVORITEREASON_COUNT))}else{this.hasBeenFavorite=true}}if(A.length>0){this.setHint(A.join("<br/>"))}else{if(this.hasBeenTotalRating||this.hasBeenDetailRating||this.hasBeenComment||this.hasBeenTag||this.hasMoviegoingLog||this.hasBeenFavorite){this.server.rating(this.type,this.id,this.title,this.hasBeenTotalRating,P,this.hasBeenDetailRating,G,L,K,z,J,I,this.hasBeenComment,w,this.hasBeenTag,O.join(" "),this.hasBeenFavorite,v,E,D,F,B,this.hasMoviegoingLog,H.moviegoingType,H.moviegoingDate,H.cinemaId,M,this.onConfirmRatingCallback.bind(this))}else{this.dialog.close()}}},onConfirmRatingCallback:function(g){if(g&&g.value){var h=g.value;var e=true,f=[];if(this.hasBeenTotalRating&&!h.hasBeenTotalRating){e=false;f.push("评分失败")}if(this.hasBeenDetailRating&&!h.hasBeenDetailRating){e=false;f.push("评分失败")}if(this.hasBeenComment){if(!h.hasBeenComment){e=false;f.push("点评失败")}else{this.commentTextbox.clear()}}if(this.hasMoviegoingLog&&!h.hasMoviegoingLog){e=false;f.push("添加观影记录失败")}if(this.hasBeenTag){if(!h.hasBeenTag){e=false;f.push("添加标签失败")}else{this.tagTextbox.clear()}}if(this.hasBeenFavorite&&!h.hasBeenFavorite){e=false;f.push("收藏失败")}if(f.length===0&&e){if(this.okCallback){this.okCallback(h)}this.dialog.close()}else{this.setHint(f.join("<br/>"))}}else{this.setHint("未知错误，请稍候重试")}},setHint:function(b){this.hint.innerHTML=b;this.hint.show()},isDetailRating:function(){return this.detailRatingRegion.visible()},getRating:function(e){var d=Math.floor(e+0.01);var f=Math.floor(Math.abs(e-d)*10+0.01);return{big:d>0?d:(f>0?0:""),small:f>0?("."+f):""}},getUserRatingDescription:function(b){if(b>0){if(b<=4){return"很差，完全是在浪费生命"}if(b<=7){return"一般，不妨一看"}if(b<=9){return"很好，获得大多数人喜爱的佳作"}return"很完美，绝对不容错过"}return""},getUserParticularRatingDescription:function(b){if(b>0){if(b<=4){return"很差"}if(b<=7){return"一般"}if(b<=9){return"很好"}return"很完美"}return""}};var MovieRatingHelper={getRating:function(e){var d=Math.floor(e+0.01);var f=Math.floor(Math.abs(e-d)*10+0.01);return{big:d>0?d:0,small:"."+f}},getRatingString:function(c){var d=MovieRatingHelper.getRating(c);return d.big+d.small},calcTotalRating:function(h,g,l,j,k,i){if(h==10&&g==10&&l==10&&j==10&&k==10&&i==10){return 10}return h*0.2307+g*0.2364+l*0.1912+j*0.1182+k*0.174+i*0.0495},getUserRatingDescription:function(b){if(b>0){if(b<3){return"很差，完全是浪费时间"}if(b<6){return"平庸之作，不看也罢"}if(b<=7.5){return"一般，不妨一看"}if(b<9){return"很好，公认的佳作"}return"很完美，绝对不容错过"}return""},getUserParticularRatingDescription:function(b){if(b>0){if(b<=4){return"很差"}if(b<=7){return"一般"}if(b<=9){return"很好"}return"很完美"}return""},setMovieCommentRegion:function(h,f,g,e){h.innerHTML="";h.appendChild(Builder.build('<span class="ele_inline_block myquot mr3">&nbsp;</span>'));h.appendChild(Builder.node("a",{href:g,target:"_blank"},[f.truncate(e,"...").toString()]));h.appendChild(Builder.build('<span class="ele_inline_block myquot_r ml3">&nbsp;</span>'))}};var DatabaseRating=Class.create();DatabaseRating.prototype={MIN_RATING_COUNT:10,MIN_COMMENT_COUNT:5,MIN_COMMENT_DESCRIPTION:"你的点评字数不应该小于{0}字",MAX_COMMENT_COUNT:500,MAX_COMMENT_DESCRIPTION:"你的点评字数不应该大于{0}字",server:{wantToSee:function(h,f,g,e){return this.rating(h,f,g,-1,e)},notInterest:function(h,f,g,e){return this.rating(h,f,g,-2,e)},rating:function(j,g,i,h,f){return this.ratingComment(j,g,i,"",h,0,0,0,0,0,0,f)},particularRatingComment:function(v,o,t,m,u,s,r,n,q,p,l){return this.ratingComment(v,o,t,m,0,u,s,r,n,q,p,l)},ratingComment:function(x,p,v,n,s,w,u,t,o,r,q,m){return Mtime.Component.Ajax.callBack("Mtime.Community.Controls.CommunityPages.DatabaseService","RatingMovie",[x,p,v,n,s,w,u,t,o,r,q],m,"/database/databaseService.m?Ajax_CallBack=true","post","20000")},remove:function(e,f,d){return Mtime.Component.Ajax.request(siteMcUrl,"Mtime.MemberCenter.Pages.MovieService","RemoveAttentionMovie",[e,f],d,"/service/movie.mc","get","20000")}},options:{isLogin:false,signInUrl:"",id:0,title:"",type:1,isReleased:true,rating:0,ratingCount:0,wantToSeeCount:0,favoritedCount:0,userRating:null,totalRatingRegion:"",totalRatingContainer:"",totalRatingBigLabel:"",totalRatingSmallLabel:"",totalRatingDescriptionRegion:"",ratingLinkRegion:"",wantToSeeLinkRegion:"",userRatingContainer:"",userRatingDescriptionLabel:"",userRatingBigLabel:"",userRatingSmallLabel:"",wantToSeeButton:"",notInterestButton:"",particularRatingButton:"",ratingRegion:"ratingRegion",ratingLoadingRegion:"ratingLoadingRegion"},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeUserRatingData();this.initializeDOM();this.load();this.initializeControl();this.initializeEvent();this.render()},initializeDOM:function(){this.totalRatingRegion=$(this.totalRatingRegion);this.totalRatingContainer=$(this.totalRatingContainer);this.totalRatingBigLabel=$(this.totalRatingBigLabel);this.totalRatingSmallLabel=$(this.totalRatingSmallLabel);this.totalRatingDescriptionRegion=$(this.totalRatingDescriptionRegion);this.totalRatingDescriptionLabel=$("totalRatingDescriptionLabel");this.ratingLinkRegion=$(this.ratingLinkRegion);this.wantToSeeLinkRegion=$(this.wantToSeeLinkRegion);this.userRatingContainer=$(this.userRatingContainer);this.userRatingDescriptionLabel=$(this.userRatingDescriptionLabel);this.userRatingBigLabel=$(this.userRatingBigLabel);this.userRatingSmallLabel=$(this.userRatingSmallLabel);this.wantToSeeButton=$(this.wantToSeeButton);this.notInterestButton=$(this.notInterestButton);this.particularRatingButton=$(this.particularRatingButton);this.ratingRegion=$(this.ratingRegion);this.ratingLoadingRegion=$(this.ratingLoadingRegion);this.showRatingChartButton=$("showRatingChartButton");this.hideRatingChartButton=$("hideRatingChartButton");this.ratingChartRegion=$("ratingChartRegion")},destroyDOM:function(){this.totalRatingRegion=null;this.totalRatingContainer=null;this.totalRatingBigLabel=null;this.totalRatingSmallLabel=null;this.totalRatingDescriptionRegion=null;this.totalRatingDescriptionLabel=null;this.ratingLinkRegion=null;this.wantToSeeLinkRegion=null;this.userRatingContainer=null;this.userRatingDescriptionLabel=null;this.userRatingBigLabel=null;this.userRatingSmallLabel=null;this.wantToSeeButton=null;this.notInterestButton=null;this.particularRatingButton=null;this.ratingRegion=null;this.ratingLoadingRegion=null;this.showRatingChartButton=null;this.hideRatingChartButton=null;this.ratingChartRegion=null},load:function(){if(this.ratingRegion&&this.ratingLoadingRegion&&!$visible(this.ratingRegion)){$show(this.ratingRegion);$hide(this.ratingLoadingRegion)}},initializeUserRatingData:function(){if(!this.userRating){this.userRating={Rating:0,JustTotal:0,Attitude:0,Rtotal:0,Rstory:0,Rshow:0,Rdirector:0,Rpicture:0,Rother:0}}},initializeEvent:function(){if(this.wantToSeeButton){this.onClickWantToSeeButtonHandler=this.onClickWantToSeeButton.bind(this);this.wantToSeeButton.observe("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.onClickNotInterestButtonHandler=this.onClickNotInterestButton.bind(this);this.notInterestButton.observe("click",this.onClickNotInterestButtonHandler)}if(this.particularRatingButton){this.onClickParticularRatingButtonHandler=this.onClickParticularRatingButton.bind(this);this.particularRatingButton.observe("click",this.onClickParticularRatingButtonHandler)}if(this.showRatingChartButton){this.onClickShowRatingChartButtonHandler=this.onClickShowRatingChartButton.bind(this);this.showRatingChartButton.observe("click",this.onClickShowRatingChartButtonHandler)}if(this.hideRatingChartButton){this.onClickHideRatingChartButtonHandler=this.onClickHideRatingChartButton.bind(this);this.hideRatingChartButton.observe("click",this.onClickHideRatingChartButtonHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.wantToSeeButton){this.wantToSeeButton.stopObserving("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.notInterestButton.stopObserving("click",this.onClickNotInterestButtonHandler)}if(this.particularRatingButton){this.particularRatingButton.stopObserving("click",this.onClickParticularRatingButtonHandler)}if(this.showRatingChartButton){this.showRatingChartButton.stopObserving("click",this.onClickShowRatingChartButtonHandler)}if(this.hideRatingChartButton){this.hideRatingChartButton.stopObserving("click",this.onClickHideRatingChartButtonHandler)}},initializeControl:function(){if(this.totalRatingContainer){this.totalRatingControl=new Rating({menuRegion:this.totalRatingContainer,rating:this.rating,readonly:true})}if(this.userRatingContainer){this.userRatingControl=new Rating({menuRegion:this.userRatingContainer,rating:this.userRating.Rating,readonly:false,onRatingCallback:this.onRatingUserRatingCallback.bind(this),onOverRatingCallback:this.onOverUserRatingCallback.bind(this),onOutRatingCallback:this.onOverUserRatingCallback.bind(this)})}},destroyControl:function(){if(this.totalRatingControl){this.totalRatingControl.close()}if(this.userRatingControl){this.userRatingControl.close()}},render:function(){if(this.totalRatingContainer){if(this.ratingCount>=this.MIN_RATING_COUNT&&this.rating>0){this.totalRatingDescriptionRegion.hide();this.totalRatingRegion.show();if(this.totalRatingDescriptionLabel){this.totalRatingDescriptionLabel.innerHTML=this.getUserRatingDescription(this.rating)}var c=this.getRating(this.rating);this.totalRatingBigLabel.innerHTML=c.big;this.totalRatingSmallLabel.innerHTML=c.small;if(this.showRatingChartButton){this.showRatingChartButton.show()}}else{this.totalRatingRegion.hide();this.totalRatingDescriptionRegion.show();if(this.type===1){if(this.ratingCount===0){this.totalRatingDescriptionRegion.innerHTML="目前还无人评分"}else{this.totalRatingDescriptionRegion.innerHTML="有效评分人数不足，不显示评分"}}else{if(this.ratingCount===0){this.totalRatingDescriptionRegion.innerHTML="目前还无人评分"}else{this.totalRatingDescriptionRegion.innerHTML=String.Format("(不到{0}人不显示总评分)",this.MIN_RATING_COUNT)}}if(this.showRatingChartButton){this.showRatingChartButton.hide()}}if(!this.isReleased){var d=this.totalRatingDescriptionLabel.parentNode;d.innerHTML="本片尚未上映，会员期待分：";d.appendChild(this.totalRatingDescriptionLabel);d=null;this.totalRatingDescriptionLabel.hide();this.showRatingChartButton.hide()}this.renderRatingLink();this.renderWantToSeeLink()}if(this.userRatingControl){this.renderUserRatingRegion()}},renderRatingLink:function(){if(this.ratingLinkRegion){if(this.ratingCount>0&&this.isReleased){if(this.type===1){this.ratingLinkRegion.down("span").innerHTML=this.ratingCount}else{this.ratingLinkRegion.down("a").innerHTML=this.ratingCount}if(!$visible(this.ratingLinkRegion)){$show(this.ratingLinkRegion)}}else{if($visible(this.ratingLinkRegion)){$hide(this.ratingLinkRegion)}}}},renderWantToSeeLink:function(){if(this.wantToSeeLinkRegion){if(this.wantToSeeCount>0){if(this.isReleased){this.wantToSeeLinkRegion.down("a").innerHTML=this.wantToSeeCount}else{this.wantToSeeLinkRegion.innerHTML='<strong class="c_green px16">'+this.wantToSeeCount+"</strong>人想看"}if(!$visible(this.wantToSeeLinkRegion)){$show(this.wantToSeeLinkRegion)}}else{if($visible(this.wantToSeeLinkRegion)){$hide(this.wantToSeeLinkRegion)}}}},renderUserRatingRegion:function(){if(this.userRating){if(this.userRating.Rating>0){this.userRatingControl.setValue(this.userRating.Rating);this.renderUserRating(this.userRating.Rating)}else{this.userRatingControl.setValue(0);this.renderUserRating(0);if(this.userRating.Attitude===1){this.setWantToSeeButton(false);this.setNotInterestButton(true)}else{if(this.userRating.Attitude===2){this.setWantToSeeButton(true);this.setNotInterestButton(false)}}}}},renderUserRating:function(c){this.userRatingDescriptionLabel.innerHTML=this.getUserRatingDescription(c);var d=this.getRating(c);this.userRatingBigLabel.innerHTML=d.big;this.userRatingSmallLabel.innerHTML=d.small},onOverUserRatingCallback:function(b){this.renderUserRating(b)},onRatingUserRatingCallback:function(b){if(this.valid()){if(b>0){this.showRatingDialog(false,b)}}},onClickWantToSeeButton:function(){if(this.isEnableWantToSeeButton()){if(this.valid()){this.clearParticularRating();this.cancelUserRating();this.setWantToSeeButton(false);this.setNotInterestButton(true);this.server.wantToSee(this.type,this.id,this.title,this.onServerRatingCallback.bind(this))}}},onClickNotInterestButton:function(){if(this.isEnableNotInterestButton()){if(this.valid()){this.clearParticularRating();this.cancelUserRating();this.setWantToSeeButton(true);this.setNotInterestButton(false);this.server.notInterest(this.type,this.id,this.title,this.onServerRatingCallback.bind(this))}}},onServerRatingCallback:function(d){if(d&&d.value&&d.value.success){var c=d.value;this.rating=c.rating;this.ratingCount=c.ratingCount;this.wantToSeeCount=c.wantToSeeCount;this.userRating=c.userRating;this.initializeUserRatingData();this.render();this.server.remove(this.id,true,function(){})}else{$alert("评分失败，请稍候重试")}},onClientRatingCallback:function(d){if(d&&d.value&&d.value.success){var c=d.value;this.rating=c.rating;this.ratingCount=c.ratingCount;this.wantToSeeCount=c.wantToSeeCount;this.userRating=c.userRating;this.initializeUserRatingData();this.render()}},cancelUserRating:function(){this.renderUserRating(0);this.userRatingControl.setValue(0)},setWantToSeeButton:function(b){if(b){this.wantToSeeButton.className="btn_gray2 mr3"}else{this.wantToSeeButton.className="btn_green2 mr3 cur_d"}},isEnableWantToSeeButton:function(){return !this.wantToSeeButton.hasClassName("cur_d")},setNotInterestButton:function(b){if(b){this.notInterestButton.className="btn_gray3 mr3"}else{this.notInterestButton.className="btn_green3 mr3 cur_d"}},isEnableNotInterestButton:function(){return !this.notInterestButton.hasClassName("cur_d")},onClickShowRatingChartButton:function(){this.ratingChartRegion.show()},onClickHideRatingChartButton:function(){this.ratingChartRegion.hide()},clearParticularRating:function(){this.userRating.Rtotal=0;this.userRating.Rstory=0;this.userRating.Rshow=0;this.userRating.Rdirector=0;this.userRating.Rpicture=0;this.userRating.Rother=0},onClickParticularRatingButton:function(){this.showRatingDialog(true,this.userRating.Rating)},showRatingDialog:function(c,d){if(this.valid()){c=c||false;d=d||0;new RatingDialog({type:this.type,id:this.id,isShowDetailRating:c,rating:d,userRating:c?this.userRating:{Rating:0,JustTotal:0,Attitude:0,Rtotal:0,Rstory:0,Rshow:0,Rdirector:0,Rpicture:0,Rother:0},title:this.title,cancelCallback:this.ratingDialogCancelCallback.bind(this),okCallback:this.ratingDialogOkCallback.bind(this),closeCallback:this.ratingDialogCloseCallback.bind(this),onAddFavoriteCategorySuccessCallback:this.onAddFavoriteCategorySuccessCallback.bind(this)})}},ratingDialogCancelCallback:function(){this.render()},ratingDialogOkCallback:function(b){if(b.hasBeenTotalRating||b.hasBeenDetailRating){this.setWantToSeeButton(true);this.setNotInterestButton(true);this.rating=b.rating;this.ratingCount=b.ratingCount;this.wantToSeeCount=b.wantToSeeCount;this.userRating=b.userRating;this.initializeUserRatingData();this.render();this.server.remove(this.id,true,function(){})}if(b.hasBeenFavorite){if(this.onAddFavoriteSuccessCallback){this.onAddFavoriteSuccessCallback(b)}}},ratingDialogCloseCallback:function(){this.render()},getRating:function(b){return MovieRatingHelper.getRating(b)},getUserRatingDescription:function(b){return MovieRatingHelper.getUserRatingDescription(b)},getUserParticularRatingDescription:function(b){return MovieRatingHelper.getUserParticularRatingDescription(b)},valid:function(){if(!this.isLogin){$redirect(this.signInUrl);return false}return true},closed:false,close:function(){if(!this.closed){if(this.dialog){this.dialog.close()}this.closed=true;this.destroyControl();this.destroyEvent();this.destroyDOM()}}};var ViewMoviegoingLogDialog=Class.create();Object.extend(ViewMoviegoingLogDialog.prototype,{server:{getAllMoviegoingLogs:function(d,c){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","GetAllMoviegoingLogs",[d],c,"/database/databaseService.m?Ajax_CallBack=true","get","20000")},delMoviegoingLog:function(e,d,f){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","DelMoviegoingLog",[e],d,"/database/databaseService.m?Ajax_CallBack=true","get","20000",f)}},options:{movieId:0,closeCallback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.server.getAllMoviegoingLogs(this.movieId,function(){var a=getAllMoviegoingLogsResult;if(a&&a.value){this.moviegoingLogListHTML=a.value.moviegoingLogListHTML;this.showDialog()}else{$alert("获取观影记录失败，请稍候重试")}}.bind(this))},showDialog:function(){this.content=$(Builder.node("div",{className:"pl15 pr15 pb15"}));this.content.innerHTML=this.moviegoingLogListHTML;this.dialog=new Dialog({title:"已添加的观影方式：",windowClassName:"w380",content:this.content,readyCallback:this.onDialogReady.bind(this),closeCallback:this.onDialogClose.bind(this)})},onDialogReady:function(b){this.initializeField();this.initializeDOM(b);this.initializeEvent();this.initializeControl();this.load()},onDialogClose:function(b){if(this.closeCallback){this.closeCallback(this.getRemainLogTypes())}this.destroyControl();this.destroyEvent();this.destroyDOM()},initializeField:function(){},initializeDOM:function(b){},destroyDOM:function(){this.content=null},initializeEvent:function(){this.onMoviegoingLogListRegionClickHandler=this.onMoviegoingLogListRegionClick.bindAsEventListener(this);this.content.observe("click",this.onMoviegoingLogListRegionClickHandler)},destroyEvent:function(){this.content.stopObserving("click",this.onMoviegoingLogListRegionClickHandler)},initializeControl:function(){},destroyControl:function(){},getRemainLogTypes:function(){var b=[];this.content.getElementsBySelector("span[method='deleteMoviegoingLog']").each(function(a){var d=parseInt(a.readAttribute("mgtype"),10);b.push(d)});return b.uniq()},delMoviegoingLogCallback:function(e){var h=deleteMoviegoingLogResult;if(h.error||!h.value){$alert("操作失败，请刷新页面重试")}else{if(e){var g=e.parentNode;var f=g.parentNode;if(f){f.removeChild(g);if(f.getElementsBySelector("p").length==0){f.innerHTML='<p class="c_a5">暂无</p>'}}}}},onMoviegoingLogListRegionClick:function(f){var e=Event.findElement(f,"span");if(!e||!e.readAttribute){return}var g=e.readAttribute("method");var h=e.readAttribute("mlid");if(g=="deleteMoviegoingLog"){$confirm("确定要删除此观影记录吗？",function(){this.server.delMoviegoingLog(h,this.delMoviegoingLogCallback.bind(this,e),e)}.bind(this))}},load:function(){}});var AddMoviegoingLogDialog=Class.create();Object.extend(AddMoviegoingLogDialog.prototype,{server:{addMoviegoingLog:function(k,j,i,g,h,l){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","AddMoviegoingLog",[k,j,i,g],h,"/database/databaseService.m?Ajax_CallBack=true","get","20000",l)}},options:{movieId:0,okCallback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){$loadJs(["/js/08/theaterSearchBox.js","/js/08/calendarWindow.js"],function(){this.setOptions(b);this.showDialog()}.bind(this))},showDialog:function(){var c=new Date();var d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate();this.iptMoviegoingDate=$(Builder.node("input",{method:"selectDate",type:"text",className:"type_b w110 c_000",value:d}));this.selectDateRegion=$(Builder.node("p",{className:"mt12"},["观影日期：",this.iptMoviegoingDate]));this.iptMoviegoingCinema=$(Builder.node("input",{name:"iptMoviegoingCinema",type:"text",value:"点击选择影院",className:"i_input w255"}));this.moviegoingCinemaRegion=$(Builder.node("p",{className:"mt12"},["观影地点：",this.iptMoviegoingCinema]));this.content=Builder.node("div",{className:"pl15 pr15"},[this.selectDateRegion,Builder.node("p",{className:"mt12"},[Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType1",type:"radio",className:"mr3",checked:"checked",value:"1"}),Builder.node("label",{htmlFor:"radioMoviegoingType1",className:"mr9"},["电影院"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType2",type:"radio",className:"mr3",value:"2"}),Builder.node("label",{htmlFor:"radioMoviegoingType2",className:"mr9"},["DVD"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType3",type:"radio",className:"mr3",value:"3"}),Builder.node("label",{htmlFor:"radioMoviegoingType3",className:"mr9"},["下载"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType4",type:"radio",className:"mr3",value:"4"}),Builder.node("label",{htmlFor:"radioMoviegoingType4",className:"mr9"},["在线观看"]),Builder.node("input",{name:"radioMoviegoingType",id:"radioMoviegoingType5",type:"radio",className:"mr3",value:"5"}),Builder.node("label",{htmlFor:"radioMoviegoingType5",className:"mr9"},["电视台"])]),this.moviegoingCinemaRegion,Builder.node("div",{className:"line_dot mt12 mb12"})]);this.content=$(this.content);this.dialog=new Dialog({title:"观影方式：",windowClassName:"w380",content:this.content,buttonRegionClass:"mt15 mb15 tc",buttons:[{title:"确定",buttonStyle:"btn_square_hover mr15",callback:this.onConfirmAdd.bind(this)},{title:"取消",onmouseover:"this.className='btn_square_hover'",onmouseout:"this.className='btn_square'",buttonStyle:"btn_square",callback:function(a){if(this.cancelCallback){this.cancelCallback(a)}a.close()}.bind(this)}],readyCallback:this.onDialogReady.bind(this),closeCallback:this.onDialogClose.bind(this),onClickCloseCallback:this.closeCallback||Prototype.emptyFunction})},onDialogReady:function(b){this.initializeField();this.initializeDOM(b);this.initializeEvent();this.initializeControl();this.load()},onDialogClose:function(b){this.destroyControl();this.destroyEvent();this.destroyDOM()},initializeField:function(){this.selectedDate=new Date()},initializeDOM:function(b){},destroyDOM:function(){this.iptMoviegoingDate=null;this.selectDateRegion=null;this.iptMoviegoingCinema=null;this.moviegoingCinemaRegion=null;this.content=null},initializeEvent:function(){this.onMoviegoingLogRegionClickHandler=this.onMoviegoingLogRegionClick.bindAsEventListener(this);this.content.observe("click",this.onMoviegoingLogRegionClickHandler)},destroyEvent:function(){this.content.stopObserving("click",this.onMoviegoingLogRegionClickHandler)},initializeControl:function(){this.calendar=new Window.CalendarWindow({zIndex:211,element:this.iptMoviegoingDate,callback:this.onMoviegoingDateSelected.bind(this),date:this.selectedDate,isInOverflowContainer:false})},destroyControl:function(){this.calendar=null},onMoviegoingLogRegionClick:function(d){var c=Event.findElement(d,"input");if(!c||!c.readAttribute){return}if(c.name=="radioMoviegoingType"){if(c.value=="1"){$show(this.moviegoingCinemaRegion)}else{$hide(this.moviegoingCinemaRegion)}}else{if(c.name=="iptMoviegoingCinema"){if(TheaterDialog){new TheaterDialog({theaterId:0,selectedCallback:function(a){this.iptMoviegoingCinema.value=a.selectedTheater.NameCn;this.iptMoviegoingCinema.theaterid=a.selectedTheater.Id}.bind(this)})}}}},onMoviegoingDateSelected:function(b){this.iptMoviegoingDate.value=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()},validateMoviegoingDate:function(n,l,i,k){var m=new Date();if(n||l||i){n=parseInt(n,10);if(isNaN(n)||n<1960||n>m.getFullYear()){k.push("观影日期不能小于1960年或大于今年");return false}else{if(l||i){l=parseInt(l,10);if(isNaN(l)||l<1||l>12||(n==m.getFullYear()&&l>m.getMonth()+1)){k.push("观影月份请输入1-12之间的数字<br/ >且不能大于本月");return false}else{if(i){i=parseInt(i,10);if(isNaN(i)||i<1||i>31||(n==m.getFullYear()&&l==m.getMonth()+1&&i>m.getDate())){k.push("观影日期请输入1-31之间的数字<br />且不能大于今天");return false}else{try{var e=new Date(n,l-1,i);if(e.getFullYear()!=n||e.getMonth()+1!=l||e.getDate()!=i){k.push("观影时间不存在");return false}}catch(j){k.push("观影时间不存在");return false}}}}}}}return true},getMoviegoingLog:function(){var j={moviegoingType:1,moviegoingDate:0,cinemaId:0,errorMessages:[]};j.moviegoingType=parseInt(this.content.getElementsBySelector("input[type='radio'][name='radioMoviegoingType']").find(function(a){return a.checked}).value,10);switch(j.moviegoingType){case 1:var k=this.iptMoviegoingCinema.theaterid;if(k){j.cinemaId=parseInt(k,10)}default:var g=this.iptMoviegoingDate.value.split("-");if(g.length!=3){j.errorMessages.push("观影日期格式错误");return j}var l,i,h;l=g[0];if(g.length==3){i=g[1];h=g[2]}if(!this.validateMoviegoingDate(l,i,h,j.errorMessages)){return j}j.moviegoingDate=(l?parseInt(l,10):0)*10000+(i?parseInt(i,10):0)*100+(h?parseInt(h,10):0);break}return j},addMoviegoingLogCallback:function(){var b=addMoviegoingLogResult;if(b&&b.value&&b.value.moviegoingLogId>0){if(this.okCallback){this.okCallback(b)}this.dialog.close()}else{$alert("添加观影记录失败，请稍候重试")}},onConfirmAdd:function(){var b=this.getMoviegoingLog();if(b.errorMessages.length>0){$alert(b.errorMessages.join("<br/>"));return}this.server.addMoviegoingLog(this.movieId,b.moviegoingType,b.moviegoingDate,b.cinemaId,this.addMoviegoingLogCallback.bind(this),this.dialog.buttonRegion)},load:function(){}});var MovieParticularRatingDialog=Class.create();Object.extend(MovieParticularRatingDialog.prototype,{MIN_COMMENT_COUNT:5,MIN_COMMENT_DESCRIPTION:"你的点评字数不应该小于{0}字",MAX_COMMENT_COUNT:210,MAX_COMMENT_DESCRIPTION:"你的点评字数不应该大于{0}字",MAX_COMMENT_SHOW_LEGTH:16,relatedObjType:1,server:{ratingComment:function(z,q,x,o,t,y,v,u,p,s,r,n,w){return Mtime.Component.Ajax.getCrossDomain("Mtime.Community.Controls.CommunityPages.DatabaseService","RatingMovie",[z,q,x,o,t,y,v,u,p,s,r],n,"/database/databaseService.m?Ajax_CallBack=true","post","20000",w)}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.showDialog()},buildParticularRatingObj:function(d){var c={dom:null,ratingControlContainer:null,ratingValueRegion:null,ratingDescriptRegion:null};c.ratingControlContainer=$(Builder.node("ul",{className:"clearfix grating fl"}));c.ratingValueRegion=$(Builder.node("span",{className:"fl bold c_green ml9"}));c.ratingDescriptRegion=$(Builder.node("b",{className:"ml9 fl c_666"}));c.dom=$(Builder.node("div",{className:"clearfix mt9 mb9"},[Builder.node("h5",{className:"normal fl"},[d+"："]),c.ratingControlContainer,c.ratingValueRegion,c.ratingDescriptRegion]));return c},showDialog:function(){this.userRatingResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.userRatingResultRegion=$(Builder.node("span",{className:"fl"},["评分：",this.userRatingResultLabel]));this.userImpressRatingObj=this.buildParticularRatingObj("印象");this.userStoryRatingObj=this.buildParticularRatingObj("故事");this.userShowRatingObj=this.buildParticularRatingObj("表演");this.userDirectorRatingObj=this.buildParticularRatingObj("导演");this.userPictureRatingObj=this.buildParticularRatingObj("画面");this.userMusicRatingObj=this.buildParticularRatingObj("音乐");this.detailRatingRegion=Builder.node("div",{className:"mt12"},[this.userImpressRatingObj.dom,this.userStoryRatingObj.dom,this.userShowRatingObj.dom,this.userDirectorRatingObj.dom,this.userPictureRatingObj.dom,this.userMusicRatingObj.dom]);this.txtMovieComment=$(Builder.node("textarea",{className:"type_b w265 unfocus"}));this.addedMovieCommentRegion=$(Builder.node("div",{className:"add_added"}));this.addMovieCommentRegion=$(Builder.node("div",{className:"mt12"},[this.txtMovieComment,this.addedMovieCommentRegion]));this.feedbackRegion=$(Builder.node("div",{className:"c_red"}));this.feedbackRegion.innerHTML="&nbsp;";this.dialog=new Dialog({title:"分项评分：",windowClassName:"w345",content:Builder.node("div",[Builder.node("div",{className:"clearfix pos_re"},[this.userRatingResultRegion]),Builder.node("div",{className:"mt12"},[this.detailRatingRegion,this.addMovieCommentRegion]),Builder.node("div",{className:"line_dot mt12 mb12"}),this.feedbackRegion]),buttonRegionClass:"mt15 mb15 tc",buttons:[{title:"确定",buttonStyle:"btn_square_hover mr15",callback:this.onConfirmRating.bind(this)},{title:"取消",onmouseover:"this.className='btn_square_hover'",onmouseout:"this.className='btn_square'",buttonStyle:"btn_square",callback:function(b){if(this.cancelCallback){this.cancelCallback(b)}b.close()}.bind(this)}],readyCallback:this.onDialogReady.bind(this),closeCallback:this.onDialogClose.bind(this),onClickCloseCallback:this.closeCallback||Prototype.emptyFunction})},onDialogReady:function(b){this.initializeField();this.initializeDOM(b);this.initializeEvent();this.initializeControl();this.load()},onDialogClose:function(b){this.destroyControl();this.destroyEvent();this.destroyDOM()},initializeField:function(){this._rating=this.rating;this._userRating=this.userRating},initializeDOM:function(b){},destroyDOM:function(){this.hint=null;this.userRatingResultLabel=null;this.userRatingResultRegion=null;this.userImpressRatingObj=null;this.userStoryRatingObj=null;this.userShowRatingObj=null;this.userDirectorRatingObj=null;this.userPictureRatingObj=null;this.userMusicRatingObj=null;this.detailRatingRegion=null;this.txtMovieComment=null;this.addedMovieCommentRegion=null;this.addMovieCommentRegion=null},initializeEvent:function(){},destroyEvent:function(){},initializeControl:function(){this.userImpressRatingControl=null;this.userStoryRatingControl=null;this.userShowRatingControl=null;this.userDirectorRatingControl=null;this.userPictureRatingControl=null;this.userMusicRatingControl=null;this.initializeDetailRatingControl();this.commentTextbox=new Textbox({text:this.txtMovieComment,watermarkText:"可输入你的简短评论，最少不少于5个字..",focusClassName:"focus",blurClassName:"unfocus",onKeyupCallback:null})},destroyControl:function(){if(this.userImpressRatingControl){this.userImpressRatingControl.close()}if(this.userStoryRatingControl){this.userStoryRatingControl.close()}if(this.userShowRatingControl){this.userShowRatingControl.close()}if(this.userDirectorRatingControl){this.userDirectorRatingControl.close()}if(this.userPictureRatingControl){this.userPictureRatingControl.close()}if(this.userMusicRatingControl){this.userMusicRatingControl.close()}this.commentTextbox.close()},load:function(){if(this.rating>0){this.refreshRatingResultLabel(this.rating)}if(this.userLastComment){this.txtMovieComment.hide();MovieRatingHelper.setMovieCommentRegion(this.addedMovieCommentRegion,this.userLastComment,this.userLastCommentUrl,this.MAX_COMMENT_SHOW_LEGTH);this.addedMovieCommentRegion.show()}else{this.txtMovieComment.show();this.addedMovieCommentRegion.hide()}},refreshRatingResultLabel:function(b){this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(b)},onMoveParticularRatingControl:function(c,d){if(c.ratingValueRegion){c.ratingValueRegion.innerHTML=d>0?d:""}c.ratingDescriptRegion.innerHTML=MovieRatingHelper.getUserParticularRatingDescription(d)},onRatingParticularRatingControl:function(b){this.previewUserRating()},initializeDetailRatingControl:function(){this.userImpressRatingControl=this.initializeParticularRatingControl(this.userImpressRatingObj,this.userRating.Rtotal);this.userStoryRatingControl=this.initializeParticularRatingControl(this.userStoryRatingObj,this.userRating.Rstory);this.userShowRatingControl=this.initializeParticularRatingControl(this.userShowRatingObj,this.userRating.Rshow);this.userDirectorRatingControl=this.initializeParticularRatingControl(this.userDirectorRatingObj,this.userRating.Rdirector);this.userPictureRatingControl=this.initializeParticularRatingControl(this.userPictureRatingObj,this.userRating.Rpicture);this.userMusicRatingControl=this.initializeParticularRatingControl(this.userMusicRatingObj,this.userRating.Rother)},initializeParticularRatingControl:function(d,c){this.onMoveParticularRatingControl(d,c);return new Rating({menuRegion:d.ratingControlContainer,rating:c,readonly:false,onRatingCallback:this.onRatingParticularRatingControl.bind(this),onOverRatingCallback:this.onMoveParticularRatingControl.bind(this,d),onOutRatingCallback:this.onMoveParticularRatingControl.bind(this,d)})},previewUserRating:function(){var l=this.userImpressRatingControl.getValue();var r=this.userStoryRatingControl.getValue();var q=this.userShowRatingControl.getValue();var j=this.userDirectorRatingControl.getValue();var n=this.userPictureRatingControl.getValue();var m=this.userMusicRatingControl.getValue();var p=[l,r,q,j,n,m];if(this.feedbackRegion&&(p.findAll(function(a){return a>0})).length>=2){this.feedbackRegion.innerHTML="&nbsp;"}var k=(l>0||r>0||q>0||j>0||n>0||m>0);var o=this.rating;if(k){o=MovieRatingHelper.calcTotalRating(l,j,r,n,q,m)}this.refreshRatingResultLabel(o)},onConfirmRating:function(){var n=[];var o=this.userImpressRatingControl.getValue();var t=this.userStoryRatingControl.getValue();var s=this.userShowRatingControl.getValue();var m=this.userDirectorRatingControl.getValue();var q=this.userPictureRatingControl.getValue();var p=this.userMusicRatingControl.getValue();var r=[o,t,s,m,q,p];if((r.findAll(function(a){return a>0})).length<2){this.feedbackRegion.innerHTML="分项评分最少需评2项，不足2项无法提交";return}else{this.feedbackRegion.innerHTML="&nbsp;"}this.hasBeenDetailRating=(o>0||t>0||s>0||m>0||q>0||p>0);var k="";this.hasBeenComment=false;if(this.txtMovieComment.visible()){k=this.commentTextbox.getValue();var l=k.bytelength();if(l>0){if(l<this.MIN_COMMENT_COUNT*2){n.push(String.Format(this.MIN_COMMENT_DESCRIPTION,this.MIN_COMMENT_COUNT))}else{if(l>this.MAX_COMMENT_COUNT*2){n.push(String.Format(this.MAX_COMMENT_DESCRIPTION,this.MAX_COMMENT_COUNT))}else{this.hasBeenComment=true}}}}if(n.length>0){this.setHint(n.join("<br/>"))}else{if(this.hasBeenDetailRating||this.hasBeenComment){this.server.ratingComment(this.relatedObjType,this.id,this.title,k,0,o,t,s,m,q,p,this.onConfirmRatingCallback.bind(this),this.dialog.buttonNodes[0])}else{this.dialog.close()}}},onConfirmRatingCallback:function(g){if(g&&g.value){var h=g.value;var e=true,f=[];if(this.hasBeenDetailRating&&!h.success){e=false;f.push("评分失败")}if(this.hasBeenComment){if(h.commentSuccess){if(!g.value.commentText){g.value.commentText=this.commentTextbox.getValue()}this.commentTextbox.clear()}else{if(g.value.isGagged){e=false;f.push("您在时光网发布的内容违反互联网管理规定，对此帐户予禁言处理。")}else{e=false;f.push("点评失败")}}}if(f.length===0&&e){if(this.okCallback){this.okCallback(g)}this.dialog.close()}else{this.setHint(f.join("<br/>"))}}else{this.setHint("未知错误，请稍候重试")}},setHint:function(b){$alert(b)}});var MovieRatingControl=Class.create();Object.extend(MovieRatingControl.prototype,{name:"MovieRatingControl",MIN_RATING_COUNT:10,MIN_COMMENT_COUNT:5,MIN_COMMENT_DESCRIPTION:"你的点评字数不应该小于{0}字",MAX_COMMENT_COUNT:210,MAX_COMMENT_DESCRIPTION:"你的点评字数不应该大于{0}字",MAX_COMMENT_SHOW_LEGTH:16,MAX_MOVIE_GOING_TYPE_SHOW_LENGTH:12,MAX_TAG_SHOW_LENGTH:16,relatedObjType:1,moviegoingLogTypes:null,userTags:null,movieRatingControlContainer:null,userRatingDescriptionLabel:null,wantToSeeButton:null,userRatingContainer:null,particularRatingButton:null,userRatingResultRegion:null,userRatingResultLabel:null,updateUserRatingButton:null,userMovieCommentRegion:null,addMovieCommentMockupRegion:null,txtMovieComment:null,addMovieCommentButton:null,addMovieCommentRegion:null,addedMovieCommentRegion:null,addMoviegoingLogButton:null,viewMoviegoingLogRegion:null,addTagButton:null,viewTagRegion:null,server:{wantToSee:function(h,f,g,e){return this.rating(h,f,g,-1,e)},notInterest:function(h,f,g,e){return this.rating(h,f,g,-2,e)},rating:function(j,g,i,h,f){return this.ratingComment(j,g,i,"",h,0,0,0,0,0,0,f)},particularRatingComment:function(v,o,t,m,u,s,r,n,q,p,l){return this.ratingComment(v,o,t,m,0,u,s,r,n,q,p,l)},ratingComment:function(z,q,x,o,t,y,v,u,p,s,r,n,w){return Mtime.Component.Ajax.getCrossDomain("Mtime.Community.Controls.CommunityPages.DatabaseService","RatingMovie",[z,q,x,o,t,y,v,u,p,s,r],n,"/database/databaseService.m?Ajax_CallBack=true","post","20000",w)},remove:function(e,f,d){return Mtime.Component.Ajax.request(siteMcUrl,"Mtime.MemberCenter.Pages.MovieService","RemoveAttentionMovie",[e,f],d,"/service/movie.mc","get","20000")}},loadEditorJs:function(b){if(typeof(Weibo)!="undefined"&&Weibo.Editor&&Weibo.Feedback){b()}else{$loadJs(["/js/2011/weibo/editor/editor.js"],function(){b()})}},options:{isLogin:false,signInUrl:"",id:0,title:"",userRating:null,userAvatarURL:"",userHomeURL:"",userLastComment:"",userLastCommentUrl:"",moviegoingLogTypes:null,userTags:null,userId:0,movieRatingControlContainer:null,okCallback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeUserRatingData();this.initializeDOM();this.load();this.initializeControl();this.initializeEvent();this.render()},initializeDOM:function(){this.movieRatingControlContainer=$(this.movieRatingControlContainer);if(this.userAvatarURL){this.movieRatingControlContainer.appendChild(Builder.node("div",{className:"fl ele_grade_face"},[Builder.node("img",{className:"img_box",src:this.userAvatarURL,method:"useridcard",userid:this.userId})]))}var b=Builder.node("div",{className:"fl ele_grade_main ml9"});this.movieRatingControlContainer.appendChild(b);this.userRatingDescriptionLabel=$(Builder.node("div",{className:"describe"}));b.appendChild(this.userRatingDescriptionLabel);this.userRatingDescriptionLabel.hide();this.wantToSeeButton=$(Builder.node("a",{href:"#",className:"btn_w fl"},[Builder.node("span",["想看"])]));this.userRatingContainer=$(Builder.node("ul",{className:"clearfix srating fl ml9 mt3"}));this.particularRatingButton=$(Builder.node("a",{href:"#",className:"fl ml6 link_line"},["分项"]));this.userRatingResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.updateUserRatingButton=$(Builder.node("a",{href:"#"},["修改"]));this.userRatingResultRegion=$(Builder.node("span",{className:"fl ml12"},["评分：",this.userRatingResultLabel," (",this.updateUserRatingButton,")"]));b.appendChild(Builder.node("div",{className:"clearfix"},[this.wantToSeeButton,this.userRatingContainer,this.particularRatingButton,this.userRatingResultRegion]));this.addMovieCommentMockupRegion=$(Builder.node("div",{className:"add_type"},[Builder.node("b",{className:"arr_l"}),"可输入你的简短评论"]));this.txtMovieComment=$(Builder.node("textarea"));this.addMovieCommentButton=$(Builder.node("input",{type:"button",className:"add_type_btn",value:"发布"}));this.addMovieCommentFeedback=$(Builder.node("span",{className:"mr6"}));this.addMovieCommentRegion=$(Builder.node("div",{className:"add_type_open"},[Builder.node("b",{className:"arr_l"}),this.txtMovieComment,Builder.node("p",{className:"tr"},[this.addMovieCommentFeedback,this.addMovieCommentButton])]));this.addedMovieCommentRegion=$(Builder.node("div",{className:"add_added"}));this.userMovieCommentRegion=$(Builder.node("div",{className:"add_one"},[this.addMovieCommentMockupRegion,this.addMovieCommentRegion,this.addedMovieCommentRegion]));b.appendChild(this.userMovieCommentRegion);this.addMoviegoingLogButton=$(Builder.node("a",{href:"#",className:"link_none"}));this.viewMoviegoingLogRegion=$(Builder.node("span",{href:"#"}));this.addTagButton=$(Builder.node("a",{href:"#",className:"link_none"}));this.viewTagRegion=$(Builder.node("span"));b.appendChild(Builder.node("div",{className:"mt6 clearfix"},[Builder.node("p",{className:"addtypeshow"},[this.viewMoviegoingLogRegion,this.addMoviegoingLogButton]),Builder.node("p",{className:"addtag mt6"},[this.viewTagRegion,this.addTagButton])]));this.userRatingBigLabel=$(this.userRatingBigLabel);this.userRatingSmallLabel=$(this.userRatingSmallLabel);this.notInterestButton=$(this.notInterestButton)},destroyDOM:function(){this.movieRatingControlContainer=null;this.userRatingDescriptionLabel=null;this.wantToSeeButton=null;this.userRatingContainer=null;this.particularRatingButton=null;this.userRatingResultRegion=null;this.userRatingResultLabel=null;this.updateUserRatingButton=null;this.userMovieCommentRegion=null;this.addMovieCommentMockupRegion=null;this.txtMovieComment=null;this.addMovieCommentButton=null;this.addMovieCommentRegion=null;this.addedMovieCommentRegion=null;this.addMoviegoingLogButton=null;this.viewMoviegoingLogRegion=null;this.addTagButton=null;this.viewTagRegion=null;this.userRatingBigLabel=null;this.userRatingSmallLabel=null;this.wantToSeeButton=null;this.notInterestButton=null},load:function(){if(this.userRating.Rating>0){this.userRatingResultLabel.innerHTML=this.userRating.Rating;this.userRatingContainer.hide();this.particularRatingButton.hide()}else{this.userRatingResultRegion.hide()}if(this.userLastComment){MovieRatingHelper.setMovieCommentRegion(this.addedMovieCommentRegion,this.userLastComment,this.userLastCommentUrl,this.MAX_COMMENT_SHOW_LEGTH);this.addMovieCommentMockupRegion.hide();this.addMovieCommentRegion.hide()}else{this.addMovieCommentRegion.hide();this.addedMovieCommentRegion.hide()}this.renderMoviegoingLog()},initializeUserRatingData:function(){if(!this.userRating){this.userRating={Rating:0,JustTotal:0,Attitude:0,Rtotal:0,Rstory:0,Rshow:0,Rdirector:0,Rpicture:0,Rother:0}}},initializeEvent:function(){if(this.wantToSeeButton){this.onClickWantToSeeButtonHandler=this.onClickWantToSeeButton.bindAsEventListener(this);this.wantToSeeButton.observe("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.onClickNotInterestButtonHandler=this.onClickNotInterestButton.bind(this);this.notInterestButton.observe("click",this.onClickNotInterestButtonHandler)}if(this.particularRatingButton){this.onClickParticularRatingButtonHandler=this.onClickParticularRatingButton.bind(this);this.particularRatingButton.observe("click",this.onClickParticularRatingButtonHandler)}if(this.updateUserRatingButton){this.onClickUpdateUserRatingButtonHandler=this.onClickUpdateUserRatingButton.bindAsEventListener(this);this.updateUserRatingButton.observe("click",this.onClickUpdateUserRatingButtonHandler)}if(this.addMovieCommentMockupRegion){this.onClickAddMovieCommentMockupRegionHandler=this.onClickAddMovieCommentMockupRegion.bindAsEventListener(this);this.addMovieCommentMockupRegion.observe("click",this.onClickAddMovieCommentMockupRegionHandler)}if(this.txtMovieComment){this.onBlurTXTMovieCommentHandler=this.onBlurTXTMovieComment.bindAsEventListener(this);this.txtMovieComment.observe("blur",this.onBlurTXTMovieCommentHandler)}if(this.addMovieCommentButton){this.onClickAddMovieCommentButtonHandler=this.onClickAddMovieCommentButton.bindAsEventListener(this);this.addMovieCommentButton.observe("click",this.onClickAddMovieCommentButtonHandler)}if(this.addMoviegoingLogButton){this.onClickAddMoviegoingLogButtonHandler=this.onClickAddMoviegoingLogButton.bindAsEventListener(this);this.addMoviegoingLogButton.observe("click",this.onClickAddMoviegoingLogButtonHandler)}if(this.viewMoviegoingLogRegion){this.onClickViewMoviegoingLogButtonHandler=this.onClickViewMoviegoingLogButton.bindAsEventListener(this);this.viewMoviegoingLogRegion.observe("click",this.onClickViewMoviegoingLogButtonHandler)}if(this.addTagButton){this.onClickAddTagButtonHandler=this.onClickAddTagButton.bindAsEventListener(this);this.addTagButton.observe("click",this.onClickAddTagButtonHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.wantToSeeButton){this.wantToSeeButton.stopObserving("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.notInterestButton.stopObserving("click",this.onClickNotInterestButtonHandler)}if(this.particularRatingButton){this.particularRatingButton.stopObserving("click",this.onClickParticularRatingButtonHandler)}if(this.updateUserRatingButton){this.updateUserRatingButton.stopObserving("click",this.onClickUpdateUserRatingButtonHandler)}if(this.addMovieCommentMockupRegion){this.addMovieCommentMockupRegion.stopObserving("click",this.onClickAddMovieCommentMockupRegionHandler)}if(this.txtMovieComment){this.txtMovieComment.stopObserving("blur",this.onBlurTXTMovieCommentHandler)}if(this.addMovieCommentButton){this.addMovieCommentButton.stopObserving("click",this.onClickAddMovieCommentButtonHandler)}if(this.addMoviegoingLogButton){this.addMoviegoingLogButton.stopObserving("click",this.onClickAddMoviegoingLogButtonHandler)}if(this.viewMoviegoingLogRegion){this.viewMoviegoingLogRegion.stopObserving("click",this.onClickViewMoviegoingLogButtonHandler)}if(this.addTagButton){this.addTagButton.stopObserving("click",this.onClickAddTagButtonHandler)}},initializeControl:function(){if(this.userRatingContainer){this.userRatingControl=new Rating({menuRegion:this.userRatingContainer,rating:this.userRating.Rating,readonly:false,onRatingCallback:this.onRatingUserRatingCallback.bind(this),onOverRatingCallback:this.onOverUserRatingCallback.bind(this),onOutRatingCallback:this.onOutUserRatingCallback.bind(this)})}if(this.txtMovieComment&&this.addMovieCommentFeedback){this.loadEditorJs(function(){this.weiboEditorControl=new Weibo.Editor({editor:this.txtMovieComment});new Weibo.Feedback({editor:this.weiboEditorControl,digitFeedback:{target:this.addMovieCommentFeedback,normalTemplate:"{0}/{1}字",warnTemplate:'<span class="c_red">{0}/{1}字</span>'}})}.bind(this))}},destroyControl:function(){if(this.userRatingControl){this.userRatingControl.close()}this.weiboEditorControl&&this.weiboEditorControl.destroy()},render:function(){if(this.userRatingControl){this.renderUserRatingRegion()}if(this.userLastComment){this.addMovieCommentRegion.hide();MovieRatingHelper.setMovieCommentRegion(this.addedMovieCommentRegion,this.userLastComment,this.userLastCommentUrl,this.MAX_COMMENT_SHOW_LEGTH);this.addedMovieCommentRegion.show();this.addMovieCommentMockupRegion.hide()}this.renderMoviegoingLog();this.renderTagRegion()},getMoviegoingTypeString:function(b){switch(b){case 1:return"电影院";case 2:return"DVD";case 3:return"下载";case 4:return"在线";case 5:return"电视台";default:return""}},getMoviegoingTypesString:function(c){var d=[];c.each(function(a){d.push(this.getMoviegoingTypeString(a))}.bind(this));return d.join(" ")},renderMoviegoingLog:function(){if(this.moviegoingLogTypes&&this.moviegoingLogTypes.length>0){this.addMoviegoingLogButton.innerHTML='<span class="icon ico_adds ml6"></span>';this.viewMoviegoingLogRegion.innerHTML='观影方式：<a href="#">'+this.getMoviegoingTypesString(this.moviegoingLogTypes).truncate(this.MAX_MOVIE_GOING_TYPE_SHOW_LENGTH,"...").escapeHTML()+"</a>"}else{this.addMoviegoingLogButton.innerHTML='<span class="icon ico_adds mr6"></span>添加观影方式';this.viewMoviegoingLogRegion.innerHTML=""}},renderTagRegion:function(){if(this.userTags&&this.userTags.length>0){this.addTagButton.innerHTML='<span class="icon ico_adds ml6"></span>';this.viewTagRegion.innerHTML="标签："+this.userTags.join(" ").truncate(this.MAX_TAG_SHOW_LENGTH,"...").escapeHTML()}else{this.addTagButton.innerHTML='<span class="icon ico_adds mr6"></span>添加标签';this.viewTagRegion.innerHTML=""}},renderUserRatingRegion:function(){if(this.userRating){if(this.userRating.Rating>0){this.userRatingControl.setValue(this.userRating.Rating);this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating);this.userRatingContainer.hide();this.particularRatingButton.hide();this.userRatingResultRegion.show();this.renderUserRating(this.userRating.Rating);this.setWantToSeeButton(true)}else{this.userRatingControl.setValue(0);this.userRatingResultRegion.hide();this.userRatingContainer.show();this.particularRatingButton.show();this.renderUserRating(0);if(this.userRating.Attitude===1){this.setWantToSeeButton(false);this.setNotInterestButton(true)}else{if(this.userRating.Attitude===2){this.setWantToSeeButton(true);this.setNotInterestButton(false)}}}}},renderUserRating:function(b){this.userRatingDescriptionLabel.innerHTML=MovieRatingHelper.getUserRatingDescription(b)},onOverUserRatingCallback:function(b){this.userRatingDescriptionLabel.innerHTML='<b class="c_green bold">'+b+"分</b> "+MovieRatingHelper.getUserRatingDescription(b).escapeHTML();this.userRatingDescriptionLabel.show()},onOutUserRatingCallback:function(){this.userRatingDescriptionLabel.hide()},onRatingUserRatingCallback:function(b){if(this.valid()){if(b>0){this.server.rating(this.relatedObjType,this.id,this.title,b,this.onServerRatingCallback.bind(this))}}},onClickUpdateUserRatingButton:function(b){Event.stop(b);this.userRatingResultRegion.hide();this.userRatingContainer.show();this.particularRatingButton.show()},onClickWantToSeeButton:function(b){if(this.isEnableWantToSeeButton()){if(this.valid()){this.clearParticularRating();this.cancelUserRating();this.setWantToSeeButton(false);this.setNotInterestButton(true);this.server.wantToSee(this.type,this.id,this.title,this.onServerRatingCallback.bind(this))}}Event.stop(b)},onClickNotInterestButton:function(){if(this.isEnableNotInterestButton()){if(this.valid()){this.clearParticularRating();this.cancelUserRating();this.setWantToSeeButton(true);this.setNotInterestButton(false);this.server.notInterest(this.type,this.id,this.title,this.onServerRatingCallback.bind(this))}}},onServerRatingCallback:function(d){if(d&&d.value&&d.value.success){var c=d.value;this.rating=c.rating;this.ratingCount=c.ratingCount;this.wantToSeeCount=c.wantToSeeCount;this.userRating=c.userRating;this.initializeUserRatingData();this.render();this.server.remove(this.id,true,function(){});if(this.okCallback){this.okCallback(d)}}else{$alert("评分失败，请稍候重试")}},onClickAddMovieCommentMockupRegion:function(b){if(this.valid()){this.addMovieCommentMockupRegion.hide();this.addMovieCommentRegion.show();this.txtMovieComment.focus()}},onBlurTXTMovieComment:function(b){if(!this.txtMovieComment.value.trim()){this.addMovieCommentMockupRegion.show();this.addMovieCommentRegion.hide()}},onCommentCallback:function(b){if(b&&b.value){if(b.value.commentSuccess){this.userLastComment=this.txtMovieComment.value.trim();this.userLastCommentUrl=b.value.commentUrl;this.render();this.server.remove(this.id,true,function(){})}else{if(b.value.isGagged){$alert("您在时光网发布的内容违反互联网管理规定，对此帐户予禁言处理。")}else{$alert("点评失败，请稍候重试")}}}else{$alert("点评失败，请稍候重试")}},onClickAddMovieCommentButton:function(f){var d=this.txtMovieComment.value.trim();if(!d){return}var e=d.bytelength();if(e<this.MIN_COMMENT_COUNT*2){$alert(String.Format(this.MIN_COMMENT_DESCRIPTION,this.MIN_COMMENT_COUNT));return}else{if(e>this.MAX_COMMENT_COUNT*2){$alert(String.Format(this.MAX_COMMENT_DESCRIPTION,this.MAX_COMMENT_COUNT));return}}this.server.ratingComment(this.relatedObjType,this.id,this.title,d,0,0,0,0,0,0,0,this.onCommentCallback.bind(this),this.addMovieCommentButton)},onAddMoviegoingLogCallback:function(d){if(d&&d.value&&d.value.moviegoingLogId>0){var c=d.value.moviegoingType;if(!this.moviegoingLogTypes){this.moviegoingLogTypes=[]}if(!this.moviegoingLogTypes.include(c)){this.moviegoingLogTypes.push(c);this.renderMoviegoingLog()}}},onClickAddMoviegoingLogButton:function(b){if(this.valid()){new AddMoviegoingLogDialog({movieId:this.id,okCallback:this.onAddMoviegoingLogCallback.bind(this)})}Event.stop(b)},onCloseViewMoviegoingLogDialogCallback:function(b){if(this.closed){return}this.moviegoingLogTypes=b;this.renderMoviegoingLog()},onClickViewMoviegoingLogButton:function(b){if(this.valid()){new ViewMoviegoingLogDialog({movieId:this.id,closeCallback:this.onCloseViewMoviegoingLogDialogCallback.bind(this)})}Event.stop(b)},onAddTagOKCallback:function(b){if(b){this.userTags=b;this.renderTagRegion()}},onClickAddTagButton:function(b){if(this.valid()){new AddTagDialog({id:this.id,relatedObjType:1,okCallback:this.onAddTagOKCallback.bind(this)})}Event.stop(b)},cancelUserRating:function(){this.userRatingControl.setValue(0)},setWantToSeeButton:function(b){if(b){this.wantToSeeButton.className="btn_w fl"}else{this.wantToSeeButton.className="btn_g fl"}},isEnableWantToSeeButton:function(){return !this.wantToSeeButton.hasClassName("btn_g")},setNotInterestButton:function(b){if(b){}else{}},isEnableNotInterestButton:function(){return false},clearParticularRating:function(){this.userRating.Rtotal=0;this.userRating.Rstory=0;this.userRating.Rshow=0;this.userRating.Rdirector=0;this.userRating.Rpicture=0;this.userRating.Rother=0},onMovieParticularRatingCallback:function(f){if(f&&f.value){var d=false;if(f.value.success){d=true;var e=f.value;this.rating=e.rating;this.ratingCount=e.ratingCount;this.wantToSeeCount=e.wantToSeeCount;this.userRating=e.userRating;this.initializeUserRatingData()}if(f.value.commentSuccess){d=true;this.userLastComment=f.value.commentText;this.userLastCommentUrl=f.value.commentUrl}else{if(f.value.isGagged){$alert("您在时光网发布的内容违反互联网管理规定，对此帐户予禁言处理。")}}if(d){this.render();if(this.okCallback){this.okCallback(f)}this.server.remove(this.id,true,function(){})}}},onClickParticularRatingButton:function(b){if(this.valid()){new MovieParticularRatingDialog({id:this.id,rating:this.userRating.Rating,userRating:this.userRating,title:this.title,userLastComment:this.userLastComment,userLastCommentUrl:this.userLastCommentUrl,okCallback:this.onMovieParticularRatingCallback.bind(this)})}Event.stop(b)},valid:function(){if(!this.isLogin){$redirect(this.signInUrl);return false}return true},closed:false,close:function(){if(!this.closed){if(this.dialog){this.dialog.close()}this.closed=true;this.destroyControl();this.destroyEvent();this.destroyDOM()}}});var MovieRatingDialog=Class.create();Object.extend(MovieRatingDialog.prototype,{MIN_COMMENT_COUNT:5,MIN_COMMENT_DESCRIPTION:"你的点评字数不应该小于{0}字",MAX_COMMENT_COUNT:210,MAX_COMMENT_DESCRIPTION:"你的点评字数不应该大于{0}字",MAX_COMMENT_SHOW_LEGTH:16,relatedObjType:1,isTotalRatingChanged:false,isDetailRatingChanged:false,server:{loadData:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","LoadMovieRatingData",[f,e],d,"/database/databaseService.m?Ajax_CallBack=true","get","20000")},wantToSee:function(l,i,k,h,g,j){return this.rating(l,i,k,h,-1,g,j)},notInterest:function(l,i,k,h,g,j){return this.rating(l,i,k,h,-2,g,j)},rating:function(n,j,m,i,k,h,l){return this.ratingComment(n,j,m,i,k,0,0,0,0,0,0,h,l)},particularRatingComment:function(x,p,v,n,w,t,s,o,r,q,m,u){return this.ratingComment(x,p,v,n,0,w,t,s,o,r,q,m,u)},ratingComment:function(z,q,x,o,t,y,v,u,p,s,r,n,w){return Mtime.Component.Ajax.getCrossDomain("Mtime.Community.Controls.CommunityPages.DatabaseService","RatingMovie",[z,q,x,o,t,y,v,u,p,s,r],n,"/database/databaseService.m?Ajax_CallBack=true","post","20000",w)},remove:function(e,f,d){return Mtime.Component.Ajax.request(siteMcUrl,"Mtime.MemberCenter.Pages.MovieService","RemoveAttentionMovie",[e,f],d,"/service/movie.mc","get","20000")}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.server.loadData(this.relatedObjType,this.id,function(){var d=null;if(typeof loadMovieRatingDataResult!=="undefined"){d=loadMovieRatingDataResult}if(d&&d.value){var a=d.value;this.isLogin=a.isLogin;this.signInUrl=a.signInUrl;this.rating=a.rating;this.ratingCount=a.ratingCount;this.wantToSeeCount=a.wantToSeeCount;this.userRating=a.userRating;this.userLastComment=a.userLastComment;this.userLastCommentUrl=a.userLastCommentUrl;this.showDialog()}else{$alert("获取评分信息出错，请稍候再试")}}.bind(this))},buildParticularRatingObj:function(d){var c={dom:null,ratingControlContainer:null,ratingValueRegion:null,ratingDescriptRegion:null};c.ratingControlContainer=$(Builder.node("ul",{className:"clearfix grating fl"}));c.ratingValueRegion=$(Builder.node("span",{className:"fl bold c_green ml9"}));c.ratingDescriptRegion=$(Builder.node("b",{className:"ml9 fl c_666"}));c.dom=$(Builder.node("div",{className:"clearfix mt9 mb9"},[Builder.node("h5",{className:"normal fl"},[d+"："]),c.ratingControlContainer,c.ratingValueRegion,c.ratingDescriptRegion]));return c},showDialog:function(){this.wantToSeeButton=$(Builder.node("a",{href:"#",className:"btn_w fl mr12"},[Builder.node("span",["想看"])]));this.notInterestButton=$(Builder.node("a",{href:"#",className:"btn_w fl"},[Builder.node("span",["没兴趣"])]));this.userRatingContainer=$(Builder.node("ul",{className:"clearfix srating fl ml9 mt3"}));this.userRatingDescriptionLabel=$(Builder.node("div",{className:"describe"}));this.particularRatingButton=$(Builder.node("a",{href:"#",className:"fl ml6 link_line"},["分项"]));this.userRatingResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.updateUserRatingButton=$(Builder.node("a",{href:"#"},["修改"]));this.userRatingResultRegion=$(Builder.node("span",{className:"fl ml12"},["评分：",this.userRatingResultLabel," (",this.updateUserRatingButton,")"]));this.totalRatingHeadRegion=$(Builder.node("div",{className:"clearfix pos_re"},[this.wantToSeeButton,this.notInterestButton,this.userRatingDescriptionLabel,this.userRatingContainer,this.particularRatingButton,this.userRatingResultRegion]));this.detailRatingHeadResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.hideDetailRatingButton=$(Builder.node("a",{href:"#"},["收起分项"]));this.detailRatingHeadRegion=$(Builder.node("div",{className:"clearfix"},[$(Builder.node("span",{className:"fl"},["评分：",this.detailRatingHeadResultLabel])),$(Builder.node("span",{className:"fr"},[this.hideDetailRatingButton]))]));this.userImpressRatingObj=this.buildParticularRatingObj("印象");this.userStoryRatingObj=this.buildParticularRatingObj("故事");this.userShowRatingObj=this.buildParticularRatingObj("表演");this.userDirectorRatingObj=this.buildParticularRatingObj("导演");this.userPictureRatingObj=this.buildParticularRatingObj("画面");this.userMusicRatingObj=this.buildParticularRatingObj("音乐");this.detailRatingRegion=$(Builder.node("div",{className:"mt12"},[this.userImpressRatingObj.dom,this.userStoryRatingObj.dom,this.userShowRatingObj.dom,this.userDirectorRatingObj.dom,this.userPictureRatingObj.dom,this.userMusicRatingObj.dom]));this.txtMovieComment=$(Builder.node("textarea",{className:"type_b w265"}));this.addedMovieCommentRegion=$(Builder.node("div",{className:"add_added"}));this.addMovieCommentRegion=$(Builder.node("div",{className:"mt12"},[this.txtMovieComment,this.addedMovieCommentRegion]));this.hintRegion=$(Builder.node("div",{className:"c_red mt12",style:"display: none"}));this.dialog=new ToggleDialog({windowClassName:"w330",content:Builder.node("div",[this.totalRatingHeadRegion,this.detailRatingHeadRegion,Builder.node("div",{className:"mt12"},[this.detailRatingRegion,this.addMovieCommentRegion,this.hintRegion])]),setupDimensions:function(){this.getPosition();var j=this.windowElement.down(1).getDimensions();var k=j.width,i=j.height;var g=0,h=0;g=this.elementX+this.elementWidth-k+2;h=this.elementY+1;if(g<0){this.element=this.element2;this.getPosition();g=this.elementX+2;h=this.elementY+this.elementHeight+1}var l=0;if(this.overlay){l=parseInt(this.overlay.getStyle("zIndex"),10)+1}else{l=Windows.getZIndex()+1}this.windowElement.setStyle({position:"absolute",top:h+"px",left:g+"px",zIndex:l})},buttonRegionClass:"mt15 mb15 tc",buttons:[{title:"确定",buttonStyle:"btn_square_hover mr15",callback:this.onConfirmRating.bind(this)},{title:"取消",onmouseover:"this.className='btn_square_hover'",onmouseout:"this.className='btn_square'",buttonStyle:"btn_square",callback:function(b){if(this.cancelCallback){this.cancelCallback(b)}b.close()}.bind(this)}],readyCallback:this.onDialogReady.bind(this),closeCallback:this.onDialogClose.bind(this),onClickCloseCallback:this.closeCallback||Prototype.emptyFunction,element:this.element,element2:this.element2})},onDialogReady:function(b){this.initializeField();this.initializeDOM(b);this.initializeEvent();this.initializeControl();this.render()},onDialogClose:function(b){this.destroyControl();this.destroyEvent();this.destroyDOM()},initializeField:function(){this._rating=this.rating;this._userRating=this.userRating},initializeDOM:function(b){},destroyDOM:function(){this.hintRegion=null;this.wantToSeeButton=null;this.notInterestButton=null;this.userRatingContainer=null;this.userRatingDescriptionLabel=null;this.particularRatingButton=null;this.userRatingResultLabel=null;this.updateUserRatingButton=null;this.userRatingResultRegion=null;this.totalRatingHeadRegion=null;this.detailRatingHeadResultLabel=null;this.hideDetailRatingButton=null;this.detailRatingHeadRegion=null;this.userImpressRatingObj=null;this.userStoryRatingObj=null;this.userShowRatingObj=null;this.userDirectorRatingObj=null;this.userPictureRatingObj=null;this.userMusicRatingObj=null;this.detailRatingRegion=null;this.txtMovieComment=null;this.addedMovieCommentRegion=null;this.addMovieCommentRegion=null},initializeEvent:function(){if(this.wantToSeeButton){this.onClickWantToSeeButtonHandler=this.onClickWantToSeeButton.bindAsEventListener(this);this.wantToSeeButton.observe("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.onClickNotInterestButtonHandler=this.onClickNotInterestButton.bindAsEventListener(this);this.notInterestButton.observe("click",this.onClickNotInterestButtonHandler)}this.onClickParticularRatingButtonHandler=this.onClickParticularRatingButton.bindAsEventListener(this);this.particularRatingButton.observe("click",this.onClickParticularRatingButtonHandler);this.onClickHideDetailRatingButtonHandler=this.onClickHideDetailRatingButton.bindAsEventListener(this);this.hideDetailRatingButton.observe("click",this.onClickHideDetailRatingButtonHandler);if(this.updateUserRatingButton){this.onClickUpdateUserRatingButtonHandler=this.onClickUpdateUserRatingButton.bindAsEventListener(this);this.updateUserRatingButton.observe("click",this.onClickUpdateUserRatingButtonHandler)}},destroyEvent:function(){if(this.wantToSeeButton){this.wantToSeeButton.stopObserving("click",this.onClickWantToSeeButtonHandler)}if(this.notInterestButton){this.notInterestButton.stopObserving("click",this.onClickNotInterestButtonHandler)}this.particularRatingButton.stopObserving("click",this.onClickParticularRatingButtonHandler);this.hideDetailRatingButton.stopObserving("click",this.onClickHideDetailRatingButtonHandler);if(this.updateUserRatingButton){this.updateUserRatingButton.stopObserving("click",this.onClickUpdateUserRatingButtonHandler)}},initializeControl:function(){this.totalRatingControl=new Rating({menuRegion:this.userRatingContainer,rating:this.userRating?this.userRating.Rating:0,readonly:false,onRatingCallback:this.onRatingTotalRatingCallback.bind(this),onOverRatingCallback:this.onOverTotalRatingControl.bind(this),onOutRatingCallback:this.onOutTotalRatingControl.bind(this)});this.userImpressRatingControl=null;this.userStoryRatingControl=null;this.userShowRatingControl=null;this.userDirectorRatingControl=null;this.userPictureRatingControl=null;this.userMusicRatingControl=null;this.initializeDetailRatingControl();this.commentTextbox=new Textbox({text:this.txtMovieComment,watermarkText:"请添加一句话影评",focusClassName:"focus",blurClassName:"unfocus",onKeyupCallback:null})},destroyControl:function(){if(this.totalRatingControl){this.totalRatingControl.close()}if(this.userImpressRatingControl){this.userImpressRatingControl.close()}if(this.userStoryRatingControl){this.userStoryRatingControl.close()}if(this.userShowRatingControl){this.userShowRatingControl.close()}if(this.userDirectorRatingControl){this.userDirectorRatingControl.close()}if(this.userPictureRatingControl){this.userPictureRatingControl.close()}if(this.userMusicRatingControl){this.userMusicRatingControl.close()}this.commentTextbox.close()},render:function(){this.detailRatingRegion.hide();this.detailRatingHeadRegion.hide();this.userRatingDescriptionLabel.hide();if(this.userRating){if(this.userRating.Attitude===1){this.setWantToSeeButton(false);this.setNotInterestButton(true)}else{if(this.userRating.Attitude===2){this.setWantToSeeButton(true);this.setNotInterestButton(false)}else{this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating);this.totalRatingControl.setValue(this.userRating.Rating);this.setWantToSeeButton(true);this.setNotInterestButton(true)}}if(this.userRating.Rating>0){this.userRatingResultRegion.show();this.userRatingContainer.hide();this.particularRatingButton.hide()}else{this.userRatingResultRegion.hide();this.userRatingContainer.show();this.particularRatingButton.show()}}else{this.userRatingResultRegion.hide();this.userRatingContainer.show();this.particularRatingButton.show()}if(this.userLastComment){this.txtMovieComment.hide();MovieRatingHelper.setMovieCommentRegion(this.addedMovieCommentRegion,this.userLastComment,this.userLastCommentUrl,this.MAX_COMMENT_SHOW_LEGTH);this.addedMovieCommentRegion.show()}else{this.txtMovieComment.show();this.addedMovieCommentRegion.hide()}},onRatingTotalRatingCallback:function(b){this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(b);this.clearParticularRating();this.userRating.Rating=b;this.userRating.JustTotal=1;this.userRating.Attitude=0;this.isTotalRatingChanged=true;this.render()},onOverTotalRatingControl:function(b){this.userRatingDescriptionLabel.innerHTML='<b class="c_green bold">'+b+"分</b> "+MovieRatingHelper.getUserRatingDescription(b).escapeHTML();this.userRatingDescriptionLabel.show()},onOutTotalRatingControl:function(){this.userRatingDescriptionLabel.hide()},onMoveParticularRatingControl:function(c,d){if(c.ratingValueRegion){c.ratingValueRegion.innerHTML=d>0?d:""}c.ratingDescriptRegion.innerHTML=MovieRatingHelper.getUserParticularRatingDescription(d)},onRatingParticularRatingControl:function(b){this.previewUserRating();this.isDetailRatingChanged=true},initializeDetailRatingControl:function(){this.detailRatingHeadResultLabel.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating);this.userImpressRatingControl=this.initializeParticularRatingControl(this.userImpressRatingObj,this.userRating.Rtotal);this.userStoryRatingControl=this.initializeParticularRatingControl(this.userStoryRatingObj,this.userRating.Rstory);this.userShowRatingControl=this.initializeParticularRatingControl(this.userShowRatingObj,this.userRating.Rshow);this.userDirectorRatingControl=this.initializeParticularRatingControl(this.userDirectorRatingObj,this.userRating.Rdirector);this.userPictureRatingControl=this.initializeParticularRatingControl(this.userPictureRatingObj,this.userRating.Rpicture);this.userMusicRatingControl=this.initializeParticularRatingControl(this.userMusicRatingObj,this.userRating.Rother)},initializeParticularRatingControl:function(d,c){this.onMoveParticularRatingControl(d,c);return new Rating({menuRegion:d.ratingControlContainer,rating:c,readonly:false,onRatingCallback:this.onRatingParticularRatingControl.bind(this),onOverRatingCallback:this.onMoveParticularRatingControl.bind(this,d),onOutRatingCallback:this.onMoveParticularRatingControl.bind(this,d)})},previewUserRating:function(){var l=this.userImpressRatingControl.getValue();var r=this.userStoryRatingControl.getValue();var q=this.userShowRatingControl.getValue();var j=this.userDirectorRatingControl.getValue();var n=this.userPictureRatingControl.getValue();var m=this.userMusicRatingControl.getValue();var p=[l,r,q,j,n,m];if((p.findAll(function(a){return a>0})).length>=2){this.hintRegion.hide()}var k=(l>0||r>0||q>0||j>0||n>0||m>0);var o=MovieRatingHelper.calcTotalRating(l,j,r,n,q,m);this.detailRatingHeadResultLabel.innerHTML=MovieRatingHelper.getRatingString(o)},onClickParticularRatingButton:function(b){this.initializeDetailRatingControl();this.detailRatingRegion.show();this.detailRatingHeadRegion.show();this.totalRatingHeadRegion.hide();Event.stop(b)},onClickHideDetailRatingButton:function(b){this.detailRatingRegion.hide();this.detailRatingHeadRegion.hide();this.totalRatingHeadRegion.show();this.isTotalRatingChanged=false;Event.stop(b)},onConfirmRating:function(p,y){var r=[];this.hintRegion.hide();this.hasBeenTotalRating=false;var z=0;if(!this.isDetailRating()&&this.isTotalRatingChanged){z=this.totalRatingControl.getValue();if(z>0){this.hasBeenTotalRating=true}}this.hasBeenDetailRating=false;var s=0;var x=0;var w=0;var q=0;var u=0;var t=0;if(this.isDetailRating()&&this.isDetailRatingChanged){s=this.userImpressRatingControl.getValue();x=this.userStoryRatingControl.getValue();w=this.userShowRatingControl.getValue();q=this.userDirectorRatingControl.getValue();u=this.userPictureRatingControl.getValue();t=this.userMusicRatingControl.getValue();var v=[s,x,w,q,u,t];if((v.findAll(function(a){return a>0})).length<2){this.setHint("分项评分最少需评2项，不足2项无法提交");return}else{this.hintRegion.hide()}if(z>0||x>0||w>0||q>0||u>0||t>0){this.hasBeenDetailRating=true}}this.hasBeenComment=false;var n="";if(this.txtMovieComment.visible()){n=this.commentTextbox.getValue();var o=n.bytelength();if(o>0){if(o<this.MIN_COMMENT_COUNT*2){r.push(String.Format(this.MIN_COMMENT_DESCRIPTION,this.MIN_COMMENT_COUNT))}else{if(o>this.MAX_COMMENT_COUNT*2){r.push(String.Format(this.MAX_COMMENT_DESCRIPTION,this.MAX_COMMENT_COUNT))}else{this.hasBeenComment=true}}}}if(r.length>0){this.setHint(r.join("<br/>"))}else{if(!this.isEnableWantToSeeButton()&&!this.isDetailRating()){this.server.wantToSee(this.relatedObjType,this.id,"",n,this.onConfirmRatingCallback.bind(this),this.dialog.buttonNodes[0])}else{if(!this.isEnableNotInterestButton()&&!this.isDetailRating()){this.server.notInterest(this.relatedObjType,this.id,"",n,this.onConfirmRatingCallback.bind(this),this.dialog.buttonNodes[0])}else{if(this.hasBeenTotalRating||this.hasBeenDetailRating||this.hasBeenComment){this.server.ratingComment(this.relatedObjType,this.id,"",n,z,s,x,w,q,u,t,this.onConfirmRatingCallback.bind(this),this.dialog.buttonNodes[0])}else{this.dialog.close()}}}}},onConfirmRatingCallback:function(g){if(g&&g.value){var h=g.value;var e=true,f=[];if(this.hasBeenTotalRating&&!h.success){e=false;f.push("评分失败")}if(this.hasBeenDetailRating&&!h.success){e=false;f.push("评分失败")}if(this.hasBeenComment){if(h.commentSuccess){this.commentTextbox.clear()}else{if(g.value.isGagged){e=false;f.push("您在时光网发布的内容违反互联网管理规定，对此帐户予禁言处理。")}else{e=false;f.push("点评失败")}}}if(f.length===0&&e){if(this.okCallback){this.okCallback(h)}this.server.remove(this.id,true,function(){});this.dialog.close()}else{this.setHint(f.join("<br/>"))}}else{this.setHint("未知错误，请稍候重试")}},onClickUpdateUserRatingButton:function(b){Event.stop(b);this.userRatingResultRegion.hide();this.userRatingContainer.show();this.particularRatingButton.show()},onClickWantToSeeButton:function(b){if(this.isEnableWantToSeeButton()){this.clearParticularRating();this.totalRatingControl.setValue(0);this.userRating.Rating=0;this.userRating.JustTotal=1;this.userRating.Attitude=1;this.userLastComment="";this.userLastCommentUrl="";this.render()}Event.stop(b)},onClickNotInterestButton:function(b){if(this.isEnableNotInterestButton()){this.clearParticularRating();this.totalRatingControl.setValue(0);this.userRating.Rating=0;this.userRating.JustTotal=1;this.userRating.Attitude=2;this.userLastComment="";this.userLastCommentUrl="";this.render()}Event.stop(b)},setWantToSeeButton:function(b){if(b){this.wantToSeeButton.removeClassName("btn_g");this.wantToSeeButton.addClassName("btn_w")}else{this.wantToSeeButton.removeClassName("btn_w");this.wantToSeeButton.addClassName("btn_g")}},isEnableWantToSeeButton:function(){return !this.wantToSeeButton.hasClassName("btn_g")},setNotInterestButton:function(b){if(b){this.notInterestButton.removeClassName("btn_o");this.notInterestButton.addClassName("btn_w")}else{this.notInterestButton.removeClassName("btn_w");this.notInterestButton.addClassName("btn_o")}},isEnableNotInterestButton:function(){return !this.notInterestButton.hasClassName("btn_o")},clearParticularRating:function(){this.userRating.Rtotal=0;this.userRating.Rstory=0;this.userRating.Rshow=0;this.userRating.Rdirector=0;this.userRating.Rpicture=0;this.userRating.Rother=0},setHint:function(b){this.hintRegion.innerHTML=b;this.hintRegion.show()},isDetailRating:function(){return this.detailRatingRegion.visible()}});var MovieRatingButtonControl=Class.create();Object.extend(MovieRatingButtonControl.prototype,{name:"MovieRatingButtonControl",closed:false,relatedObjType:1,movieId:0,dialog:null,movieRatingButton:null,options:{isLogin:false,signInUrl:"",id:0,movieRatingButton:"",title:"",userRating:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeDOM();this.initializeControl();this.initializeEvent();this.load();this.render()},initializeField:function(){if(!this.isLogin){this.userRating=null}},initializeDOM:function(){this.movieRatingButton=$(this.movieRatingButton);this.movieRatingButton.innerHTML="";this.movieRatingButtonText=$(Builder.node("span"));this.movieRatingButton.appendChild(Builder.node("div",{className:"ele_select"},[Builder.node("a",{className:"ele_select_a",method:"movieRatingButton",href:"#",onclick:"return false;"},[this.movieRatingButtonText])]))},destroyDOM:function(){this.movieRatingButton=null;this.movieRatingButtonText=null;this.dialog=null},initializeEvent:function(){this.onClickMovieRatingButtonHandler=this.onClickMovieRatingButton.bindAsEventListener(this);this.movieRatingButton.observe("click",this.onClickMovieRatingButtonHandler)},destroyEvent:function(){this.movieRatingButton.stopObserving("click",this.onClickMovieRatingButtonHandler)},initializeControl:function(){},destroyControl:function(){},load:function(){},render:function(){this.movieRatingButton.removeClassName("ele_select_seen");this.movieRatingButton.removeClassName("ele_select_seeng");this.movieRatingButton.removeClassName("ele_select_b");this.movieRatingButton.removeClassName("ele_select_un");if(this.userRating){if(this.userRating.Attitude===1){this.movieRatingButton.addClassName("ele_select_seeng");this.movieRatingButtonText.innerHTML="想看"}else{if(this.userRating.Attitude===2){this.movieRatingButton.addClassName("ele_select_un");this.movieRatingButtonText.innerHTML="没兴趣"}else{if(this.userRating.Rating>0){this.movieRatingButton.addClassName("ele_select_seen");this.movieRatingButtonText.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating)}else{this.movieRatingButton.addClassName("ele_select_b");this.movieRatingButtonText.innerHTML="未评分"}}}}else{this.movieRatingButtonText.innerHTML="看过？"}},onClickMovieRatingButton:function(b){if(!this.isLogin){$redirect(this.signInUrl)}else{this.showMovieRatingDialog()}},onRatingDialogOKCallback:function(b){this.userRating=b.userRating;this.render()},showMovieRatingDialog:function(){new MovieRatingDialog({id:this.id,element:this.movieRatingButtonText,element2:this.movieRatingButton,okCallback:this.onRatingDialogOKCallback.bind(this)})},close:function(){if(!this.closed){this.closed=true;this.destroyControl();this.destroyEvent();this.destroyDOM()}}});var MovieRatingControlManager=Class.create();Object.extend(MovieRatingControlManager.prototype,{name:"MovieRatingControlManager",closed:false,movieRatingControls:null,options:{isLogin:false,signInUrl:""},server:{getUserMoviesRatingData:function(d,c){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","GetUserMoviesRatingData",[d],c,"/database/databaseService.m?Ajax_CallBack=true","get","20000")}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField()},initializeField:function(){this.movieRatingControls=[]},getUserMoviesRatingDataCallback:function(c){var d=null;if(typeof getUserMoviesRatingDataResult!=="undefined"){d=getUserMoviesRatingDataResult}if(d&&d.value){d.value.each(function(b){var a=c.find(function(e){return e.movieId==b.movieId});if(!a){return}var h=a.movieRatingControlContainer;var g=new MovieRatingControl({id:b.movieId,isLogin:this.isLogin,userRating:b.userRating,userLastComment:b.userLastComment,userLastCommentUrl:b.userLastCommentUrl,moviegoingLogTypes:b.moviegoingLogTypes,userTags:b.userTags,movieRatingControlContainer:h});this.movieRatingControls.push(g)}.bind(this))}},initMovieRatingControls:function(c){if(c.length===0){return}if(this.isLogin){var d=[];c.each(function(a){d.push(a.movieId)}.bind(this));this.server.getUserMoviesRatingData(d.join(","),this.getUserMoviesRatingDataCallback.bind(this,c))}else{c.each(function(a){var b=new MovieRatingControl({id:a.movieId,isLogin:this.isLogin,signInUrl:this.signInUrl,movieRatingControlContainer:a.movieRatingControlContainer});this.movieRatingControls.push(b)}.bind(this))}},close:function(){if(!this.closed){this.closed=true;this.movieRatingControls.each(function(b){b.close()});this.movieRatingControls=null}}});var MovieRatingButtonControlManager=Class.create();Object.extend(MovieRatingButtonControlManager.prototype,{name:"MovieRatingButtonControlManager",closed:false,movieRatingButtonControls:null,options:{isLogin:false,signInUrl:""},server:{getUserMoviesRatingData:function(d,c){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.DatabaseService","GetUserMoviesRatingData",[d],c,"/database/databaseService.m?Ajax_CallBack=true","get","20000")}},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField()},initializeField:function(){this.movieRatingButtonControls=[]},getUserMoviesRatingDataCallback:function(c){var d=null;if(typeof getUserMoviesRatingDataResult!=="undefined"){d=getUserMoviesRatingDataResult}if(d&&d.value){d.value.each(function(b){var a=c.find(function(e){return e.movieId==b.movieId});if(!a){return}var f=new MovieRatingButtonControl({id:b.movieId,isLogin:this.isLogin,userRating:b.userRating,movieRatingButton:a.movieRatingButtonContainer});this.movieRatingButtonControls.push(f)}.bind(this))}},initMovieRatingControls:function(c){if(c.length===0){return}if(this.isLogin){var d=[];c.each(function(a){d.push(a.movieId)}.bind(this));this.server.getUserMoviesRatingData(d.join(","),this.getUserMoviesRatingDataCallback.bind(this,c))}else{c.each(function(a){var b=new MovieRatingButtonControl({id:a.movieId,isLogin:this.isLogin,signInUrl:this.signInUrl,movieRatingButton:a.movieRatingButtonContainer,userRating:null});this.movieRatingButtonControls.push(b)}.bind(this))}},close:function(){if(!this.closed){this.closed=true;this.movieRatingButtonControls.each(function(b){b.close()});this.movieRatingButtonControls=null}}});var Follow=Class.create();Object.extend(Object.extend(Follow.prototype),{server:{Follow:function(f,d,e){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","Follow",[f],e,"/Service/Twitter.msi","get","20000",d)},UnFollow:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","UnFollow",[d],c,"/Service/Twitter.msi","get","20000")},RemoveFromBlackList:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","RemoveFromBlackList",[d],c,"/Service/Twitter.msi","get","20000")}},options:{container:"",ischange:false,iscard:false,isuser:false,callback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeDom();this.initializeEvent()},initializeDom:function(){this.container=$(this.container)},destroyDOM:function(){this.container=null;this.collectBoxId=null},initializeEvent:function(){this.clickRegionHandler=this.onClick.bind(this);this.container.observe("click",this.clickRegionHandler);Event.observe(window,"unload",this.close.bind(this))},onClick:function(g){var e=Event.element(g);var h=e.readAttribute("method");switch(h){case"aFollow":this.fTwitterId=e.readAttribute("ftwitterid");var f='<p class="bold">确定不再关注？</p>';this.closeFollow(e,f,"c");break;case"bFollow":this.fTwitterId=e.readAttribute("ftwitterid");var f='<p class="bold">确定取消关注？</p>';this.closeFollow(e,f,"d");break;case"cFollow":case"dFollow":this.fTwitterId=e.readAttribute("ftwitterid");this.server.Follow(this.fTwitterId,e,function(c){if(c&&c.value){switch(c.value){case -7:if(typeof Weibo!="undefined"&&typeof(Weibo.UserLoginDialog)!="undefined"){var d=new Weibo.UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs(["/js/2011/weibo/popupDialog.js"],function(){var j=new Weibo.UserLoginDialog({callback:function(){location.reload()}})})}break;case -1:$alert("不能关注自己!");break;case -4:$alert("关注失败，关注人数已达上限!");break;case -5:$alert("由于该用户的隐私设置，您无法关注他/她!");break;case -3:case -2:$alert("关注失败，该用户已不存在!");break;case -6:$alert("该会员已被你拉入黑名单");break;case 0:$alert("关注失败!");break;case 1:this.nickname=e.readAttribute("nickname");if(this.ischange){if(h==="cFollow"){this.builderNode("a");this.followId=e.up("a",0);if(typeof(this.followId)==="undefined"){this.followId=e}}else{if(h==="dFollow"){this.builderNode("b");this.followId=e.up("span",0)}}this.followId.next("p.pt12")&&this.followId.next("p.pt12").remove();if(Mtime.browser.gecko&&h==="cFollow"){var a;if(this.iscard){a=Builder.node("span",{className:"my_relation"})}else{a=Builder.node("span",{className:"my_relation fr mt9 mr9"})}a.innerHTML='<span class="ico_focus mr6 c_000"><cite>已关注</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method="aFollow">取消</cite></a>';var b=this.followId.up();b.insertBefore(a,this.followId);this.followId.remove()}else{this.followId.replace(this.followTemplate)}}this.callback&&this.callback(this.followId,false,"follow");if(this.isuser){if(typeof Weibo!="undefined"&&typeof(Weibo.FollowSuccDialog)!="undefined"){var d=new Weibo.FollowSuccDialog({user:{id:this.fTwitterId,name:this.nickname}})}else{$loadJs(["/js/2011/weibo/popupDialog.js"],function(){var j=new Weibo.FollowSuccDialog({user:{id:this.fTwitterId,name:this.nickname}})}.bind(this))}}break}}}.bind(this));break;case"eFollow":this.fTwitterId=e.readAttribute("ftwitterid");var f='<p class="bold">确定解除黑名单？</p>';this.followId=e.up("span",0);if(this.collectBox!=null){this.collectBox.close()}this.collectBox=new DialogBox({element:e,content:f,buttons:[{title:"确定",buttonStyle:"btn_blue2 mr15",callback:function(a){this.server.RemoveFromBlackList(this.fTwitterId,function(b){this.callback&&this.callback("",false);if(b&&b.value){if(this.ischange){this.nickname=e.readAttribute("nickname");this.builderNode("c");this.followId.next("p.pt12")&&this.followId.next("p.pt12").remove();this.followId.replace(this.followTemplate)}}}.bind(this));a.close()}.bind(this)},{title:"取消",buttonStyle:"btn_gray2",onmouseover:"this.className='btn_blue2'",onmouseout:"this.className='btn_gray2'",callback:function(a){if(this.ischange){this.callback&&this.callback("",false)}a.close()}.bind(this)}]});break}},destroyEvent:function(){this.container.stopObserving("click",this.clickRegionHandler)},closeFollow:function(e,d,f){this.followId=e.up("span",0);if(this.collectBox!=null){this.collectBox.close()}if(browser.ie){e.up("a",0).style.position="static"}this.collectBox=new DialogBox({element:e,content:d,buttons:[{title:"确定",buttonStyle:"btn_blue2 mr15",callback:function(a){this.server.UnFollow(this.fTwitterId,function(b){if(b&&b.value){this.callback&&this.callback(this.followId,false,"unfollow");if(this.ischange){this.nickname=e.readAttribute("nickname");this.builderNode(f);this.followId.next("p.pt12")&&this.followId.next("p.pt12").remove();this.followId.replace(this.followTemplate)}}}.bind(this));a.close()}.bind(this)},{title:"取消",buttonStyle:"btn_gray2",onmouseover:"this.className='btn_blue2'",onmouseout:"this.className='btn_gray2'",callback:function(a){if(this.ischange){this.callback&&this.callback("",false)}a.close()}.bind(this)}]})},builderNode:function(b){switch(b){case"a":if(this.iscard){this.followTemplate='<span class="my_relation fr mt9 mr9"><span class="ico_focus mr6 c_000"><cite>已关注</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method="aFollow">取消</cite></a></span>'}else{this.followTemplate='<span class="my_relation"><span class="ico_focus mr6 c_000"><cite>已关注</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method="aFollow">取消</cite></a></span>'}break;case"b":if(this.iscard){this.followTemplate='<span class="my_relation fr mt9 mr9"><span class="ico_ecfocus mr6 c_000"><cite>相互关注</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method="bFollow">取消</cite></a></span>'}else{this.followTemplate='<span class="my_relation"><span class="ico_ecfocus mr6 c_000"><cite>相互关注</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method="bFollow">取消</cite></a></span>'}break;case"c":if(this.iscard){this.followTemplate='<a class="my_relation_adds fr mt9 mr9" href="#" onclick="return false" ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "cFollow" ><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "cFollow">加关注</cite></a>'}else{this.followTemplate='<a class="my_relation_adds cc" href="#" onclick="return false" ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "cFollow" ><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "cFollow">加关注</cite></a>'}break;case"d":if(this.iscard){this.followTemplate='<span class="my_relation fr mt9 mr9"><span class="mr6 c_000"><cite>粉丝</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "dFollow">加关注</cite></a></span>'}else{this.followTemplate='<span class="my_relation"><span class="mr6 c_000"><cite>粉丝</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "dFollow">加关注</cite></a></span>'}break;case"e":if(this.iscard){this.followTemplate='<span class="my_relation fr mt9 mr9"><span class="mr6 c_000"><cite>已加入黑名单</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "dFollow">解除</cite></a></span>'}else{this.followTemplate='<span class="my_relation"><span class="mr6 c_000"><cite>已加入黑名单</cite></span>|<a href="#" onclick="return false"  class="ico_cancel ml6"><cite ftwitterid='+this.fTwitterId+" nickname="+this.nickname+' method= "dFollow">解除</cite></a></span>'}break}},closed:false,close:function(){if(!this.closed){this.closed=true;this.destroyEvent();this.destroyDOM()}}});var Card=Class.create();Object.extend(Object.extend(Card.prototype),{server:{GetUserInfo:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetUserLayerInfo",[d],c,"/Service/Twitter.msi","get","20000")},GetPersonInfo:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetPersonLayerInfo",[d],c,"/Service/Twitter.msi","get","20000")},GetMovieInfo:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.MovieService","GetMovieLayerInfo",[d],c,"/Service/Movie.msi","get","20000")},GetUserLayerInfoByUserId:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetUserLayerInfoByUserId",[d],c,"/Service/Twitter.msi","get","20000")},GetMovieLayerInfoByMovieId:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.MovieService","GetMovieLayerInfoByMovieId",[d],c,"/Service/Movie.msi","get","20000")},GetPersonLayerInfoByPersonId:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetPersonLayerInfoByPersonId",[d],c,"/Service/Twitter.msi","get","20000")},sendMessage:function(f,e,d){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.MessageService","SendUserMessageToNicknameCrossDomainByFlash",[f,e],d,"/Service/Message.msi","post","20000")},GetBadgeLayerInfo:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetBadgeLayerInfo",[f,e],d,"/Service/Twitter.msi","get","20000")}},information:{},followBool:false,options:{mytimeContentRegion:"",loadTemplate:'<div class="inner w200"><span class="loading"></span></div>',callback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeDOM();this.load();this.initializeEvent()},initializeDOM:function(){this.mytimeContentRegion=$(this.mytimeContentRegion);this.collectBoxTimeout=null},destroyDOM:function(){this.mytimeContentRegion=null;this.collectBoxId=null;this.followBool=false},initializeEvent:function(){if(this.mytimeContentRegion){this.onOverHandler=this.onOver.bind(this);this.mytimeContentRegion.observe("mouseover",this.onOverHandler);this.onOutHandler=this.onOut.bind(this);this.mytimeContentRegion.observe("mouseout",this.onOutHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.mytimeContentRegion){this.mytimeContentRegion.stopObserving("mouseover",this.onOverHandler);this.mytimeContentRegion.stopObserving("mouseout",this.onOutHandler);this.mytimeContentRegion.stopObserving("click",this.clickRegionHandler)}},load:function(){if(typeof(Follow)=="undefined"){$loadJs("/js/2011/weibo/Follow.js")}},render:function(){},onOver:function(d){var c=Event.element(d);this.cardElement=c;this.method=c.getAttribute("method");this.clientx=d.clientX;this.clienty=d.clientY;switch(this.method){case"usercard":this.userMethod(this.method);break;case"useridcard":this.userMethod(this.method);break;case"personcard":this.personMethod(this.method);break;case"personidcard":this.personMethod(this.method);break;case"moviecard":this.movieMethod(this.method);break;case"movieidcard":this.movieMethod(this.method);break;case"badgecard":this.badgeMethod(this.method);break}},userMethod:function(b){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var a;if(b==="usercard"){a=this.cardElement.readAttribute("ftwitterid")}else{if(b==="useridcard"){a=this.cardElement.readAttribute("userid")}}this.twitterId=a;this.key=b+a;this.cardElement.makePositioned();if(this.information[this.key]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(b==="usercard"){this.server.GetUserInfo(a,function(e){if(e&&e.value){var f=e.value.value;this.information[this.key]=f;this.overMy_leftMethod(this.cardElement,f)}}.bind(this))}else{if(b==="useridcard"){this.server.GetUserLayerInfoByUserId(a,function(e){if(e&&e.value){var f=e.value.value;this.information[this.key]=f;this.overMy_leftMethod(this.cardElement,f)}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[this.key])}},500,this)},movieMethod:function(b){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var a;if(b==="moviecard"){a=this.cardElement.readAttribute("ftwitterid")}else{if(b==="movieidcard"){a=this.cardElement.readAttribute("movieid")}}this.key=b+a;this.cardElement.makePositioned();if(this.information[this.key]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(b==="moviecard"){this.server.GetMovieInfo(a,function(l){if(l&&l.value){var h=l.value;var i;if(h.NotFound){var j=this.cardElement.readAttribute("alt");var k=j!==null?j:this.cardElement.innerHTML;k=k.replace("《","");k=k.replace("》","");i=String.format(h.value,k);h.value=i}else{i=h.value.replace('<div class="td">','<div class="td" style="height: 128px;">')}this.information[this.key]=h;this.overMy_leftMethod(this.cardElement,i);if(this.collectBox!=null&&h.isLogin){this.newMovieRatingButtonControl(h)}}}.bind(this))}else{if(b==="movieidcard"){this.server.GetMovieLayerInfoByMovieId(a,function(l){if(l&&l.value){var h=l.value;var i;if(h.NotFound){var j=this.cardElement.readAttribute("alt");var k=j!==null?j:this.cardElement.innerHTML;k=k.replace("《","");k=k.replace("》","");i=String.format(h.value,k);h.value=i}else{i=h.value.replace('<div class="td">','<div class="td" style="height: 128px;">')}this.information[this.key]=h;this.overMy_leftMethod(this.cardElement,i);if(this.collectBox!=null&&h.isLogin){this.newMovieRatingButtonControl(h)}}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[this.key].value);if(this.collectBox!=null&&this.information[this.key].isLogin){this.newMovieRatingButtonControl(this.information[this.key])}}this.statisticsMoive("display")},500,this)},newMovieRatingButtonControl:function(b){new MovieRatingControl({id:b.movieId,isLogin:b.isLogin,userRating:b.userMovieRating,movieRatingControlContainer:b.movieRatingButtonContainer,okCallback:this.movieRatingCallback.bind(this),initializeDOM:function(){this.movieRatingControlContainer=$(this.movieRatingControlContainer);var a=Builder.node("div",{className:"fl ele_grade_main clearfix",style:"position: relative;"});this.movieRatingControlContainer.innerHTML="";this.movieRatingControlContainer.appendChild(a);this.userRatingDescriptionLabel=$(Builder.node("div",{className:"describe",style:"right: -50px;"}));a.appendChild(this.userRatingDescriptionLabel);this.userRatingDescriptionLabel.hide();this.wantToSeeButton=$(Builder.node("a",{href:"#",className:"btn_w fl"},[Builder.node("span",["想看"])]));this.userRatingContainer=$(Builder.node("ul",{className:"clearfix srating fl ml9 mt3"}));this.userRatingResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.updateUserRatingButton=$(Builder.node("a",{href:"#"},["修改"]));this.userRatingResultRegion=$(Builder.node("span",{className:"fl ml12"},["评分：",this.userRatingResultLabel," (",this.updateUserRatingButton,")"]));a.appendChild(this.wantToSeeButton);a.appendChild(this.userRatingContainer);a.appendChild(this.userRatingResultRegion)},load:function(){if(this.userRating.Rating>0){this.userRatingResultLabel.innerHTML=this.userRating.Rating;this.userRatingContainer.hide()}else{this.userRatingResultRegion.hide()}},renderUserRatingRegion:function(){if(this.userRating){if(this.userRating.Rating>0){this.userRatingControl.setValue(this.userRating.Rating);this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating);this.userRatingContainer.hide();this.userRatingResultRegion.show();this.renderUserRating(this.userRating.Rating);this.setWantToSeeButton(true)}else{this.userRatingControl.setValue(0);this.userRatingResultRegion.hide();this.userRatingContainer.show();this.renderUserRating(0);if(this.userRating.Attitude===1){this.setWantToSeeButton(false);this.setNotInterestButton(true)}else{if(this.userRating.Attitude===2){this.setWantToSeeButton(true);this.setNotInterestButton(false)}}}}},render:function(){if(this.userRatingControl){this.renderUserRatingRegion()}},onClickUpdateUserRatingButton:function(a){Event.stop(a);this.userRatingResultRegion.hide();this.userRatingContainer.show()}})},movieRatingCallback:function(b){this.information[this.key]=undefined},movieRatingClick:function(b){this.followBool=false},personMethod:function(b){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var a;if(b==="personcard"){a=this.cardElement.readAttribute("ftwitterid")}else{if(b==="personidcard"){a=this.cardElement.readAttribute("personid")}}var d=b+a;this.cardElement.makePositioned();if(this.information[d]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(b==="personcard"){this.server.GetPersonInfo(a,function(f){if(f&&f.value){var c=f.value.value.replace('<div class="td">','<div class="td" style="height: 128px;">');this.information[d]=c;this.overMy_leftMethod(this.cardElement,c)}}.bind(this))}else{if(b==="personidcard"){this.server.GetPersonLayerInfoByPersonId(a,function(f){if(f&&f.value){var c=f.value.value.replace('<div class="td">','<div class="td" style="height: 128px;">');this.information[d]=c;this.overMy_leftMethod(this.cardElement,c)}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[d])}},500,this)},badgeMethod:function(b){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var f=this.cardElement.readAttribute("userid");var e=this.cardElement.readAttribute("medaltype");var a=b+e;this.cardElement.makePositioned();if(this.information[a]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);this.server.GetBadgeLayerInfo(f,e,function(d){if(d&&d.value){var c=d.value.value;this.information[a]=c;this.overMy_leftMethod(this.cardElement,c)}}.bind(this))}else{this.overMy_leftMethod(this.cardElement,this.information[a])}},500,this)},onOut:function(e){var d=Event.element(e);var f=d.getAttribute("method");if(f==="usercard"||f==="moviecard"||f==="personcard"||f==="useridcard"||f==="movieidcard"||f==="personidcard"||f==="badgecard"){this.handleOutTimer();if(this.collectBox!=null){this.collectBoxTimeout=FunctionExt.defer(function(){if(this.followBool==false){this.closeCard()}},500,this)}}},clickCollectBox:function(s){var p=Event.element(s);if(Mtime.browser.ie&&Mtime.browser.ie>6){var r=p.up("div.ele_select");var z=p.hasClassName("ele_select")?p:null;var t=z||r;if(t){this.followBool=true;this.timedCount()}}var v=p.readAttribute("method");switch(v){case"message":var x=p.readAttribute("nickname");new Weibo.SendMessageDialog({user:{nickname:x}});this.closeCardIeMethod();break;case"at":var x=p.readAttribute("nickname");new Weibo.TwitterDialog({content:"对@"+x+" 说:"});this.closeCardIeMethod();break;case"remark":var u=p.readAttribute("ftwitterid");var y=p.readAttribute("remark");new Weibo.UpdateRemarkDialog({user:{id:u,remark:y},callback:function(){this.information[this.key]=undefined}.bind(this)});this.closeCardIeMethod();break;case"group":var u=p.readAttribute("ftwitterid");var x=p.readAttribute("nickname");new Weibo.FollowSuccDialog({user:{id:u,name:x}});this.closeCardIeMethod();break;case"aFollow":this.followBool=true;break;case"bFollow":this.followBool=true;break;case"quickticketbutton":this.statisticsMoive("buyTicket");var q=p.readAttribute("date");var w=p.readAttribute("movieid");var n=p.readAttribute("cityid");var o=p.readAttribute("cityname");TheaterQuickTicketsDialog&&new TheaterQuickTicketsDialog({city:{Id:n,NameCn:o},selectedMovieId:w,selectedDate:q});break;case"gotoshowtimespage":this.statisticsMoive("searchShowtimes");break}},timedCount:function(){if(this.isChanger){this.contentEnd=$("contentEnd");if(this.contentEnd){this.movieRating=this.contentEnd.down(".w330");if(this.movieRating){setTimeout(function(){this.timedCount()}.bind(this),1000)}else{if(this.collectBox!=null){this.closeCard();this.followBool=false}this.isChanger=false}}}else{setTimeout(function(){this.timedCount()}.bind(this),1000);this.isChanger=true}},closeCardIeMethod:function(){if(Mtime.browser.ie&&Mtime.browser.ie<7&&this.collectBox!=null){this.closeCard()}},overMy_leftMethod:function(c,d){if(this.collectBox!=null){this.closeCard()}this.isAutoClose=true;if(this.method==="moviecard"||this.method==="movieidcard"){this.isAutoClose=false}this.collectBox=new DialogBox({element:c,content:d,arrowNew:true,isAutoClose:this.isAutoClose,setupDimensions:function(){var x=0,z=0;var B=this.windowElement.getDimensions();var C=B.width;var A=B.height;var v=this.elementX+this.elementWidth/2;var w=this.elementY;var s=v;var t=w+this.elementHeight;if(this.arrowNew){var b=this.cardId.down("em."+this.indicationStyle)}else{var b=this.cardId.down("p."+this.indicationStyle)}var a;if(b===undefined||b===null){a=17}else{a=b.getHeight()}switch(this.positionType){case 0:x=s-47;z=t+a;break;case 1:x=s-(C-47);z=t+a;break;case 2:x=v-47;z=w-a-A;break;case 3:x=v-(C-47);z=w-a-A;break;default:x=s-47;z=t+a;break}var D=0;if(this.overlay){D=parseInt(this.overlay.getStyle("zIndex"),10)+1}else{D=Windows.getZIndex()+1}if(Mtime.browser.ie&&Mtime.browser.ie>=7){var r=this.element.getHeight();var u=this.element.getStyle("fontSize");var y=parseInt(u.slice(0,2),10);if(this.element.innerHTML!==""&&r>y+10){x=200}}this.windowElement.setStyle({position:"absolute",top:z+"px",left:x+"px",zIndex:D})}});this.collectBoxId=$(this.collectBox.id);this.isWordWrap(c);if(this.collectBoxId){this.overCollectBoxIdHandler=this.overCollectBox.bind(this);this.outCollectBoxIdHandler=this.outCollectBox.bind(this);this.clickCollectBoxIdHandler=this.clickCollectBox.bind(this);this.collectBoxId.observe("mouseover",this.overCollectBoxIdHandler);this.collectBoxId.observe("mouseout",this.outCollectBoxIdHandler);this.collectBoxId.observe("click",this.clickCollectBoxIdHandler)}if(this.method==="usercard"||this.method==="useridcard"){this.methodStr=this.method;this.follow=new Follow({container:this.collectBox.id,ischange:true,iscard:true,isuser:true,callback:this.getFollowBool.bind(this)})}},getFollowBool:function(e,d,f){this.followBool=d;if(this.twitterId){this.information[this.methodStr+this.twitterId]=undefined;this.twitterId=null}this.callback&&this.callback(f)},overCollectBox:function(b){Event.stop(b);this.handleOutTimer()},outCollectBox:function(b){Event.stop(b);this.collectBoxTimeout=FunctionExt.defer(function(){if(this.followBool==false){this.closeCard()}},500,this)},handleOutTimer:function(){if(this.collectBoxTimeout!=null){clearTimeout(this.collectBoxTimeout);this.collectBoxTimeout=null;this.collectBoxId=null}},isWordWrap:function(A){var B=A.getHeight();var G=A.getStyle("fontSize");var Q=parseInt(G.slice(0,2),10);if(A.innerHTML!==""&&B>Q+10){var N=A.up(0);var P=N.getWidth();var C=A.getWidth();var O=Position.cumulativeOffset(N);var I=Position.cumulativeOffset(A);var D=P-(this.collectBox.elementX-O[0]);var z;var L;var K;var F;var y=this.collectBoxId.down("em",0);if(this.collectBox.elementX<=this.clientx){z=Math.round(D/2);L=this.collectBox.elementX;K=I[1];F=K+B/2}else{var H=A.innerHTML.length;var R=(Q*H-D)+(P-C);z=20;L=O[0];K=I[1]+B/2+5;F=this.collectBox.elementY+this.collectBox.elementHeight;if(this.collectBox.positionType===1){this.collectBox.positionType=0;if(y!==undefined||y!==null){y.className="tl_arrow"}}if(this.collectBox.positionType===3){this.collectBox.positionType=2;if(y!==undefined||y!==null){y.className="bl_arrow"}}}var M=0,S=0;var U=this.collectBoxId.getDimensions();var V=U.width;var T=U.height;var J=L+z;var E=J;if(y!==undefined||y!==null){arrowHeight=y.getHeight()}else{arrowHeight=10}switch(this.collectBox.positionType){case 0:M=E-67;S=F+arrowHeight;break;case 1:M=E-(V-47);S=F+arrowHeight;break;case 2:M=J-67;S=K-arrowHeight-T;break;case 3:M=J-(V-47);S=K-arrowHeight-T;break;default:M=E-67;S=F+arrowHeight;break}this.collectBoxId.setStyle({top:S+"px",left:M+"px"})}},statisticsMoive:function(i){var p="M13_MovieLayer_Other";var o="";var j=["M11_TwitterIndex","M13_News","M08_Movie_Overview"];var l=["http://my.mtime.com","http://news.mtime.com","http://movie.mtime.com"];var m=["http://my.test.com","http://news.test.com","http://movie.test.com"];var k;if(siteUrl.indexOf("http://www.mtime.com")==0){k=l}else{if(siteUrl.indexOf("http://www.test.com")==0){k=m}}for(var n=0;n<k.length;n++){if(location.href.indexOf(k[n])==0){p=j[n];break}}switch(p){case"M13_News":switch(i){case"display":o="M13_News_MovieLayer_Display";break;case"buyTicket":o="M13_News_MovieLayer_BuyTicket";break;case"searchShowtimes":o="M13_News_MovieLayer_SerachShowtimes";break}break;case"M08_Movie_Overview":switch(i){case"display":o="M08_Movie_Overview_MovieLayer_Display";break;case"buyTicket":o="M08_Movie_Overview_MovieLayer_BuyTicket";break;case"searchShowtimes":o="M08_Movie_Overview_MovieLayer_SerachShowtimes";break}break;case"M11_TwitterIndex":switch(i){case"display":o="M11_TwitterIndex_MovieLayer_Display";break;case"buyTicket":o="M11_TwitterIndex_MovieLayer_BuyTicket";break;case"searchShowtimes":o="M11_TwitterIndex_MovieLayer_SerachShowtimes";break}break;case"M13_MovieLayer_Other":switch(i){case"display":o="M13_MovieLayer_Other_Display";break;case"buyTicket":o="M13_MovieLayer_Other_BuyTicket";break;case"searchShowtimes":o="M13_MovieLayer_Other_SerachShowtimes";break}break}if(typeof(tracker)!=="undefined"){tracker.trackClick(p,o)}},closeCard:function(){if(this.collectBoxId){this.collectBoxId.stopObserving("mouseover",this.overCollectBoxIdHandler);this.collectBoxId.stopObserving("mouseout",this.outCollectBoxIdHandler)}this.collectBoxId=null;this.collectBox.close()},closed:false,close:function(){if(!this.closed){this.closed=true;this.destroyEvent();this.destroyDOM();this.information=null}}});if(typeof(Weibo)=="undefined"){var Weibo=Class.create()}Weibo.PopupUtil=(function(){var a={};a.LoadEditorJs=function(b){if(!Weibo.Editor||!Weibo.Face||!Weibo.Image||!Weibo.Sync||!Weibo.Syntax||!Weibo.Topic||!Weibo.Video||!Weibo.MovieLinker){if(debug){$loadJs(["/js/2011/weibo/editor/editor.js","/js/2011/weibo/editor/image.js","/js/2011/weibo/editor/face.js","/js/2011/weibo/editor/sync.js","/js/2011/weibo/editor/syntax.js","/js/2011/weibo/editor/movieLinker.js","/js/2011/weibo/editor/video.js","/js/2011/weibo/editor/topic.js"],function(){b()})}else{$loadJs("/js/2011/weiboEditor.js",function(){b()})}}else{b()}};var d=Class.create();Object.extend(Object.extend(d.prototype,Window.TooltipWindow.prototype),{addDOM:function(){var b='<div class="eject_outer" style="position: absolute;display:none; "><div class="eject"><p class="directiontag"></p>{0}</div></div>';this.windowElement=Builder.build(String.format(b,this.tipContent))}});a.Tip=function(c,b,f){return new d({element:c,tipContent:b,zIndex:f})};a.Dialog=Class.create();Object.extend(Object.extend(a.Dialog.prototype,Dialog.prototype),{addOverlay:function(){if(typeof this.uniqueId=="undefined"){this.uniqueId=new Date().getTime()}var f="overlay"+this.uniqueId;this.overlay=$(f);if(!this.overlay){var b=this.getContainer();var c=Element.extend(document.createElement("div"));c.id=f;c.setStyle({background:"#000000",filter:"alpha(opacity=80)",opacity:0.8,zoom:1,zIndex:Windows.getZIndex(),position:"absolute",margin:"0px",padding:"0px",top:"0px",left:"0px",width:this.pageDimensions.width+"px",height:this.pageDimensions.height+"px"});b.appendChild(c);this.overlay=c}}});return a})();Weibo.GroupUtil=(function(){var a={};var d=function(h,c,g,b){Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService",g,h,c,"/Service/Twitter.msi","get","20000",b)};a.add=function(f,c,b){return d([f],c,"CreateTwitterGroup",b)};a.del=function(f,c,b){return d([f],c,"DeleteTwitterGroup",b)};a.update=function(g,h,c,b){return d([g,h],c,"UpdateTwitterGroup",b)};a.order=function(f,c,b){return d([f],c,"MoveGroupRank",b)};a.groups=function(c,b){if(typeof(scope)!="undefined"&&scope.groups){c&&c()}else{d(null,function(f){if(f&&f.value){typeof(scope)!="undefined"||(scope={});scope.groups=f.value;c&&c(f.value)}},"GetTwitterFollowGroupInfo",b)}};return a})();Weibo.FollowUtil=(function(){var a={};var d=function(h,c,g,b){Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService",g,h,c,"/Service/Twitter.msi","get","20000",b)};a.updateGroup=function(h,g,c,b){return d([h,g],c,"UpdateGroupIdsForFTwitter",b)};a.updateRemark=function(h,g,c,b){return d([h,g],c,"UpdateRemarkForFTwitter",b)};a.updateRemarkAndGroups=function(j,h,i,c,b){return d([j,h,i],c,"UpdateRemarkAndGroups",b)};a.getGroupInfo=function(f,c,b){return d([f],c,"GetFTwitterFollowGroupInfo",b)};return a})();Weibo.Dialog=Class.create();Object.extend(Weibo.Dialog.prototype,{options:{},initialize:function(b){this.setOptions(b);this.initializeDom()},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},setCursor:function(h,g,e){g=(g==null?h.value.length:g);e=(e==null?0:e);h.focus();if(h.createTextRange){var f=h.createTextRange();f.move("character",g);f.moveEnd("character",e);f.select()}else{h.setSelectionRange(g,g+e)}},initializeDom:function(){},onReady:function(b){},initializeEvent:function(){},onSubmit:function(){this.callback&&this.callback();this.close()},close:function(){this.dialog&&this.dialog.close();this.destroyEvent();this.destroyDOM();this.destroyField()},destroyField:function(){},destroyEvent:function(){},destroyDOM:function(){}});Weibo.FollowSuccDialog=Class.create();Object.extend(Object.extend(Weibo.FollowSuccDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,groupTemplate:'<input name="groupname" class="mr6" type="checkbox" value="#{id}" #{belonged}><label for="groupname">#{name}</label>',dialogTemplate:'<div><p class="clearfix"><span id="title"></span><span class="fr ico_twen" id="help" title="帮助">&nbsp;</span></p><div class="tip_foculist"><ul class="clearfix" id="groups"></ul></div><p class="mt15"><a href="#" onclick="return false;" id="newgroup"><span class="ico_tadd mr6">+</span> 创建分组</a></p><p class="mt5 box_yellow" id="addgroupcontainer"><input name="listname" type="text" class="t_text" id="groupname"><input name="" id="addgroup" type="submit" value="创建" class="btn_gray2 mlr10"><a href="#" onclick="return false;" id="canceladd">取消</a></p><p class="mt9  clearfix"><label for="remarkName" class="fl  mt3">备注姓名：</label><input name="remarkname" type="text" class="t_text w200" id="remarkname"></p></div>',helpTemplate:'<ul><li><span class="song">·</span>在首页可以按规定的分组查看微评</li><li class="mt6"><span class="song">·</span>将已经关注的人进行分组，方便管理</li><li class="mt6"><span class="song">·</span>分组信息是保密的，只有自已可见</li></ul>'},initialize:function(b){this.setOptions(b);if(this.groups&&this.groups.length>0){this.initializeDom()}else{Weibo.FollowUtil.getGroupInfo(this.user.id,function(a){if(a&&a.value){this.groups=a.value;this.initializeDom()}}.bind(this))}},initializeDom:function(){this.dialog=new Dialog({title:"关注成功!",windowClassName:"w420",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(d){this.submitBtn=d.buttonNodes[0];d.getEl("title").innerHTML="为“"+this.user.name+"”选择分组：";this.cancelAdd=d.getEl("canceladd");this.groupul=d.getEl("groups");var i=[];var l=new Template("<li>"+this.groupTemplate+"</li>");for(var j=0,k=this.groups.length,h;j<k;++j){h=this.groups[j];i.push(l.evaluate({id:h.id,name:h.name,belonged:(h.belonged?' checked="checked" ':' "" ')}))}this.groupul.innerHTML=i.join("");if(this.groups.length>16){this.groupul.up().setStyle({height:"235px",overflowX:"hidden",overflowY:"auto"})}this.newGroupButton=d.getEl("newgroup");this.addGroupButton=d.getEl("addgroup");this.addGroupContainer=d.getEl("addgroupcontainer");this.addGroupContainer.hide();this.groupnameInput=d.getEl("groupname");this.helpButton=d.getEl("help");this.remarkNameInput=d.getEl("remarkname");this.helpTip=Weibo.PopupUtil.Tip(this.helpButton,this.helpTemplate,10000);this.initializeEvent()},initializeEvent:function(){this.onAddGroupHandler=this.onAddGroup.bind(this);Event.observe(this.addGroupButton,"click",this.onAddGroupHandler);this.onCancelAddHandler=this.onCancelAdd.bind(this);Event.observe(this.cancelAdd,"click",this.onCancelAddHandler);this.onNewGroupHandler=this.onNewGroup.bind(this);Event.observe(this.newGroupButton,"click",this.onNewGroupHandler)},onSubmit:function(){var j=$$('input[name="groupname"]',this.groupul);var k=[];for(var g=0,h=j.length,i;g<h;++g){i=j[g];if(i.checked){k.push(i.value)}}var l=this.remarkNameInput.value;if(k.length>0||l.length>0){Weibo.FollowUtil.updateRemarkAndGroups(this.user.id,k.join(","),l.trim(),function(a){if(a&&a.value){this.close();this.callback&&this.callback(k,l)}}.bind(this),this.submitBtn)}else{this.close();this.callback&&this.callback(k,l)}},onCancel:function(){this.close()},getXY:function(h){var i=0,j=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;i=a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft;j=a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop}else{for(;h!=document.body;i+=h.offsetLeft,j+=h.offsetTop,h=h.offsetParent){}}return{x:i,y:j}},onShowHelp:function(c){var d=this.getXY(this.helpButton);this.helpDiv.style.left=d.x+30+"px";this.helpDiv.style.top=d.y-55+"px";this.helpDiv.show()},onHideHelp:function(b){this.helpDiv.hide()},onNewGroup:function(b){this.newGroupButton.hide();this.addGroupContainer.show();this.groupnameInput.value=""},onCancelAdd:function(b){this.newGroupButton.show();this.addGroupContainer.hide()},onAddGroupErrorCheck:function(d){var c=null;switch(d.value.groupId){case 0:c="创建分组失败,只能输入英文字母和汉字";break;case -1:c="创建分组失败,分组数量已达上限";break;case -2:c="创建分组失败";break;case -3:c="创建分组失败,分组名称已存在";break}if(c){$alert(c,null,null,4);return false}else{return true}},onAddGroup:function(d){var e=this.groupnameInput.value;var f=Math.ceil(e.bytelength()/2);if(f>0&&f<=10){Weibo.GroupUtil.add(e,function(c){if(c&&Mtime.isValue(c.value)&&this.onAddGroupErrorCheck(c)){this.groupnameInput.value="";var a=c.value.groupId;var b=$(Builder.node("li"));this.groupul.appendChild(b);b.innerHTML=new Template(this.groupTemplate).evaluate({id:a,name:e});this.newGroupButton.show();this.addGroupContainer.hide()}}.bind(this),this.addGroupButton)}else{$alert("请确定分组名不超过20个字符，10个汉字",null,null,4)}},destroyEvent:function(){Event.stopObserving(this.addGroupButton,"click",this.onAddGroupHandler)},destroyDOM:function(){if(this.helpTip){this.helpTip.close();this.helpTip=null}},destroyField:function(){this.onAddGroupHandler=null;this.helpTip=null;this.groupul=null;this.addGroupButton=null;this.groupnameInput=null;this.helpButton=null;this.remarkNameInput=null;this.dialog=null}});Weibo.AddOrUpdateGroupDialog=Class.create();Object.extend(Object.extend(Weibo.AddOrUpdateGroupDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,dialogTemplate:'<div><div class="clearfix"><label for="groupname" class="fl mt3">分组名：</label><span class="fl"><input name="groupname" id="groupname" type="text" class="t_text w155"><br><span class="c_666">不能超过20个字符，10个汉字</span></span></div></div>'},initializeDom:function(){this.dialog=new Dialog({title:(!!this.group?"修改分组":"创建分组"),windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"保存",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.groupnameInput=b.getEl("groupname");if(!!this.group){this.groupnameInput.value=this.group.name}this.initializeEvent()},initializeEvent:function(){},onAddGroupErrorCheck:function(d){var c=null;switch(d.value.groupId){case 0:c="创建分组失败,只能输入英文字母和汉字";break;case -1:c="创建分组失败,分组数量已达上限";break;case -2:c="创建分组失败";break;case -3:c="创建分组失败,分组名称已存在";break}if(c){$alert(c,null,null,4);return false}else{return true}},onUpdateGroupErrorCheck:function(d){var c=null;switch(d.value){case 0:c="创建分组失败,只能输入英文字母和汉字";break;case -1:case -2:c="创建分组失败";break;case -3:c="创建分组失败,分组名称已存在";break}if(c){$alert(c,null,null,4);return false}else{return true}},onSubmit:function(){this.groupname=this.groupnameInput.value;var b=Math.ceil(this.groupname.bytelength()/2);if(b>0&&b<=10){if(!!this.group){if(this.groupnameInput.value==this.group.name){this.close();return}Weibo.GroupUtil.update(this.group.id,this.groupname,function(a){if(a&&Mtime.isValue(a.value)&&this.onUpdateGroupErrorCheck(a)){this.saveCallback()}}.bind(this),this.submitBtn)}else{Weibo.GroupUtil.add(this.groupname,function(a){if(a&&a.value&&this.onAddGroupErrorCheck(a)){this.saveCallback(a.value.groupId)}}.bind(this),this.submitBtn)}}else{$alert("请确定分组名不超过20个字符，10个汉字",null,null,4)}},saveCallback:function(b){if(this.group){this.group.name=this.groupname}else{this.group={id:b,name:this.groupname}}this.close();this.callback&&this.callback(this.group)},destroyField:function(){this.groupnameInput=null;this.dialog=null}});Weibo.BlackDialog=Class.create();Object.extend(Object.extend(Weibo.BlackDialog.prototype,Weibo.Dialog.prototype),{server:{black:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","AddToBlackList",[f],e,"/Service/Twitter.msi","get","20000",d)}},options:{callback:null,dialogTemplate:'<div><dl class="clearfix"><dt class="fl"><span class="t_worning"></span></dt><dd class="fl w295 ml15"><h4 class="px14">确认将“<span id="blackName"></span>”加入到我的黑名单中吗？</h4><p class="mt5 c_666">你和他将自动解除关注关系，并且他不能在关注你，他不能再给你发评论、私信、@通知</p></dd></dl></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w425",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];b.getEl("blackName").innerHTML=this.person.nickName;this.initializeEvent()},blackErrorCheck:function(d){var c=null;switch(d.value){case -1:c="加入黑名单失败,黑名单已满";break;case 1:c=null;break;default:c="加入黑名单失败";break}if(c){$alert(c,null,null,4);return false}else{return true}},onSubmit:function(){this.server.black(this.person.userId,function(b){if(b&&Mtime.isValue(b.value)&&this.blackErrorCheck(b)){this.close();this.callback&&this.callback()}}.bind(this),this.submitBtn)},onCancel:function(){this.close()}});Weibo.DeleteGroupDialog=Class.create();Object.extend(Object.extend(Weibo.DeleteGroupDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,group:{id:1,name:"Mtime"},dialogTemplate:'<div><h4 class="px14 tc">确定要删除“<span id="groupname"></span>”分组吗？</h4><p class="c_666 mt5 tc">此分组下的人不会被取消关注</p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];b.getEl("groupname").innerHTML=this.group.name;this.initializeEvent()},onSubmit:function(){Weibo.GroupUtil.del(this.group.id,this.deleteCallback.bind(this),this.submitBtn)},deleteCallback:function(b){if(b&&b.value){this.close();this.callback&&this.callback(this.group)}},onCancel:function(){this.close()}});Weibo.RemoveReplyDialog=Class.create();Object.extend(Object.extend(Weibo.RemoveReplyDialog.prototype,Weibo.Dialog.prototype),{server:{black:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","AddToBlackList",[f],e,"/Service/Twitter.msi","get","20000",d)},DeleteTweetComment:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","DeleteTweetComment",[f],e,"/Service/Twitter.msi","get","20000",d)}},options:{ftwitterid:null,tweetCommentId:null,isShowBlack:true,dialogTemplate:'<div><h4 class="px14 tc">确定要删除该回复吗？</h4><p class="c_666 mt5 tc" _type="blackCtn"><input name="isblack" id="isblack" type="checkbox" value=""><label>同时将此用户加入黑名单</label></p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.blackCtn=b.windowElement.down('p[_type="blackCtn"]');if(this.isShowBlack){this.blackCtn.show();this.isBlackInput=b.getEl("isblack")}else{this.blackCtn.hide()}this.initializeEvent()},blackErrorCheck:function(d){var c=null;switch(d.value){case -1:c="加入黑名单失败,黑名单已满";break;case 1:c=null;break;default:c="加入黑名单失败";break}if(c){$alert(c,null,null,4);return false}else{return true}},onSubmit:function(){this.server.DeleteTweetComment(this.tweetCommentId,function(b){if(b&&b.value){if(this.isShowBlack&&this.isBlackInput.checked){this.server.black(this.ftwitterid,function(a){if(a&&Mtime.isValue(a.value)&&this.blackErrorCheck(a)){}this.close();this.callback&&this.callback()}.bind(this),this.submitBtn)}else{this.close();this.callback&&this.callback()}}else{$alert("删除回复失败",null,null,4)}}.bind(this),this.submitBtn)},onCancel:function(){this.close()},destroyField:function(){this.isBlackInput=null;this.dialog=null}});Weibo.UpdateRemarkDialog=Class.create();Object.extend(Object.extend(Weibo.UpdateRemarkDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,dialogTemplate:'<div><p>给朋友加个备注名，方便认出他是谁</p><p class="mt5 clearfix"><input type="text" id="remark" name=""></p><p class="mt5 c_666">不能超过20个字符，10个汉字</p></div>'},initializeDom:function(){this.dialog=new Dialog({title:!!this.user.remark?"修改备注":"添加备注",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.remarkInput=b.getEl("remark");this.remarkInput.value=!!this.user.remark?this.user.remark:"";this.initializeEvent()},initializeEvent:function(){},onSubmit:function(){var d=this.remarkInput.value;var c=Math.ceil(d.bytelength()/2);if(c>=0&&c<=10){Weibo.FollowUtil.updateRemark(this.user.id,d,function(a){if(a&&a.value){this.close();this.callback&&this.callback(d)}}.bind(this),this.submitBtn)}else{$alert("备注过长,请修改后提交",null,null,4)}},onCancel:function(){this.close()},destroyField:function(){this.remarkInput=null;this.dialog=null}});Weibo.RTSuccessDialog=Class.create();Object.extend(Object.extend(Weibo.RTSuccessDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,dialogTemplate:'<div><p class="tc bold pt20 px14"><span class="ico_tright">&nbsp;</span> 转发成功</p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.initializeEvent()},initializeEvent:function(){},onCancel:function(){this.close()}});Weibo.RepeatRTDialog=Class.create();Object.extend(Object.extend(Weibo.RepeatRTDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,dialogTemplate:'<div><p class="tc px14 bold pt20"><span class="t_worning" style="vertical-align:bottom">&nbsp;</span> 已经转发了,请不要在重复转发!</p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.initializeEvent()},initializeEvent:function(){},onCancel:function(){this.close()}});Weibo.SendMessageDialog=Class.create();Object.extend(Object.extend(Weibo.SendMessageDialog.prototype,Weibo.Dialog.prototype),{server:{search:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTwitterUserList",f,e,"/Service/Twitter.msi","get","20000",d)},sendUserMessageToNickName:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.MessageService","SendUserMessageToNicknameCrossDomainByFlash",e,d,"/Service/Message.msi","post","20000",f)}},options:{callback:null,timer:0.5,dialogTemplate:'<div><ul class="t_message"><li><label class="t_txt">收件人：</label><input type="text" class="t_text w295" name="nickname" id="nickname" /><ul class="t_message_box" id="nicknamelist"></ul></li><li class="clearfix mt12"><div class="fr c_orange" id="feedback"></div></li><li class="mt6"><label class="t_txt">内&nbsp;&nbsp;&nbsp;容：</label><textarea name="editor" id="editor" cols="" rows="9" class="wp99"></textarea></li></ul></div>'},initializeDom:function(){this.dialog=new Dialog({title:"发消息",windowClassName:"w580",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"发送",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},getXY:function(h){var i=0,j=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;i=a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft;j=a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop}else{for(;h!=document.body;i+=h.offsetLeft,j+=h.offsetTop,h=h.offsetParent){}}return{x:i,y:j}},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.nicknameInput=b.getEl("nickname");this.faceButton=b.getEl("face");this.feedback=b.getEl("feedback");this.editorInput=b.getEl("editor");setTimeout(function(){this.setCursor(this.editorInput)}.bind(this),500);Weibo.PopupUtil.LoadEditorJs(function(){this.editor=new Weibo.Editor({editor:this.editorInput,notShortUrl:true});this.editorFeedback=new Weibo.Feedback({editor:this.editor,digitFeedback:{target:this.feedback,normalTemplate:"还可以输入{2}个汉字",warnTemplate:'<span style="color:red"><strong>还可以输入{2}个汉字</strong></span>'}})}.bind(this));if(!!this.user){this.nicknameInput.value=this.user.nickname}this.nicknameList=b.getEl("nicknamelist");this.nicknameList.up().style.zIndex=10000;this.nicknameList.hide();this.nicknameAutoComplete=new SearchAutoComplete({text:this.nicknameInput,textWatermarkText:"请输入会员昵称",listRegion:this.nicknameList,itemTemplate:'<li value="#{Id}" title="#{Nickname}"><a href="#" onclick="return false;" value="#{Id}">#{Nickname}</a></li>',idFieldName:"Id",titleFieldName:"Nickname",searchDatas:null,getSearchDataCallback:function(a){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(this.search.bind(this,a),this.timer*1000)}.bind(this),choiceCount:8,onChangeInputCallback:null,onChangeCallback:null,onEnterCallback:null});this.initializeEvent()},initializeEvent:function(){},getError:function(c){var d=null;switch(c){case 0:d="未登录";break;case 10:d="对方拒收信件";break;case 1:d=null;break;case 6:d="收信人不能是你自已";break;case 9:d="对方拒绝接收此类型消息";break;case 12:d="验证码错误";break;case 14:d="内容中含不允许发送的关键字";break;case 15:d="标题中含不允许发送的关键字";break;case 20:d="标题为空";break;case 21:d="内容为空";break;case 22:d="未找到接收用户";break;case 23:d="信息内容长度超过限制";break;case 24:d="发送太频繁，请休息一下";break;default:d="未知错误码："+c;break}if(d){$alert(d,null,null,4);return false}else{return true}},search:function(b){this.server.search([this.nicknameInput.value],function(a){if(a&&a.value){b(a.value)}}.bind(this))},onSubmit:function(){var b=this.editor.getLength();if(this.nicknameInput.value.length>0&&b>0&&b<=this.editor.lengthExp.max){this.server.sendUserMessageToNickName([this.nicknameInput.value,this.editorInput.value],function(a){if(!a){$alert("操作失败，请重试。");return}if(!a.error&&this.getError(a.value)){$alert('<span class="ico_tright">&nbsp;</span> 发送成功',null,null,2);this.close();this.callback&&this.callback()}}.bind(this),this.submitBtn)}else{if(this.nicknameInput.value.length==0){$alert("请输入收件人.",null,null,2)}else{if(b==0){$alert("请输入信息内容.",null,null,2)}else{$alert("信息内容长度超过限制.",null,null,2)}}}},onCancel:function(){this.editor.destroy();this.editor=null;this.dialog.close()},close:function(){if(this.editor){this.editor.destroy();this.editor=null}this.dialog&&this.dialog.close();this.destroyEvent();this.destroyDOM();this.destroyField()},destroyDOM:function(){this.nicknameList&&this.nicknameList.remove()},destroyField:function(){this.nicknameAutoComplete&&(this.nicknameAutoComplete=null);this.nicknameList&&(this.nicknameList=null);this.nicknameInput=null;this.faceButton=null;this.feedback=null;this.dialog=null}});Weibo.GroupRecommendDialog=Class.create();Object.extend(Object.extend(Weibo.GroupRecommendDialog.prototype,Weibo.Dialog.prototype),{server:{getUserJoinedGroups:function(c,d){Mtime.Component.Ajax.callBack("Mtime.MemberCenter.Pages.GroupService","GetUserJoinedGroups",[],c,"/service/group.mc","get","20000",d)}},options:{groups:null,callback:null,dialogTemplate:'<div><p>小提示：</p><p class="line_both mt6">&nbsp;</p><p class=" mt6">请推送到与你日志主题最为接近的群组，最多2个</p><p class="mt6"><input name="groupname" type="text" id="groupname" class="t_text" style="width:280px;" value=""></p><div class="t_glisthidden"><ul class="clearfix col2 mt6" id="groupul"></ul></div><p class="c_red tc mt15">推荐到群组功能需要消耗1个积分</p><p class="mt15">已选群组：</p><p class="line_solid mt6">&nbsp;</p><ul id="selectedGroupUl"></ul></div>',groupTemplate:new Template('<li groupid="#{Id}" groupname="#{Title}"><input type="checkbox" value="#{Id}" name="groupnames" class="mr6"><label for="groupnames">#{Title}</label></li>'),selectedGroupTemplate:new Template('<li class="mt6" groupid="#{Id}" groupname="#{Title}"><input type="checkbox" checked="checked" value="#{Id}" class="mr6"><label>#{Title}</label></li>'),RECOMMEND_GROUP_MAXCOUNT:2},initializeDom:function(){this.dialog=new Dialog({title:"推荐到群组",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(d){var f=d.titleBar.down("h2");var e=Builder.build('<span class="ml15 ico_twen" title="名词解番">&nbsp;</span>');if(f){f.appendChild(e)}this.descTip=Weibo.PopupUtil.Tip(e,"<p>你可以同时将此日志推送到你的群组中，与更多朋友一起分享！</p>",10000);this.groupnameInput=d.getEl("groupname");this.groupul=d.getEl("groupul");if(this.groups){this.editModel=true}this.selectedGroupUl=d.getEl("selectedGroupUl");this.selectHandler=this.select.bind(this);this.server.getUserJoinedGroups(function(l){if(l&&l.value){var c=l.value.List;if(c&&c.length>0){this.searchBox=new SearchBox({textId:this.groupnameInput,textWatermarkText:"请输入群组名称进行搜索",resultRegionId:this.groupul,itemTemplate:this.groupTemplate,searchDatas:c,onClickResultRegion:this.selectHandler});if(this.groups){for(var i=0,k=this.groups.length,b,a;i<k;++i){b=this.groups[i];a=this.groupul.down('li[groupid="'+b.Id+'"]');if(a){this.searchBox.removeSearchData(a,b.Id);this.selectedGroupUl.appendChild(Builder.build(this.selectedGroupTemplate.evaluate(b)))}}}}}}.bind(this));this.cancelSelectHandler=this.cancelSelect.bind(this);this.initializeEvent()},initializeEvent:function(){Event.observe(this.selectedGroupUl,"click",this.cancelSelectHandler)},onSubmit:function(){var f=[];var j=$$("li",this.selectedGroupUl);if((j.length>0&&j.length<=2)||this.editModel){for(var g=0,h=j.length,i;g<h;++g){i=j[g];f.push({Id:i.getAttribute("groupid"),Title:i.getAttribute("groupname")})}this.close();this.callback&&this.callback(f)}},onCancel:function(){this.close()},destroyEvent:function(){this.descTip&&this.descTip.dispose()},destroyField:function(){this.groupnameInput=null;this.groupul=null;this.descTip=null},cancelSelect:function(h){var i=Event.element(h);if(i.tagName.toLowerCase()!="li"){i=i.up("li")}if(i&&i.hasAttribute("groupid")){var e=i.down("input");var k=i.getAttribute("groupid");var l=i.getAttribute("groupname");var j={Id:k,Title:l};this.searchBox.addSearchData(j);i.remove()}},select:function(h){var i=Event.element(h);if(i.tagName.toLowerCase()!="li"){i=i.up("li")}if(i&&i.hasAttribute("groupId")){var e=i.down("input");var k=i.getAttribute("groupid");var l=i.getAttribute("groupname");if($$("li",this.selectedGroupUl).length<this.RECOMMEND_GROUP_MAXCOUNT){var j={Id:k,Title:l};this.searchBox.removeSearchData(i,k);this.selectedGroupUl.appendChild(Builder.build(this.selectedGroupTemplate.evaluate(j)))}else{if(e.checked){e.checked=false}}}}});Weibo.GroupOrderDialog=Class.create();Object.extend(Object.extend(Weibo.GroupOrderDialog.prototype,Weibo.Dialog.prototype),{server:{order:function(f,e,d){return appManager.$callback("/Service/Twitter.mt",f,e,d,"MovieGroupRank")}},options:{callback:null,selected:0,groupTemplate:'<li class="#{class}"><a href="#" onclick="return false;" idx="#{idx}">#{name}</a></li>',dialogTemplate:'<div><p class="mt9">分组名</p><p class="mt6 line_solid">&nbsp;</p><div class="clearfix"><ul class="t_gedit" id="group"></ul><div class="t_geditbar"> <span class="ico_twup" title="上移" id="up">&nbsp;</span> <span class="ico_twdown" title="下移" id="down">&nbsp;</span> </div></div></div>'},initializeDom:function(){this.dialog=new Dialog({title:"调整分组顺序",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){Weibo.GroupUtil.groups(function(){this.groups=scope.groups.clone();this.groupul=b.getEl("group");this.submitBtn=b.buttonNodes[0];this.upbtn=b.getEl("up");this.downbtn=b.getEl("down");this.renderGroup();this.initializeEvent()}.bind(this),null)},initializeEvent:function(){this.upHandler=this.up.bind(this);this.downHandler=this.down.bind(this);this.selectHandler=this.select.bind(this);Event.observe(this.upbtn,"click",this.upHandler);Event.observe(this.downbtn,"click",this.downHandler);Event.observe(this.groupul,"click",this.selectHandler)},select:function(c){var d=Event.element(c);this.selected=parseInt(d.getAttribute("idx"));this.renderGroup()},up:function(){var f,d=this.groups[this.selected];if(this.selected==0){d=this.groups.shift();this.groups.push(d);f=this.groups.length-1}else{f=this.selected-1;var e=this.groups[f];this.groups.splice(this.selected,1,this.groups.splice(f,1,d)[0])}this.selected=f;this.renderGroup()},down:function(){var d,c=this.groups[this.selected];if(this.selected==this.groups.length-1){c=this.groups.pop();this.groups.unshift(c);d=0}else{d=this.selected+1;this.groups.splice(this.selected,1,this.groups.splice(d,1,c)[0])}this.selected=d;this.renderGroup()},renderGroup:function(){var g=[];for(var h=0,i=this.groups.length,j=new Template(this.groupTemplate),f;h<i;h++){f=Object.clone(this.groups[h]);f.idx=h;if(this.selected==h){f["class"]="on"}g.push(j.evaluate(f))}this.groupul.innerHTML=g.join("")},onSubmit:function(){var f=[];for(var g=0,h=this.groups.length,e;g<h;++g){e=this.groups[g];f.push(e.id)}Weibo.GroupUtil.order(f.join(","),this.orderCallback.bind(this),this.submitBtn)},orderCallback:function(b){if(b&&b.value){this.close();scope.groups=this.groups;this.callback&&this.callback(this.groups)}},onCancel:function(){this.close()},destroyEvent:function(){Event.stopObserving(this.upbtn,"click",this.upHandler);Event.stopObserving(this.downbtn,"click",this.downHandler);Event.stopObserving(this.groupul,"click",this.selectHandler)},destroyField:function(){this.upHandler=null;this.downHandler=null;this.selectHandler=null;this.groupul=null;this.upbtn=null;this.downbtn=null}});Weibo.DadgeDialog=Class.create();Object.extend(Object.extend(Weibo.DadgeDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,dadge:{id:1,name:"手机达人",desc:"邀请10人开通微评并绑定手机，即可获得这枚勋章。现在就去邀请",time:new Date()},dialogTemplate:'<div><div class="p12 bg_e8e8e8"><p class="tc"><span class="ico_tele"></span></p><p class="tc c_green mt9" id="time"></p></div><p class="tc p12" id="desc"></p><p class="tc"><span class="ico_set"></span><a class="c_000" href="#">显示设置</a></p></div>'},initializeDom:function(){this.dialog=new Dialog({title:this.dadge.name,windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"查看我的勋章",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){b.getEl("desc").innerHTML=this.dadge.desc;b.getEl("time").innerHTML="于 "+this.dadge.time.toString()+" 获得";this.initializeEvent()},initializeEvent:function(){},onCancel:function(){this.close()}});Weibo.RTDialog=Class.create();Object.extend(Object.extend(Weibo.RTDialog.prototype,Weibo.Dialog.prototype),{server:{GetTweetRenderHtml:function(d,c){Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTweetRenderHtml",d,c,"/Service/Twitter.msi","get","20000")},GetForwardToFriendTweetRender:function(d,c){Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetForwardToFriendTweetRender",d,c,"/Service/Twitter.msi","get","20000")},ForwardTweet:function(f,e,d){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.TwitterService","ForwardTweetCrossDomainByFlash",f,e,"/Service/Twitter.msi","post","20000",d)},searchNickname:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTwitterUserList",d,c,"/Service/Twitter.msi","get","20000")},sendUserMessageToNickName:function(e,d,f){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.MessageService","SendUserMessageToNicknameCrossDomainByFlash",e,d,"/Service/Message.msi","post","20000",f)}},options:{callback:null,channel:"weibo",tweetId:null,timer:1,friendTweetContent:"",dialogTemplate:'<div><div class="my_ttab"><ul class="clearfix"><li class="on"><a href="#" onclick="return false;" id="weibort">转发到微评</a><span></span></li><li class=""><a href="#" onclick="return false;" id="friendrt">消息给好友</a><span></span></li></ul></div><p class="line_both">&nbsp;</p><div class="bg_fff p12 mt12 wbr" id="weibortc" style=""></div><ul class="t_message" id="friendrtc" style="display: none; "><li class="mt15"><label class="t_txt mt3">收件人：</label><input type="text" name="" class="t_text w200" _type="nickname"><ul class="t_message_box" _type="nicknamelist"></ul></li></ul><ul class="t_message"><li class="mt15 clearfix"><div class="fl" id="face"><span class="select_faces mr3" style="display:inline-block;"></span>&nbsp;表情</div><div id="feedback" class="fr c_orange"></div></li><li class="mt9"><label class="t_txt">内&nbsp;&nbsp;&nbsp;容：</label><textarea id="editor" class="wp99" rows="6" cols="" name=""></textarea><div id="isReplyCtn"><p class="mt6"><input type="checkbox" class="mr6" id="isReply" />同时回复给&nbsp;原作者</p></div></li></ul></div>'},initializeDom:function(){this.dialog=new Dialog({title:"",windowClassName:"w580",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"发送",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.weibortButton=b.getEl("weibort");this.friendrtButton=b.getEl("friendrt");this.weibortContainer=b.getEl("weibortc");this.friendrtContainer=b.getEl("friendrtc");this.faceBtn=b.getEl("face");this.editorInput=b.getEl("editor");this.isReply=b.getEl("isReply");this.isReplyCtn=b.getEl("isReplyCtn");Weibo.PopupUtil.LoadEditorJs(function(){this.editor=new Weibo.Editor({editor:this.editorInput});setTimeout(function(){this.setCursor(this.editor.editor)}.bind(this),500);this.editorFeedback=new Weibo.Feedback({editor:this.editor,digitFeedback:{target:b.getEl("feedback"),normalTemplate:"<span>{0}</span>/<strong>{1}</strong>字",warnTemplate:'<span style="color:red">{0}</span>/<strong>{1}</strong>字'}});new Weibo.AtSyntax({editor:this.editor});new Weibo.MovieSyntax({editor:this.editor});new Weibo.Face({editor:this.editor,addButton:this.faceBtn})}.bind(this));this.nicknameInput=this.friendrtContainer.down('input[_type="nickname"]');this.nicknameList=this.friendrtContainer.down('ul[_type="nicknamelist"]');this.nicknameList.up().style.zIndex=10;this.nicknameList.hide();this.nicknameAutoComplete=new SearchAutoComplete({text:this.nicknameInput,listRegion:this.nicknameList,itemTemplate:'<li value="#{Id}" title="#{Nickname}"><a href="#" onclick="return false;" value="#{Id}">#{Nickname}</a></li>',idFieldName:"Id",titleFieldName:"Nickname",searchDatas:null,getSearchDataCallback:function(a){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(this.searchNickname.bind(this,a),this.timer*1000)}.bind(this),choiceCount:8,onChangeInputCallback:null,onChangeCallback:null,onEnterCallback:null});this.switchChannel();this.renderTweet();this.renderFriendTweet();this.initializeEvent()},initializeEvent:function(){this.switchWeiboChannelHandler=this.switchChannel.bind(this,"weibo");this.switchFriendChannelHandler=this.switchChannel.bind(this,"friend");Event.observe(this.weibortButton,"click",this.switchWeiboChannelHandler);Event.observe(this.friendrtButton,"click",this.switchFriendChannelHandler)},searchNickname:function(b){this.server.searchNickname([this.nicknameInput.value],function(a){if(a&&a.value){b(a.value)}}.bind(this))},renderFriendTweet:function(){this.server.GetForwardToFriendTweetRender([this.tweetId],function(b){if(b&&b.value){this.friendTweetContent="转发微评"+b.value}}.bind(this))},onWeiboErrorCheck:function(d){var c=null;switch(d.value){case -5:c="原作者微评正在审核中，如有不便敬请谅解!";break;case -9:case -4:case -3:case -2:case 0:c="转发微评失败";break;case -1:c="转发微评失败,内容过长";break;case -11:c="转发微评失败,您被禁言";break;case -10:c="转发微评失败,内容包含敏感词";break;case -20:c="你发布的速度太快了，休息一下吧：）";break}if(c){$alert(c,null,null,4);return false}else{return true}},onSubmit:function(){var b=this.editor.getLength();switch(this.channel){case"weibo":if(b>=0&&b<=this.editor.lengthExp.max){if(b==0){this.editorInput.value="转发微评"}this.server.ForwardTweet([this.editorInput.value,this.tweetId,this.isReply.checked,(this.isReplyRT?this.isReplyRT.checked:false)],function(a){if(a&&a.value&&this.onWeiboErrorCheck(a)){$alert('<span class="ico_tright">&nbsp;</span> 转发成功',null,null,2);this.close();this.callback&&this.callback(a.value)}}.bind(this),this.submitBtn)}else{this.editorFeedback.flickerWarn()}break;case"friend":if(this.nicknameInput.value.length>0&&b>0&&b<=this.editor.lengthExp.max){this.server.sendUserMessageToNickName([this.nicknameInput.value,this.editorInput.value],function(a){if(!a){$alert("操作失败，请重试。");return}if(!a.error&&Mtime.isValue(a.value)&&this.sendMessageErrorCheck(a.value)){$alert('<span class="ico_tright">&nbsp;</span> 发送成功',null,null,2);this.close();this.callback&&this.callback()}}.bind(this),this.submitBtn)}else{if(this.nicknameInput.value.length==0){$alert("请输入收件人.",null,null,2)}else{if(b==0){$alert("请输入信息内容.",null,null,2)}else{$alert("信息内容长度超过限制.",null,null,2)}}}break;default:break}},sendMessageErrorCheck:function(c){var d=null;switch(c){case 0:d="未登录";break;case 10:d="对方拒收信件";break;case 1:d=null;break;case 6:d="收信人不能是你自已";break;case 9:d="对方拒绝接收此类型消息";break;case 12:d="验证码错误";break;case 14:d="内容中含不允许发送的关键字";break;case 15:d="标题中含不允许发送的关键字";break;case 20:d="标题为空";break;case 21:d="内容为空";break;case 22:d="未找到接收用户";break;default:d="未知错误码："+c;break}if(d){$alert(d,null,null,4);return false}else{return true}},onCancel:function(){this.editor.destroy();this.editor=null;this.dialog.close()},close:function(){if(this.editor){this.editor.destroy();this.editor=null}this.dialog.close()},renderTweet:function(){this.server.GetTweetRenderHtml([this.tweetId],function(d){if(d&&d.value){this.weibortContainer.innerHTML=d.value.renderHtml;if(d.value.nickname){var c=$(Builder.build(String.format('<p class="mt6"><input type="checkbox" class="mr6" />同时回复给&nbsp;{0}</p>',d.value.nickname)));this.isReplyCtn.insertBefore(c,this.isReplyCtn.firstChild);this.isReplyRT=c.down("input")}}}.bind(this))},switchChannel:function(c,d){if(c==null||this.channel!=c){!c&&(c=this.channel);this.weibortContainer.hide();this.friendrtContainer.hide();this.weibortButton.up("li").className="";this.friendrtButton.up("li").className="";switch(this.channel){case"weibo":this.weiboTweetContent=this.editorInput.value;break;case"friend":this.friendTweetContent=this.editorInput.value;break}switch(c){case"weibo":this.weibortButton.up("li").className="on";this.weibortContainer.show();this.editorInput.value=this.weiboTweetContent;this.faceBtn.show();this.isReplyCtn.show();break;case"friend":this.friendrtButton.up("li").className="on";this.friendrtContainer.show();this.editorInput.value=this.friendTweetContent;this.faceBtn.hide();this.isReplyCtn.hide();break;default:break}setTimeout(function(){this.setCursor(this.editorInput,0)}.bind(this),100);this.channel=c}},destroyEvent:function(){Event.stopObserving(this.weibortButton,"click",this.switchWeiboChannelHandler);Event.stopObserving(this.friendrtButton,"click",this.switchFriendChannelHandler)},destroyDOM:function(){},destroyField:function(){this.switchWeiboChannelHandler=null;this.switchFriendChannelHandler=null;this.weibortButton=null;this.friendrtButton=null;this.weibortContainer=null;this.friendrtContainer=null}});Weibo.InformDialog=Class.create();Object.extend(Object.extend(Weibo.InformDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,weibo:{id:1,text:"Hello MTime",user:{id:1,name:"anhulife",nick:"猫鱼酱"}},types:[{id:1,name:"违法信息"},{id:2,name:"恶意广告"},{id:3,name:"色情暴力"}],waterMarkText:"您可以详细描述恶意行为(如图片中的不良信息)",typeTemplate:'<li><input type="checkbox" name="type" value="#{id}" id="type#{id}" /><label for="type#{id}">#{name}</label></li>',dialogTemplate:'<div><p id="title"></p><p class="mt3"><textarea name="" cols="" rows="6" class="mt3 wp99" id="text" disabled="disabled"></textarea></p><p class="mt9">举报类型：</p><ul class="clearfix col3 mt6" id="type"></ul><p class="mt9">举报说明(可填)：</p><p class="mt5 clearfix  "><input type="text" value="" class="t_text" style="width:280px;" id="desc" name="desc"/></p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"举报不良信息",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(d){this.title=d.getEl("title");this.text=d.getEl("text");this.type=d.getEl("type");this.desc=d.getEl("desc");this.title.innerHTML=String.Format("你举报的{0}(@{1})的微评：",[this.weibo.user.nick,this.weibo.user.name]);var j=[];for(var g=0,h=this.types.length,i=new Template(this.typeTemplate);g<h;++g){j.push(i.evaluate(this.types[g]))}this.type.innerHTML=j.join("");this.text.value=this.weibo.text;this.desc.value=this.waterMarkText;this.waterMarkFlag=true;this.initializeEvent()},initializeEvent:function(){this.waterMarkBlur.bind(this);this.waterMarkFocus.bind(this);Event.observe(this.desc,"blur",this.waterMarkBlur.bind(this));Event.observe(this.desc,"focus",this.waterMarkFocus.bind(this))},waterMarkBlur:function(b){if(this.desc.value.length==0){this.desc.value=this.waterMarkText;this.waterMarkFlag=true}else{this.waterMarkFlag=false}},waterMarkFocus:function(b){if(this.waterMarkFlag){this.desc.value="";this.waterMarkFlag=false}},onSubmit:function(){var j=[],i=$$('input[name="type"]',this.type);for(var f=0,g=i.length,h;f<g;++f){h=i[f];if(h.checked){j.push(h.value)}}if(j.length>0){this.callback&&this.callback(j,(this.waterMarkFlag?"":this.desc.value));this.close()}},onCancel:function(){this.close()},destroyEvent:function(){},destroyDOM:function(){},destroyField:function(){}});Weibo.UserLoginDialog=Class.create();Object.extend(Object.extend(Weibo.UserLoginDialog.prototype,Weibo.Dialog.prototype),{server:{getUser:function(b){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.ManagerService","GetUserInfo2",[],b,"/utility/managerservice.m","get","10000")},signIn:function(i,l,k,j,n,m,h){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.ManagerService","SignIn",[i,l,k,j,n,m],h,"/utility/managerservice.m","get","10000")},refreshVcode:function(b){return Mtime.Component.Ajax.get("Mtime.Community.Controls.CommunityPages.ManagerService","RefreshVcode",[],b,"/utility/managerservice.m","get","10000")}},options:{callback:null,dialogTemplate:'<form><dl class="login_userinfo"><dd><label data-login="account-label">登录帐号：</label><input type="text" name="account" class="t_text w175"></dd><dd><label>登录密码：</label><input type="password" name="password" class="t_text w175"><a href="http://my.mtime.com/member/forget_password/" class="ml6">忘记密码？</a></dd><dd data-login="vcode-input-ctn" style="display: none;"><label>验证码：</label><input type="text" name="vcode" class="t_text c_a5" value="" style="width:115px;"></dd><dd data-login="vcode-image-ctn" style="display: none;"><img src="" data-login="vcode-image" class="mr12 v_m"><a href="#" onclick="return false;" data-login="vcode-refresh-btn">刷新</a></dd><dd><input type="checkbox" data-login="auto" name="" value="">下次自动登录</dd></dl><p class="tc mt15 "><input type="button" value="免费注册" data-login="signup" class="t_btn_gray_i bold mr8 "><input type="submit" data-selector="submit" value="登录" class="t_btn_blue_i bold "></p></form>'},initialize:function(b){this.setOptions(b);this.initializeUser()},initializeUser:function(){this.server.getUser(function(){if(typeof getUserInfoResult!=="undefined"&&Mtime.isValue(getUserInfoResult)){var b=getUserInfoResult.value;this.user={id:b.userId,nickname:b.nickName,homeUrl:b.homeUrl,headSrc:b.headSrc,isSaveEmail:b.isSaveEmail,isAutoExit:b.isAutoExit,email:b.email,enableMobileLogin:b.enableMobileLogin||false,customizeMenus:typeof b.CustomizeMenus==="undefined"?null:b.CustomizeMenus}}this.initializeDom()}.bind(this))},initializeDom:function(){this.dialog=new Dialog({title:"会员登录",windowClassName:"w375",content:this.dialogTemplate,readyCallback:this.onReady.bind(this)})},onReady:function(e){var f=e.windowElement;this.emailLabel=f.down('label[data-login="account-label"]');this.emailInput=f.down('input[name="account"]');this.passInput=f.down('input[name="password"]');this.isAutoSign=f.down('input[data-login="auto"]');this.signInBtn=f.down('input[data-selector="submit"]');this.signUpBtn=f.down('input[data-login="signup"]');this.vcodeInputCtn=f.down('dd[data-login="vcode-input-ctn"]');this.vcodeInput=f.down('input[name="vcode"]');this.vcodeImageCtn=f.down('dd[data-login="vcode-image-ctn"]');this.vcodeImage=f.down('img[data-login="vcode-image"]');this.vcodeRefreshBtn=f.down('a[data-login="vcode-refresh-btn"]');this.form=f.down("form");e.buttonRegion.hide();var d=this.emailInput;if(this.user){if(this.user.enableMobileLogin){this.emailLabel.innerHTML="登录帐号："}if(this.user.isSaveEmail){this.emailInput.value=this.user.email;d=this.passInput}}setTimeout(function(){this.setCursor(d)}.bind(this),500);this.initializeEvent()},initializeEvent:function(){this.signinHandler=this.signin.bind(this);Event.observe(this.form,"submit",this.signinHandler);this.signupHandler=this.signup.bind(this);Event.observe(this.signUpBtn,"click",this.signupHandler);this.checkAccountHandler=this.checkAccount.bind(this);Event.observe(this.emailInput,"change",this.checkAccountHandler);this.checkPasswordHandler=this.checkPassword.bind(this);Event.observe(this.passInput,"change",this.checkPasswordHandler);this.refreshVcodeHandler=this.refreshVcode.bind(this);Event.observe(this.vcodeRefreshBtn,"click",this.refreshVcodeHandler)},refreshVcode:function(b){this.server.refreshVcode(function(a){if(a&&a.value&&a.value.id){this.vcodeImageCtn.show();this.vcodeInput.value="";this.vcodeInput.focus();this.vcodeId=a.value.id;this.vcodeImage.src=a.value.src}}.bind(this))},checkAccount:function(){var c=this.emailInput.value.trim(),d=true;if(this.user&&this.user.enableMobileLogin){if(!Validator.Email.test(c)&&!Validator.MobilePhone.test(c)){this.emailInput.addClassName("new_input_false");d=false}else{this.emailInput.removeClassName("new_input_false")}}else{if(!Validator.Email.test(c)){this.emailInput.addClassName("new_input_false");d=false}else{this.emailInput.removeClassName("new_input_false")}}return d},checkPassword:function(){var c=this.passInput.value,d=true;if(!Validator.Password.test(c)){this.passInput.addClassName("new_input_false");d=false}else{this.passInput.removeClassName("new_input_false")}return d},checkVcode:function(){var d=this.vcodeInput.value.trim(),c=true;if(!d){this.vcodeInput.addClassName("new_input_false");c=false}else{this.vcodeInput.removeClassName("new_input_false")}return c},signup:function(){var b=siteMcUrl+"/member/signin/?redirectUrl="+encodeURIComponent(location.href);location.href=b},signin:function(e){Event.stop(e);var d=this.emailInput.value;var f=$encodePassword(this.passInput.value);if(this.checkAccount()&&this.checkPassword()&&(!this.vcodeId||this.checkVcode())&&!this.lock){this.lock=true;this.signInBtn.setAttribute("disabled","disabled");this.server.signIn(d,f,true,false,this.vcodeId||"",this.vcodeId?this.vcodeInput.value:"",function(a){this.lock=false;this.signInBtn.removeAttribute("disabled");if(a&&a.value){if(a.value.success){this.close();this.callback&&this.callback(a.value)}else{if(a.value.isShieldStatus){this.close();this.showSecurityRiskDialog(a.value.shieldTip)}else{if(a.value.needResetPassword){this.close();this.showResetPwdDialog(a.value.resetPasswordUrl)}else{if(a.value.redirect){$redirect(a.value.message)}else{if(a.value.isRobot){this.vcodeInputCtn.show();if(!a.value.vcodeValid){this.vcodeInput.addClassName("new_input_false")}this.refreshVcode();return}else{this.vcodeInputCtn.hide();this.vcodeImageCtn.hide();this.vcodeId=null}this.emailInput.addClassName("new_input_false");this.passInput.addClassName("new_input_false")}}}}}}.bind(this))}},showSecurityRiskDialog:function(b){this.securityRiskDialog=new Dialog({title:"提示",windowClassName:"w375",content:'<div class="yahei px14 tc bold">'+b+"</div>",buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",keyCode:Event.KEY_RETURN,buttonStyle:"t_btn_blue_i bold",callback:function(a){a.close()}.bind(this)}]})},showResetPwdDialog:function(b){this.needResetPwdDialog=new Dialog({title:"账户已被保护，请找回密码",windowClassName:"w375",content:'<div class="yahei px14 tc bold"><p>您长时间未登录，账户已被安全保护。</p><p class="mt5">请点击按钮激活账户，然后去注册邮箱找回密码。</p></div>',buttonRegionClass:"tip_btnbox",buttons:[{title:"激活并找回密码",keyCode:Event.KEY_RETURN,buttonStyle:"t_btn_blue_i bold",callback:function(a){location.href=b}.bind(this)}]})},onCancel:function(){this.close()},destroyEvent:function(){Event.stopObserving(this.form,"submit",this.signinHandler);Event.stopObserving(this.signUpBtn,"click",this.signupHandler);Event.stopObserving(this.emailInput,"change",this.checkAccountHandler);Event.stopObserving(this.passInput,"change",this.checkPasswordHandler);Event.stopObserving(this.vcodeRefreshBtn,"click",this.refreshVcodeHandler)},destroyDOM:function(){},destroyField:function(){}});Weibo.VoteAddDialog=Class.create();Object.extend(Object.extend(Weibo.VoteAddDialog.prototype,Weibo.Dialog.prototype),{server:{createVote:function(n,l,k,h,j,i,m){Mtime.Component.Ajax.callBack("Mtime.MemberCenter.Pages.SimpleVoteService","CreateVote",[n,l,k,h,j],i,"/service/simplevote.mc","post","20000",m)}},options:{callback:null,vote:null,dialogTemplate:'<div class="myray" id="container"><p class="mt6 clearfix"><label class="fl mt3 mr6" for="">标题</label><input type="text" class="t_text fl w200" name="" id="title"></p><div id="option"><p class="mt6 clearfix"><label class="fl mt3 mr6" for="">选项</label><input type="text" name="option" class="t_text fl w200"></p><p class="mt6 clearfix"><input type="text" name="option" class="t_text fl w200 ml30"></p><p class="mt6 clearfix"><input type="text" name="option" class="t_text fl w200 ml30"></p></div><p class="mt12"><label class="fl mr6" for="">类型</label><input name="type" type="radio" value="single" id="single" checked="checked">单选<input name="type" type="radio" value="muti" id="muti" class="ml6">多选<span id="optionCount" style="" class="ml3">最多选项数<span class="ml3"><input id="optionCountInput" type="text" class="t_text w40"></span></span></p><p class="mt12">结束时间</p><p class=" mt5"><input name="voteExpirDay" type="radio" value="1" checked="checked">7天<input name="voteExpirDay" type="radio" value="2" class="ml6">10天<input name="voteExpirDay" type="radio" value="3" class="ml6">30天<input name="voteExpirDay" type="radio" value="4" class="ml6">60天<input name="voteExpirDay" type="radio" value="5" class="ml6">不限制</p><span id="feedback" class="c_orange"></span></div>',optionTemplate:'<p class="mt6 clearfix"><input type="text" name="option" value="{0}" class="t_text fl w200 ml30"></p>'},initializeDom:function(){this.dialog=new Dialog({title:"添加一个投票",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.container=b.getEl("container");this.title=this.container.down("#title");this.optionContainer=this.container.down("#option");this.options=$$('input[name="option"]',this.container);this.single=this.container.down("#single");this.muti=this.container.down("#muti");this.optionCount=this.container.down("#optionCount");this.optionCountInput=this.container.down("#optionCountInput");this.feedback=this.container.down("#feedback");this.optionCount.hide();this.addOptionHandler=this.addOption.bind(this);this.toggleOptionCountHandler=this.toggleOptionCount.bind(this);if(this.vote){this.renderVote()}setTimeout(function(){this.setCursor(this.title)}.bind(this),500);this.initializeEvent()},initializeEvent:function(){Event.observe(this.options[this.options.length-1],"click",this.addOptionHandler);Event.observe(this.muti,"click",this.toggleOptionCountHandler);Event.observe(this.single,"click",this.toggleOptionCountHandler)},onSubmit:function(){var l=[];var t=this.title.value.trim();var r=[];for(var n=0,p=this.options.length,s;n<p;++n){s=this.options[n];if(s.value.trim().length>0){r.push(s.value.trim())}}var o=this.single.checked;if(t.length===0){l.push("请输入投票标题！")}if(t.bytelength()>30){l.push("标题不要超过30个字！")}if(r.length<2){l.push("请至少输入两个投票选项！")}else{for(var n=0,i=r.lenngth;n<i;n++){if(r[n].bytelength()>20){l.push(String.Format("选项{0}不要超过20个字！",n))}}}var q=this.optionCountInput.value;if(!o){if(/^\d+$/.test(q)){q=parseInt(q,10);if(q>r.length||q<0){l.push("最大允许投票项数应大于０且不超过最大项数！")}}else{l.push("最大允许投票项数请输入数字！")}}var m=Utility.Dom.getSelectedValues("voteExpirDay",1);if(l.length>0){this.feedback.innerHTML=l.join("<br />")}else{this.feedback.innerHTML="";this.server.createVote(t,r.join("|"),o,q,m,function(a){if(a&&a.value&&a.value.success){this.close();this.callback&&this.callback(a.value.vote)}else{this.feedback.innerHTML="创建投票失败，请稍候重试！"}}.bind(this),this.submitBtn)}},renderVote:function(){this.title.value=this.vote.Title;var f=[];for(var d=0,e=this.vote.VoteItems.length;d<e;++d){if(d==0){f.push(String.format('<p class="mt6 clearfix"><label for="" class="fl mt3 mr6">选项</label><input type="text" class="t_text fl w200" value="{0}" name="option"></p>',this.vote.VoteItems[d].Description))}else{f.push(String.format(this.optionTemplate,this.vote.VoteItems[d].Description))}}this.optionContainer.innerHTML=f.join("");this.options=$$('input[name="option"]',this.container);this.muti.checked=!this.vote.Type;this.single.checked=!!this.vote.Type;this.toggleOptionCount()},onCancel:function(){this.close()},addOption:function(){Event.stopObserving(this.options[this.options.length-1],"click",this.addOptionHandler);var b=$(Builder.build(String.format(this.optionTemplate,"")));this.optionContainer.appendChild(b);this.options.push(b.down("input"));Event.observe(this.options[this.options.length-1],"click",this.addOptionHandler)},toggleOptionCount:function(){if(this.muti.checked){this.optionCountInput.value="";this.optionCount.show()}else{this.optionCount.hide()}}});Weibo.TwitterDialog=Class.create();Object.extend(Object.extend(Weibo.TwitterDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,content:null,imagePath:null,imageUrl:null,dialogTemplate:'<div><div class="my_overall"><div class="my_editor"><div class="my_textarea_region" _type="bg_feedback"><textarea _type="weibo_editor" class="my_textarea"></textarea></div><div class="mt6 clearfix"><div class="my_post fl"><div class="my_options"><ul><li _type="movie_linker"><span class="select_movie"></span><a href="#" onclick="return false;">电影/影人</a></li><li _type="imageregion"><div><span class="select_image"></span>图片</div></li><li _type="face_select"><span class="select_faces"></span><a href="#" onclick="return false;">表情</a></li><li _type="weibo_video"><span class="select_video"></span><a href="#" onclick="return false;">视频</a></li><li _type="weibo_topic"><span class="select_topic"></span><a href="#" onclick="return false;">话题</a></li></ul></div></div><div class="fr mt6"><p class="tr" _type="digit_feedback"></p><p class="mt3 song tr"><input type="checkbox" _type="weibo_sync"><label class="ml6">同步</label><a _type="sync_config" onclick="return false;" href="#">[设置]</a></p></div></div></div></div><div class="my_movie" style="display:none;" _type="linkedMovie"></div></div>',relatedId:0,relatedObjId:0},initializeDom:function(){this.dialog=new Dialog({title:"写微评",windowClassName:"w660",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"发布",buttonStyle:"btn_blue mr12",callback:function(){}},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},onReady:function(d){var f=d.windowElement;if(typeof f.down(".myray")!="undefined"){f.down(".myray").style.paddingBottom="40px"}var e=f.down('[_type="weibo_editor"]');this.content&&(e.value=this.content);setTimeout(function(){this.setCursor(e)}.bind(this),500);Weibo.PopupUtil.LoadEditorJs(function(){this.editor=new Weibo.Editor({editor:e,cacheable:(this.content?false:true)});new Weibo.Feedback({editor:this.editor,backgroundFeedback:{target:f.down('[_type="bg_feedback"]'),normalColor:"#FFF",warnColor:"#FD9999",start:-620,end:0},digitFeedback:{target:f.down('[_type="digit_feedback"]'),normalTemplate:"<span>{0}</span>/<strong>{1}</strong>字",warnTemplate:'<span style="color:red">{0}</span>/<strong>{1}</strong>字'}});new Weibo.Publisher({editor:this.editor,pubButton:d.buttonNodes[0],callback:this.onSubmit.bind(this)});new Weibo.AtSyntax({editor:this.editor});new Weibo.MovieSyntax({editor:this.editor});new Weibo.Face({editor:this.editor,addButton:f.down('[_type="face_select"]')});new Weibo.MovieLinker({editor:this.editor,linkButton:f.down('[_type="movie_linker"]'),linkedMovieContainer:f.down('[_type="linkedMovie"]'),relatedId:this.relatedId,relatedObjId:this.relatedObjId});setTimeout(function(){new Weibo.Image({editor:this.editor,imageRegion:f.down('[_type="imageregion"]'),initImagePath:this.imagePath,initImageUrl:this.imageUrl})}.bind(this),500);new Weibo.Video({editor:this.editor,addButton:f.down('[_type="weibo_video"]')});new Weibo.Topic({editor:this.editor,addButton:f.down('[_type="weibo_topic"]')});new Weibo.Sync({editor:this.editor,configButton:f.down('[_type="sync_config"]'),syncButton:f.down('[_type="weibo_sync"]')})}.bind(this));this.initializeEvent()},initializeEvent:function(){},onSubmit:function(){this.close();this.callback&&this.callback()},onCancel:function(){this.editor.destroy();this.editor=null;this.dialog.close()},close:function(){if(this.editor){this.editor.destroy();this.editor=null}this.dialog&&this.dialog.close();this.destroyEvent();this.destroyDOM();this.destroyField()},destroyEvent:function(){},destroyDOM:function(){},destroyField:function(){}});Weibo.SyncConfigDialog=Class.create();Object.extend(Object.extend(Weibo.SyncConfigDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,syncContent:null,contentTemplate:new Template('<li><input name="" type="checkbox" #{check} sync="#{sync}" value=""><label for="">&nbsp;#{label}</label></li>'),dialogTemplate:'<div><div class="tip_foculist" style="margin-top:0;"><ul class="clearfix" id="content"></ul></div></div>'},initializeDom:function(){this.dialog=new Dialog({title:"同步到站外的内容",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(h){this.content=h.getEl("content");var d=[];for(var i=0,j=this.syncContent.length,c;i<j;++i){c=this.syncContent[i];d.push(this.contentTemplate.evaluate({sync:c.id,label:c.label,check:c.check?'checked="checked"':""}))}this.content.innerHTML=d.join("");this.syncChk=$$('input[type="checkbox"]',this.content);this.initializeEvent()},initializeEvent:function(){},onSubmit:function(){var h={};for(var e=0,f=this.syncChk.length,g;e<f;++e){g=this.syncChk[e];h[g.getAttribute("sync")]=g.checked}this.close();this.callback&&this.callback(h)},onCancel:function(){this.close()}});Weibo.FollowTopicDialog=Class.create();Object.extend(Object.extend(Weibo.FollowTopicDialog.prototype,Weibo.Dialog.prototype),{server:{followTopic:function(f,e,d){return appManager.$callback("/service/twitter.mt",{topic:f},e,d,"AddFollowTopic")}},options:{callback:null,dialogTemplate:'<div><div class="clearfix"><label for="topic" class="fl mt3">话题名：</label><span class="fl"><input name="topic" id="topic" type="text" class="t_text w155"><br><span class="c_666">不能超过30个字符，15个汉字</span></span></div></div>'},initializeDom:function(){this.dialog=new Dialog({title:"添加关注的话题",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.onSubmit.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.onCancel.bind(this)}],readyCallback:this.onReady.bind(this)})},onReady:function(b){this.submitBtn=b.buttonNodes[0];this.topicInput=b.getEl("topic");this.initializeEvent()},initializeEvent:function(){},followErrorCheck:function(d){var c=null;switch(d.value){case -3:c="关注的话题数量已达上限";break;case -1:c="非法的话题内容";break;case -2:case 0:c="添加失败";break}if(c){$alert(c,null,null,4);return false}else{return true}},onSubmit:function(){var d=this.topicInput.value;var c=Math.ceil(d.bytelength()/2);if(c>0&&c<=15){this.server.followTopic(d,function(a){if(a&&Mtime.isValue(a.value)&&this.followErrorCheck(a)){this.close();this.callback&&this.callback(d)}else{$alert("关注话题失败.",null,null,4)}}.bind(this),this.submitBtn)}else{if(c==0){$alert("请输入话题.",null,null,4)}else{$alert("话题长度超过规定.",null,null,4)}}},onCancel:function(){this.close()},destroyField:function(){this.remarkInput=null;this.dialog=null}});Weibo.AlertDialog=Class.create();Object.extend(Object.extend(Weibo.AlertDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,delay:null,message:"",dialogTemplate:'<div><dl class="clearfix"><dt class="fl"><span class="t_worning"></span></dt><dd class="fl w295 ml15">{0}</dd></dl></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w425",content:String.format(this.dialogTemplate,this.message),buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.close.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},onReady:function(b){this.initializeEvent()},initializeEvent:function(){if(this.delay){setTimeout(this.close.bind(this),this.delay*1000)}},close:function(){this.dialog&&this.dialog.close();this.dialog=null;this.callback&&this.callback();this.callback=null}});Weibo.ConfirmDialog=Class.create();Object.extend(Object.extend(Weibo.ConfirmDialog.prototype,Weibo.Dialog.prototype),{options:{callback:null,message:"",dialogTemplate:'<div><dl class="clearfix"><dt class="fl"><span class="t_worning"></span></dt><dd class="fl w295 ml15">{0}</dd></dl></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w425",content:String.format(this.dialogTemplate,this.message),buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue mr12",callback:this.okclose.bind(this)},{title:"取消",buttonStyle:"btn_gray",callback:this.cancelclose.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},onReady:function(b){this.initializeEvent()},initializeEvent:function(){},okclose:function(){this.dialog&&this.dialog.close();this.dialog=null;this.callback&&this.callback();this.callback=null},cancelclose:function(){this.dialog&&this.dialog.close();this.dialog=null}});Weibo.BirthdayDialog=Class.create();Object.extend(Object.extend(Weibo.BirthdayDialog.prototype,Weibo.Dialog.prototype),{server:{send:function(f,e,d){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.MessageService","SendUserMessageToNicknameCrossDomainByFlash",f,e,"/Service/Message.msi","post","20000",d)}},options:{callback:null,nickname:null,dialogTemplate:'<div><p>赠言</p><p class="mt3"><textarea name="" cols="" rows="6" class="mt3 wp99" _type="text"></textarea></p><p class="mt9 tr" _type="countfeedback">0/210字</p></div>'},initializeDom:function(){this.dialog=new Dialog({title:"提示",windowClassName:"w345",content:this.dialogTemplate,buttonRegionClass:"tip_btnbox",buttons:[{title:"确定",buttonStyle:"btn_blue",callback:this.send.bind(this)}],readyCallback:this.onReady.bind(this),closeCallback:this.close.bind(this)})},onReady:function(d){var f=d.windowElement;this.sendBtn=d.buttonNodes[0];var e=this;Weibo.PopupUtil.LoadEditorJs(function(){e.editor=new Weibo.Editor({editor:f.down('[_type="text"]')});new Weibo.Feedback({editor:e.editor,digitFeedback:{target:f.down('[_type="countfeedback"]'),normalTemplate:"<span>{0}</span>/<strong>{1}</strong>字",warnTemplate:'<span style="color:red">{0}</span>/<strong>{1}</strong>字'}});setTimeout(function(){e.editor.insertText("dear "+e.nickname+"，祝你生日快乐")},200)})},initializeEvent:function(){},destroyEvent:function(){this.editor&&this.editor.destroy();this.editor=null},getError:function(c){var d=null;switch(c){case 0:d="未登录";break;case 10:d="对方拒收信件";break;case 1:d=null;break;case 6:d="收信人不能是你自已";break;case 9:d="对方拒绝接收此类型消息";break;case 12:d="验证码错误";break;case 14:d="内容中含不允许发送的关键字";break;case 15:d="标题中含不允许发送的关键字";break;case 20:d="标题为空";break;case 21:d="赠言内容为空";break;case 22:d="未找到接收用户";break;case 23:d="赠言内容长度超过限制";break;default:d="未知错误码："+c;break}if(d){$alert(d,null,null,4);return false}else{return true}},send:function(){var b=this.editor.getLength();if(b>0&&b<=this.editor.lengthExp.max){this.server.send([this.nickname,this.editor.editor.value],function(a){if(!a){$alert("发送失败，请重试。");return}if(!a.error&&this.getError(a.value)){$alert('<span class="ico_tright">&nbsp;</span> 发送赠言成功',null,null,2);this.close();this.callback&&this.callback()}}.bind(this),this.submitBtn)}else{if(b==0){$alert("请输入赠言内容.",null,null,2)}else{$alert("赠言内容长度超过限制.",null,null,2)}}}});Weibo.OnlineTicketUserLoginDialog=Class.create();Object.extend(Object.extend(Weibo.OnlineTicketUserLoginDialog.prototype,Weibo.UserLoginDialog.prototype),{options:{forbidAnnoymousTicket:true,callback:null,anonymousCallback:null,dialogTemplate:'<form><dl class="login_userinfo"><dd><label data-login="account-label">登录帐号：</label><input type="text" name="account" class="t_text w175"></dd><dd><label>登录密码：</label><input type="password" name="password" class="t_text w175"><a href="http://my.mtime.com/member/forget_password/" class="ml6">忘记密码？</a></dd><dd data-login="vcode-input-ctn" style="display: none;"><label>验证码：</label><input type="text" name="vcode" class="t_text c_a5" value="" style="width:115px;"></dd><dd data-login="vcode-image-ctn" style="display: none;"><img src="" data-login="vcode-image" class="mr12 v_m"><a href="#" onclick="return false;" data-login="vcode-refresh-btn">刷新</a></dd><dd><input type="checkbox" data-login="auto" name="" value="">下次自动登录</dd></dl><p class="tc mt15 "><input type="button" value="免费注册" data-login="signup" class="t_btn_gray_i bold mr8 "><input type="submit" value="登录" data-selector="submit" class="t_btn_blue_i bold "></p><p class="mt10 tr mr25 c_666"><span class="c_red dib v_m mr6 ">* </span>会员登录后，可查询订单，享受更多会员服务</p></form>'},initializeDom:function(){this.dialog=new Dialog({title:"会员登录",windowClassName:"w375",content:this.dialogTemplate,readyCallback:this.onReady.bind(this),addTitleDOM:function(){if(this.forbidAnnoymousTicket){return Builder.build('<div><h2 class="share_tit  edit_s_t">会员购票<em class="s_t_jiao">&nbsp;</em></h2></div>')}else{return Builder.build('<div><h2 class="share_tit  edit_s_t">会员购票<em class="s_t_jiao">&nbsp;</em></h2><p class="tick_btn"><a href="#" data-login="anonymous" onclick="return false;" class="px14">非会员购票<em class="s_t_buy">&nbsp;</em></a></p></div>')}}.bind(this)})},onReady:function(b){this.anonymousBtn=b.windowElement.down('a[data-login="anonymous"]');Weibo.UserLoginDialog.prototype.onReady.apply(this,[b])},initializeEvent:function(){Weibo.UserLoginDialog.prototype.initializeEvent.apply(this);this.anonymousHandler=this.anonymous.bind(this);if(this.anonymousBtn){Event.observe(this.anonymousBtn,"click",this.anonymousHandler)}},anonymous:function(){this.close();this.anonymousCallback&&this.anonymousCallback()},destroyEvent:function(){Weibo.UserLoginDialog.prototype.destroyEvent.apply(this);if(this.anonymousBtn){Event.stopObserving(this.anonymousBtn,"click",this.anonymousHandler)}},destroyDOM:function(){},destroyField:function(){}});var AutoHeight=Class.create();Object.extend(AutoHeight,{getXY:function(h){var i=0,j=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;i=a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft;j=a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop}else{for(;h!=document.body;i+=h.offsetLeft,j+=h.offsetTop,h=h.offsetParent){}}return{x:i,y:j}},cssList:["font-family","font-size","font-style","font-weight","font-variant","line-height","margin-top","margin-bottom","margin-left","margin-right","overflow-x","overflow-y","padding-top","padding-bottom","padding-left","padding-right","word-break","word-wrap"],startAuto:function(c){c=$(c);var d=AutoHeight.auto.bind(c);Event.observe(c,"blur",d);Event.observe(c,"focus",d);Event.observe(c,"keyup",d);Event.observe(c,"mouseup",d);return AutoHeight.stopAuto.bind(c,d)},auto:function(){if(this.value.length==0){this.style.height="";return}if(!AutoHeight.mirrorCtn){AutoHeight.mirrorCtn=$(Builder.node("div"));document.body.appendChild(AutoHeight.mirrorCtn);AutoHeight.mirrorCtn.style.opacity="0";AutoHeight.mirrorCtn.style.zIndex=-1000;AutoHeight.mirrorCtn.style.position="absolute"}mirrorCtn=AutoHeight.mirrorCtn;cssList=AutoHeight.cssList;styleObj={};for(var i=0,j=cssList.length,h,m,k;i<j;++i){h=cssList[i];if((m=this.getStyle(h))){styleObj[h]=m}}mirrorCtn.setStyle(styleObj);mirrorCtn.setStyle({width:this.offsetWidth+"px"});var n=this.value;if(n.lastIndexOf("\n")!=-1&&n.lastIndexOf("\n")+1==n.length){n+="占"}mirrorCtn.innerHTML=n.replace(/\n/g,"<br/>");var l=AutoHeight.getXY(this);mirrorCtn.style.top=l.y+"px";mirrorCtn.style.left=l.x+"px";this.style.height=mirrorCtn.offsetHeight+"px"},stopAuto:function(b){Event.stopobserving(el,"blur",b);Event.stopobserving(el,"focus",b);Event.stopobserving(el,"keyup",b);Event.stopobserving(el,"mouseup",b)}});var InteractionControl=Class.create();Object.extend(InteractionControl.prototype,{setCursor:function(h,g,e){g=g==null?h.value.length:g;e=e==null?0:e;h.focus();if(h.createTextRange){var f=h.createTextRange();f.move("character",g);f.moveEnd("character",e);f.select()}else{h.setSelectionRange(g,g+e)}},getXY:function(h){var i=0,j=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;i=a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft;j=a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop}else{for(;h!=document.body;i+=h.offsetLeft,j+=h.offsetTop,h=h.offsetParent){}}return{x:i,y:j}},server:{Follow:function(d,c){return appManager.$callback("/service/twitter.mt",{fTwitterId:d},c,"Follow")},UnFollow:function(d,c){return appManager.$callback("/service/twitter.mt",{fTwitterId:d},c,"UnFollow")},GetTweetCommentSimpleList:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTweetCommentSimpleList",[d],c,"/Service/Twitter.msi","get","20000")},AddTweetComment:function(o,p,m,k,j,n,i){var l=Mtime.isValue(m)?[o,p,m,k,false,0,false,j]:[o,p,0,k,false,0,false,j];return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.TwitterService","AddTweetCommentWithOptionCrossDomainByFlash",l,i,"/Service/Twitter.msi","post","20000",n)},DeleteTweet:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","DeleteTweet",[f],d,"/Service/Twitter.msi","get","20000")},GetTwitterVideoInfo:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTwitterVideoInfo",[d],c,"/Service/Twitter.msi","get","20000")},FavoriteTweet:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","FavoriteTweet",[f],d,"/Service/Twitter.msi","get","20000",e)},UnFavoriteTweet:function(f,e,d){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","UnFavoriteTweet",[f],d,"/Service/Twitter.msi","get","20000",e)},getCurrentTweetHtml:function(d,c){return appManager.$callback("/service/twitter.mt",{tweetId:d},c,null,"GetCurrentTweetHtml")},getTweetPathContent:function(d,c){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTweetPathContent",[d],c,"/Service/Twitter.msi","get","20000")}},options:{mytimeContentRegion:"",renderCurrentTweetcallback:null,collectCallback:null,uncollectCallback:null,commentTemplate:'<div class="t_rreply" type="comment"><span class="tr_jt"></span><div class="clearfix  mb12"><span class="ico_adface fl" title="添加表情"></span><div class="replayarea" _type="replyarea"><textarea class="t_retextarea"></textarea><p class="mt3"><span class="fr" _type="fd"></span><input type="checkbox" _type="rt" class="mr6">同时转发到我的微评</p></div><a href="#" onclick="return false;" class="t_btn_b2 ml10 fl" method="submit" >发布</a></div>',tamplate_PIC_HTML:'<div class="my_rotate_large mt12"><p><a class="ico_put" href="#" onclick="return false;" method="rotate_zoomout"><em></em>收起</a><span class="mr12 ml12 c_666">|</span>{1}<span class="mr12 ml12 c_666">|</span><a class="ico_left" href="#" onclick="return false;" method="rotateleft"><em></em>向左转</a><span class="mr12 ml12 c_666">|</span><a class="ico_right" href="#" onclick="return false;" method="rotateright"><em></em>向右转</a></p><p class="mt12 tc"><a href="#" onclick="return false;" class="inblock"><img src="{0}" class="bimg" method="rotate_zoomout"></a></p></div>',tamplate_VDO_HTML:new Template('<div class="my_rotate_large mt12"><p><a href="#" onclick="return false;" class="ico_put" method="rotate_zoomout"><em></em>收起</a><span class="mr12 ml12 c_666">|</span><a href="#{url}" class="ico_blank" target="_blank"><em></em>#{title}</a><span class="mr12 ml12 c_666">|</span><a href="#" onclick="return false;" class="ico_right" method="video_open"><em></em>弹出</a></p><p class="tc mt12"><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0" width="440" height="356"><param name="movie" value="#{swfUrl}" /><param name="quality" value="high" /><param name="allowFullScreen" value="true" /><param name="menu" value="false" /><param name="wmode" value="transparent" /><param name="flashvars" value="#{typeValue}" /><param name="allowScriptAccess" value="always" /><embed wmode="transparent" allowscriptaccess="always" allowFullScreen="true" src="#{swfUrl}" quality="high" flashvars="#{typeValue}" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" width="440" height="356"/></object></p></div>'),tamplate_VDOPEN_HTML:new Template('<div id="my_rotateOpen" class="my_rotate_open"><p class="pt6 pl12"><a href="#" onclick="return false;" class="ico_put" id="rotateClose"><em></em>关闭</a></p><p class="tc mt9">#{embed}</p></div>'),isShowBackTop:false},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeEvent();this.initializeControl()},initializeField:function(){this.mytimeContentRegion=$(this.mytimeContentRegion);this.indicationStyleId="indicationStyleId";this.movieIndex=0;this.editors={}},initializeEvent:function(){this.overRegionHandler=this.onOverRegion.bind(this);this.outRegionHandler=this.onOutRegion.bind(this);this.clickRegionHandler=this.onClickRegion.bind(this);this.mytimeContentRegion.observe("mouseover",this.overRegionHandler);this.mytimeContentRegion.observe("mouseout",this.outRegionHandler);this.mytimeContentRegion.observe("click",this.clickRegionHandler)},initializeControl:function(){if(this.isShowBackTop){new backTopControl()}},loadDialogJs:function(b){if(typeof(Weibo)!="undefined"&&typeof(Weibo.Dialog)!="undefined"){b()}else{$loadJs("/js/2011/weibo/popupDialog.js",function(){b()})}},loadEditorJs:function(b){if(typeof(Weibo)!="undefined"&&Weibo.Face&&Weibo.Image&&Weibo.Sync&&Weibo.Syntax&&Weibo.Topic&&Weibo.Video&&Weibo.MovieLinker){b()}else{if(debug){$loadJs(["/js/2011/weibo/editor/editor.js","/js/2011/weibo/editor/image.js","/js/2011/weibo/editor/face.js","/js/2011/weibo/editor/sync.js","/js/2011/weibo/editor/syntax.js","/js/2011/weibo/editor/movieLinker.js","/js/2011/weibo/editor/video.js","/js/2011/weibo/editor/topic.js"],function(){b()})}else{$loadJs("/js/2011/weiboEditor.js",function(){b()})}}},onOverRegion:function(m){var k=Event.element(m);if(Mtime.browser.ie&&Mtime.browser.ie<7){var s=k.up("div.t_modcont");var q=k.hasClassName("t_modcont")?k:null;var n=q||s;if(n){n.addClassName("visible")}var t=k.up("div.t_relist");var r=k.hasClassName("t_relist")?k:null;var l=r||t;if(l){l.addClassName("visible")}}var o=k.readAttribute("method");switch(o){case"allGrouping":this.handleOutTimer();if(this.allGroupingList){this.allGroupingList.show()}else{this.builderNode("allGrouping");document.body.appendChild(this.windowElement);this.allGroupingList=$("allGroupingList");this.allGroupingList.show();var p=this.getXY(k);this.allGroupingList.style.left=p.x-15+"px";this.allGroupingList.style.top=p.y+19+"px";this.ovarAllGroupingListRegionHandler=this.ovarAllGroupingListRegion.bind(this);this.outAllGroupingListRegionHandler=this.outAllGroupingListRegion.bind(this);this.clickAllGroupingListRegionHandler=this.clickAllGroupingListRegion.bind(this);this.allGroupingList.observe("mouseover",this.ovarAllGroupingListRegionHandler);this.allGroupingList.observe("mouseout",this.outAllGroupingListRegionHandler);this.allGroupingList.observe("click",this.clickAllGroupingListRegionHandler)}break}},onOutRegion:function(l){var j=Event.element(l);if(Mtime.browser.ie&&Mtime.browser.ie<7){var q=j.up("div.t_modcont");var o=j.hasClassName("t_modcont")?j:null;var m=o||q;if(m){m.removeClassName("visible")}var r=j.up("div.t_relist");var p=j.hasClassName("t_relist")?j:null;var k=p||r;if(k){k.removeClassName("visible")}}var n=j.readAttribute("method");switch(n){case"allGrouping":this.handleOutTimer();this.collectBoxTimeout=setTimeout(function(){if(this.allGroupingList){this.allGroupingList.hide()}}.bind(this),500);break}},ovarAllGroupingListRegion:function(b){this.handleOutTimer();if(this.allGroupingList){this.allGroupingList.show()}},outAllGroupingListRegion:function(b){this.collectBoxTimeout=setTimeout(function(){if(this.allGroupingList){this.allGroupingList.hide()}}.bind(this),500)},clickAllGroupingListRegion:function(e){var d=Event.element(e);var f=d.getAttribute("_type");switch(f){case"addGroup":this.loadDialogJs(function(){new Weibo.AddOrUpdateGroupDialog()});break;case"orderGroup":this.loadDialogJs(function(){new Weibo.GroupOrderDialog()});break}},handleOutTimer:function(){if(this.collectBoxTimeout!=null){clearTimeout(this.collectBoxTimeout);this.collectBoxTimeout=null}},showDialogBox:function(g,e,h,f){new DialogBox({element:g,content:e,buttonRegionId:h,buttons:[{title:"确定",buttonStyle:"btn_blue2 mr12",callback:f},{title:"取消",buttonStyle:"btn_gray2",onmouseover:"this.className='btn_blue2'",onmouseout:"this.className='btn_gray2'",callback:function(a){a.close()}.bind(this)}]})},insertText:function(g,h,f,e){this.loadEditorJs(function(){g.value="";g.setAttribute("range","0&0");Weibo.TextareaUtils.insertText(g,h,0,e)})},addCommentErrorCheck:function(i){var j=parseInt(i.value.success);if(j===1){var f=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"内容为空.";case -3:return"非法的用户.";case -4:return"微评不存在.";case -5:return"原回复已被删除.";case -6:return"在对方的黑名单中.";case -7:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var h=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"非法的用户.";case -3:return"原微评不存在.";case -4:return"原微评不存在.";case -5:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var g="";if(parseInt(i.value.commentId,10)<=0){g=f(parseInt(i.value.commentId,10))}if(!g&&i.value.isForward&&parseInt(i.value.forwardTweetId,10)<=0){g=h(parseInt(i.value.forwardTweetId,10))}if(!g&&i.value.isCommentToRoot&&parseInt(i.value.commentToRootId,10)<=0){g=f(parseInt(i.value.commentToRootId,10))}if(!g&&parseInt(i.value.replyResult,10)!=1){g=i.value.replyError||""}if(g){$alert(g,null,null,4);return false}else{return true}}else{if(j===-4){this.loadDialogJs(function(){new Weibo.AlertDialog({message:'<h4 class="px14 mt3">你已被禁言，无法发布内容</h4><p class="mt9 song"><a href="'+siteMcUrl+'/bantalking/">查看禁言状态&gt;&gt;</a></p>'})});return false}else{if(j===-5){$alert("你的评论有被禁止的内容，请修改后发布。",null,null,4);return false}else{if(j===-20){$alert("你发布的速度太快了，休息一下吧：）",null,null,4);return false}else{if(j===-30){$alert("非法用户",null,null,4);return false}}}}}},onClickRegion:function(al){var R=Event.element(al);var au=R.readAttribute("method");while(!au&&R!=document.body){R=R.up();au=R.readAttribute("method")}switch(au){case"delete":Event.stop(al);if(R.tagName=="A"){var ac=new Date().getTime();this.id="dialogBox_"+ac;this.buttonRegionId="dialogBoxButtonRegion_"+ac;this.windowElement=Builder.node("div",{id:this.id,className:"my_layer my_confirm"},[Builder.node("em",{id:this.indicationStyleId}),Builder.node("div",{className:"inner"},[Builder.node("p",{className:"tc px14 bold"},["确定删除这条微评吗？"]),Builder.node("p",{id:this.buttonRegionId,className:"mt6 tc"},[])])]);var ab='<p class="bold">确定删除这条微评吗？</p>';this.showDialogBox(R,ab,this.buttonRegionId,function(a){a.close();var c=R.up(".t_module");var b=c.getAttribute("tweetid");this.server.DeleteTweet(b,null,function(d){if(d&&d.value){c.remove()}}.bind(this))}.bind(this))}break;case"collect":Event.stop(al);var aa=R.up(".t_module");var Y=aa.getAttribute("tweetid");this.server.FavoriteTweet(Y,R,function(b){if(b&&b.value){R.className="ico_tfavon fr";R.title="取消收藏";R.setAttribute("method","uncollect");var a=new DialogBox({element:R,content:'<p class="tc bold mt6"><span class="ico_tright">&nbsp;</span> 收藏成功</p>'});setTimeout(function(){a.close()}.bind(this),2000);this.collectCallback&&this.collectCallback()}}.bind(this));break;case"uncollect":Event.stop(al);var aa=R.up(".t_module");var Y=aa.getAttribute("tweetid");this.server.UnFavoriteTweet(Y,R,function(b){if(b&&b.value){R.className="ico_tfav fr";R.title="收藏";R.setAttribute("method","collect");var a=new DialogBox({element:R,content:'<p class="tc bold mt6"><span class="ico_tright">&nbsp;</span> 已取消收藏</p>'});setTimeout(function(){a.close()}.bind(this),2000);this.uncollectCallback&&this.uncollectCallback()}}.bind(this));break;case"morepath":var aa=R.up(".t_module");var Y=aa.getAttribute("tweetid");var av=R.previous();if(av.innerHTML==""){this.server.getTweetPathContent(Y,function(a){if(a&&Mtime.isValue(a.value)){av.innerHTML=a.value;R.setAttribute("title","收起");R.className="ico_tsq"}}.bind(this))}else{if(av.style.display=="none"){av.style.display="";R.setAttribute("title","收起");R.className="ico_tsq"}else{av.style.display="none";R.setAttribute("title","展开");R.className="ico_tzk"}}break;case"inform":break;case"forward":Event.stop(al);var aa=R.up(".t_module");if(aa.down(".t_rreply")&&(aa.down(".t_rreply").getAttribute("type")!="comment")&&!aa.down(".t_rreply .t_replycont")){$alert("很抱歉，该条微评已删除，无法转发。")}else{var P=function(){var a=aa.getAttribute("tweetid");new Weibo.RTDialog({tweetId:a,callback:function(c){if(c){this.renderCurrentTweetcallback&&this.renderCurrentTweetcallback(c);if(/转发\((\d*)\)/.test(R.innerHTML)){var b=parseInt(R.innerHTML.match(/转发\((\d*)\)/)[1],10);R.innerHTML="转发("+(++b)+")"}}}.bind(this)})}.bind(this);this.loadDialogJs(function(){P()})}break;case"deletecomment":Event.stop(al);var V=R.up("p");var T=R.up(".t_relist");var aa=R.up(".t_module");var W=aa.getAttribute("tweetid");var X=V.getAttribute("commentid");var an=V.getAttribute("ftwitterid");var aq=(R.getAttribute("isblack")!="0");this.loadDialogJs(function(){new Weibo.RemoveReplyDialog({tweetCommentId:X,isShowBlack:aq,ftwitterid:an,callback:function(){T.remove();var a=aa.down('a[method="comment"]');if(a&&/回复\((\d*)\)/.test(a.innerHTML)){var b=parseInt(a.innerHTML.match(/回复\((\d*)\)/)[1],10);Mtime.isValue(b)&&(b>0)&&(a.innerHTML="回复("+(b-1)+")")}}})});break;case"comment":Event.stop(al);var S=R.readAttribute("toggle");var aa=R.up(".t_module");var W=aa.getAttribute("tweetid");if(S==="1"){var Z=aa.down('.t_rreply[type="comment"]');this.removeComment(W,Z);R.setAttribute("toggle","0")}else{R.setAttribute("toggle","1");this.buildComment(W,aa)}break;case"reply":Event.stop(al);var V=R.up("p");if(V.hasAttribute("commentid")){var T=R.up(".t_relist");var ay=V.getAttribute("commentid");var ap=R.up(".t_rreply").down("textarea");var ab=ap.value;this.replyParentid=ay;if(/回复.*:/.test(ab)){this.insertText(ap,"回复@"+T.down('a[type="nickname"]').innerHTML+":")}else{this.insertText(ap,"回复@"+T.down('a[type="nickname"]').innerHTML+":"+ab)}}break;case"submit":Event.stop(al);var aa=R.up(".t_module");var W=aa.getAttribute("tweetid");var Z=aa.down('.t_rreply[type="comment"]');var ab=Z.down("textarea").value;var aA=Z.down("input[_type='rt']").checked;var az=Z.down("input[_type='rs']");az=az?az.checked:false;var ah=this.editors[W];var at=ah.getLength();if(at>0&&at<=ah.lengthExp.max&&!/^回复.*:$/.test(ab)){var ay=null;if(/回复.*:/.test(ab)){ay=this.replyParentid}this.server.AddTweetComment(ab,W,this.replyParentid,aA,az,R,function(d){if(d&&d.value&&this.addCommentErrorCheck(d)){var b=Z.childNodes;if(b[b.length-1].nodeType==3){Z.removeChild(b[b.length-1]);Z.appendChild(Builder.build(d.value.html))}else{Z.insertBefore(Builder.build(d.value.html),Z.down(".t_relist"))}var a=aa.down('a[method="comment"]');if(a&&/回复\((\d*)\)/.test(a.innerHTML)){var c=parseInt(a.innerHTML.match(/回复\((\d*)\)/)[1],10);Mtime.isValue(c)&&(a.innerHTML="回复("+(c+1)+")")}ah.reset()}}.bind(this))}else{if(at==0||/^回复.*:$/.test(ab)){$alert("你还没有填写内容，请填写后提交。",null,null,4)}else{$alert("内容过长,请确认内容字符长度小于"+ah.lengthExp.max+"。",null,null,4)}}break;case"aAttention":Event.stop(al);var ao=R.readAttribute("fTwitterId");if(ao){this.server.UnFollow(ao)}break;case"bAttention":Event.stop(al);var ao=R.readAttribute("fTwitterId");if(ao){this.server.UnFollow(ao)}break;case"cAttention":Event.stop(al);var ao=R.readAttribute("fTwitterId");if(ao){this.server.Follow(ao)}break;case"dAttention":Event.stop(al);var ao=R.readAttribute("fTwitterId");if(ao){this.server.Follow(ao)}break;case"rotate_zoomin":Event.stop(al);var Q=R.readAttribute("src");var ax=R.readAttribute("osrc");var ar=R.getAttribute("isuserphoto");var N=this.shortText(R.readAttribute("alt"),12,"...");var ai=R.up(".t_module").down(".hidelayer");var am=R.up(".t_module").down(".showlayer");var ag=null;if(!ar){ag='<a class="ico_blank" href="'+ax+'" target="_blank"><em></em>查看大图</a>'}else{ag='<a class="ico_blank" href="'+ax+'" target="_blank"><em></em>'+N+"</a>"}var U=Q.replace(/(.*)(\_.*)(\..*)$/,"$1_470X470$3");am.innerHTML=String.format(this.tamplate_PIC_HTML,U,ag);ai.hide();break;case"rotate_zoomout":var am=R.up(".t_module").down(".showlayer");am.up(".t_module").down(".hidelayer").show();am.innerHTML="";window.onerror=null;break;case"rotateleft":this.rotateImages(R.up(1).down("img"),"left");break;case"rotateright":this.rotateImages(R.up(1).down("img"),"right");break;case"video_zoomin":Event.stop(al);var ai=R.up(".t_module").down(".hidelayer");ai.hide();var am=R.up(".t_module").down(".showlayer");var O=R.readAttribute("shorturlkey");this.server.GetTwitterVideoInfo(O,function(b){if(b&&b.value){var c=b.value.swfUrl;var d=b.value.title;var g=b.value.url;var a=b.value.providerId;var f=["","","isAutoPlay=true","playMovie=true&auto=1&adss=0","autoPlay=true"];var e=a<=f.length-1?f[a]:"";window.onerror=function(){return true};am.innerHTML=this.tamplate_VDO_HTML.evaluate({swfUrl:c,title:d,url:g,typeValue:e})}}.bind(this));break;case"video_open":var am=R.up(".t_module").down(".showlayer");var aj=am.down("object").up().innerHTML;am.up(".t_module").down(".hidelayer").show();am.innerHTML="";var ak=this.tamplate_VDOPEN_HTML.evaluate({embed:aj});if($("my_rotateOpen")){$("my_rotateOpen").remove();document.body.appendChild(Builder.build(ak))}else{document.body.appendChild(Builder.build(ak))}this.rotateClose=$("rotateClose");this.rotateCloseHandler=this.rotateCloseClick.bind(this);this.rotateClose.observe("click",this.rotateCloseHandler);if(Mtime.browser.ie){this.ieFixed("my_rotateOpen")}break;case"movieleft":var af=R.up(".t_wentmovie");var ad=af.down("div[current=currented]");if(ad.previous("div")){ad.addClassName("none");ad.removeAttribute("current");ad=ad.previous();ad.setAttribute("current","currented");ad.removeClassName("none");af.down(".turnright").removeClassName("none");if(!ad.previous("div")){af.down(".turnleft").addClassName("none")}return}break;case"movieright":var af=R.up(".t_wentmovie");if(!af.down("div[current=currented]")){af.down("div").setAttribute("current","currented")}var ad=af.down("div[current=currented]");if(ad.next("div")){ad.addClassName("none");ad.removeAttribute("current");ad=ad.next();ad.setAttribute("current","currented");ad.removeClassName("none");af.down(".turnleft").removeClassName("none");if(!ad.next("div")){af.down(".turnright").addClassName("none")}return}break;case"thumbsleft":var ae=R.up(".t_uploadimgs");if(!ae.down("li[current=currented]")){$A(ae.getElementsByTagName("li")).first().setAttribute("current","currented")}var ad=ae.down("li[current=currented]");var aw=null;ae.getAttribute("type")=="default"?aw=3:aw=2;if(ad.previous()){ad.removeAttribute("current");ad=ad.previous(aw);ad.setAttribute("current","currented");ae.down("ul").style.top=-(ad.offsetTop)+"px";ae.down(".turnright").removeClassName("none");if(!ad.previous()){ae.down(".turnleft").addClassName("none")}return}break;case"thumbsright":var ae=R.up(".t_uploadimgs");if(!ae.down("li[current=currented]")){$A(ae.getElementsByTagName("li")).first().setAttribute("current","currented")}var ad=ae.down("li[current=currented]");var aw=null;ae.getAttribute("type")=="default"?aw=3:aw=2;if(ad.next(aw)){ad.removeAttribute("current");ad=ad.next(aw);ad.setAttribute("current","currented");ae.down("ul").style.top=-(ad.offsetTop)+"px";ae.down(".turnleft").removeClassName("none");if(!ad.next(aw)){ae.down(".turnright").addClassName("none")}return}break}},removeComment:function(d,c){if(this.editors[d]){this.editors[d].destroy();this.editors[d]=null}c&&c.remove()},buildComment:function(d,c){this.server.GetTweetCommentSimpleList(d,function(p){if(p&&p.value){var e=(p.value.html?p.value.html:"");var n=$(Builder.build(this.commentTemplate+e+"</div>"));var m=c.down('.t_rreply[type="comment"]');m&&this.removeComment(d,m);c.appendChild(n);var q=(Mtime.isValue(p.value.totalCount)?p.value.totalCount:0);var a=c.down('a[method="comment"]');a.innerHTML="回复("+q+")";var n=c.down("textarea");this.setCursor(n);AutoHeight.startAuto(n);var b=function(){var g=new Weibo.Editor({editor:n});new Weibo.Feedback({editor:g,digitFeedback:{target:c.down('[_type="fd"]'),normalTemplate:"{0}/{1}字",warnTemplate:'<span class="c_red">{0}/{1}字</span>'}});var h=new Weibo.Face({editor:g,addButton:c.down(".ico_adface")});var f=new Weibo.AtSyntax({editor:g});var i=new Weibo.MovieSyntax({editor:g});this.editors[d]=g}.bind(this);this.loadEditorJs(function(){b()});if(p.value.originalSource){var o=c.down('[_type="replyarea"]');o&&o.appendChild(Builder.build('<p class="mt3"><input type="checkbox" _type="rs" class="mr6">同时回复给原'+p.value.originalSource+"</p>"))}}}.bind(this))},builderNode:function(n){var p=new Date().getTime();this.id="dialogBox_"+p;switch(n){case"allGrouping":var j=(window.scope&&scope.groups)?scope.groups.clone():[];var k=[];var o='<a href="'+location.href+(location.href.indexOf("?")==-1?"?":"&")+'groupid={0}">{1}</a>';for(var l=0,m=j.length,i;l<m;++l){i=j[l];k.push(String.format(o,[i.id,i.name]))}o='<div id="allGroupingList" class="t_teamtip" style="position:absolute;">{0}<p class="line_solid">&nbsp;</p><p  _type="addGroup"><a href="#" _type="addGroup" onclick="return false;">创建分组</a></p><p _type="orderGroup"><a href="#" _type="orderGroup" onclick="return false;">调整顺序</a></p><p><a href="'+siteMcUrl+'/app/t/follow/user/" target="_blank">管理分组</a></p></div>';this.windowElement=Builder.build(String.format(o,k.join("")));break}},ieFixed:function(c){if(Mtime.browser.ie&&Mtime.browser.ie<7){function d(){var b=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;var a=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft;this.style.top=document.documentElement.clientHeight+b-this.offsetHeight+"px"}setInterval(d.bind($(c)),100)}},myScroll:function(){var b=document.documentElement.scrollTop||document.body.scrollTop;if(Mtime.browser.ie&&Mtime.browser.ie<7){$("backTop").style.top=document.documentElement.clientHeight+b-200+"px"}if(b==0){$("backTop").style.display="none"}else{$("backTop").style.display="block"}},rotateCloseClick:function(d){var c=Event.element(d);$("my_rotateOpen").remove()},shortText:function(j,h,f){var i=new StringBuilder();var g=0;while(g<=j.length&&Math.floor(i.toString().bytelength()/2)<h){i.append(j.charAt(g++))}i=i.toString();return i.length<j.length&&f?i+f:i},rotateImages:function(l,n){var j=$(l);if(!j||!n){return false}var k=j.getAttribute("step");if(k==null){k=0}if(n=="right"){(k==3)?k=0:k++}else{if(n=="left"){(k==0)?k=3:k--}}j.setAttribute("step",k);if(browser.ie){j.style.filter="progid:DXImageTransform.Microsoft.BasicImage(rotation="+k+")";var m=null;switch(k){case 0:j.style.height=m;break;case 1:if(j.height>470){j.style.height=470}j.style.height=j.height;break;case 2:j.style.height=m;break;case 3:if(j.height>470){m=j.height;j.style.height=470}j.style.height=j.height;break}}else{var c=l.up(".my_rotate_large").down("canvas");if(!c){j.style.visibility="hidden";j.style.position="absolute";c=document.createElement("canvas");c.setAttribute("method","rotate_zoomout");c.className="bimg";j.parentNode.appendChild(c)}var i=c.getContext("2d");switch(k){default:case 0:c.removeAttribute("style");c.setAttribute("width",j.width);c.setAttribute("height",j.height);i.rotate(0*Math.PI/180);i.drawImage(j,0,0);break;case 1:if(j.height>470){c.style.width=470+"px"}c.setAttribute("width",j.height);c.setAttribute("height",j.width);i.rotate(90*Math.PI/180);i.drawImage(j,0,-j.height);break;case 2:c.removeAttribute("style");c.setAttribute("width",j.width);c.setAttribute("height",j.height);i.rotate(180*Math.PI/180);i.drawImage(j,-j.width,-j.height);break;case 3:if(j.height>470){c.style.width=470+"px"}c.setAttribute("width",j.height);c.setAttribute("height",j.width);i.rotate(270*Math.PI/180);i.drawImage(j,-j.width,0);break}}}});var DetailInteractionCtrl=Class.create();Object.extend(DetailInteractionCtrl.prototype,{setCursor:function(h,g,e){g=g==null?h.value.length:g;e=e==null?0:e;h.focus();if(h.createTextRange){var f=h.createTextRange();f.move("character",g);f.moveEnd("character",e);f.select()}else{h.setSelectionRange(g,g+e)}},loadDialogJs:function(b){if(typeof(Weibo)!="undefined"&&typeof(Weibo.Dialog)!="undefined"){b()}else{$loadJs("/js/2011/weibo/popupDialog.js",function(){b()})}},loadEditorJs:function(b){if(typeof(Weibo)!="undefined"&&Weibo.Face&&Weibo.Image&&Weibo.Sync&&Weibo.Syntax&&Weibo.Topic&&Weibo.Video&&Weibo.MovieLinker){b()}else{if(debug){$loadJs(["/js/2011/weibo/editor/editor.js","/js/2011/weibo/editor/image.js","/js/2011/weibo/editor/face.js","/js/2011/weibo/editor/sync.js","/js/2011/weibo/editor/syntax.js","/js/2011/weibo/editor/movieLinker.js","/js/2011/weibo/editor/video.js","/js/2011/weibo/editor/topic.js"],function(){b()})}else{$loadJs("/js/2011/weiboEditor.js",function(){b()})}}},insertText:function(i,j,g,f,h){this.loadEditorJs(function(){i.value="";i.setAttribute("range","0&0");Weibo.TextareaUtils.insertText(i,j,0,f)})},server:{GetTweetCommentList:function(h,g,f,e){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetTweetCommentList",[h,g,f],e,"/Service/Twitter.msi","get","20000")},AddTweetComment:function(m,n,k,i,l,h){var j=Mtime.isValue(k)?[m,n,k,i,false,0,false,false]:[m,n,0,i,false,0,false,false];return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.TwitterService","AddTweetCommentWithOptionCrossDomainByFlash",j,h,"/Service/Twitter.msi","post","20000",l)}},options:{commentRegion:null,roleType:0,pageIndex:1,replyTemplate:'<div class="t_rreply"><span class="tr_jt">&nbsp;</span><div class="clearfix  mb12"><span class="ico_adface fl" title="添加表情">&nbsp;</span><div class="replayarea"><textarea class="t_retextarea"></textarea><p class="mt3"><span class="fr" _type="fd"></span><input type="checkbox" _type="rt" class="mr6">同时转发到我的微评</p></div><a href="#" onclick="return false;" class="t_btn_b2 ml10 fl" method="submit" >发布</a></div></div>'},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeDom();this.initializeEvent()},initializeField:function(){this.commentRegion=$(this.commentRegion);if(Mtime.browser.ie&&Mtime.browser.ie<7){this.overRegionHandler=this.overRegion.bind(this);this.outRegionHandler=this.outRegion.bind(this)}this.clickRegionHandler=this.clickRegion.bind(this);this.editors={}},initializeDom:function(){},initializeEvent:function(){if(Mtime.browser.ie&&Mtime.browser.ie<7){Event.observe(this.commentRegion,"mouseover",this.overRegionHandler);Event.observe(this.commentRegion,"mouseout",this.outRegionHandler)}Event.observe(this.commentRegion,"click",this.clickRegionHandler)},destroy:function(){},destroyField:function(){},destroyDom:function(){},destroyEvent:function(){},overRegion:function(c){var d=Event.element(c);if(d.tagName.toLowerCase()!="li"){d=d.up("li")}if(d&&d.tagName.toLowerCase()=="li"){$$(".hidden",d).each(function(a){a.style.visibility="visible"})}},outRegion:function(c){var d=Event.element(c);if(d.tagName.toLowerCase()!="li"){d=d.up("li")}if(d&&d.tagName.toLowerCase()=="li"){$$(".hidden",d).each(function(a){a.style.visibility="hidden"})}},addCommentErrorCheck:function(i){var j=parseInt(i.value.success);if(j===1){var f=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"内容为空.";case -3:return"非法的用户.";case -4:return"微评不存在.";case -5:return"原回复已被删除.";case -6:return"在对方的黑名单中.";case -7:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var h=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"非法的用户.";case -3:return"原微评不存在.";case -4:return"原微评不存在.";case -5:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var g="";if(parseInt(i.value.commentId,10)<=0){g=f(parseInt(i.value.commentId,10))}if(!g&&i.value.isForward&&parseInt(i.value.forwardTweetId,10)<=0){g=h(parseInt(i.value.forwardTweetId,10))}if(!g&&i.value.isCommentToRoot&&parseInt(i.value.commentToRootId,10)<=0){g=f(parseInt(i.value.commentToRootId,10))}if(g){$alert(g,null,null,4);return false}else{return true}}else{if(j===-4){this.loadDialogJs(function(){new Weibo.AlertDialog({message:'<h4 class="px14 mt3">你已被禁言，无法发布内容</h4><p class="mt9 song"><a href="'+siteMcUrl+'/bantalking/">查看禁言状态&gt;&gt;</a></p>'})});return false}else{if(j===-5){$alert("你的评论有被禁止的内容，请修改后发布。",null,null,4);return false}else{if(j===-20){$alert("你发布的速度太快了，休息一下吧：）",null,null,4);return false}else{if(j===-30){$alert("非法用户",null,null,4);return false}}}}}},clickRegion:function(t){var v=Event.element(t);if(v.hasAttribute("method")){var A=v.getAttribute("method");var q=v.up("li");var r=q.getAttribute("commentid");switch(A){case"reply":Event.stop(t);var C=q.down(".t_rreply");if(!C){C=$(Builder.build(this.replyTemplate));q.appendChild(C);var x=C.down("textarea");AutoHeight.startAuto(x);var e=function(){var b=new Weibo.Editor({editor:x});new Weibo.Feedback({editor:b,digitFeedback:{target:C.down('[_type="fd"]'),normalTemplate:"{0}/{1}字",warnTemplate:'<span class="c_red">{0}/{1}字</span>'}});var c=new Weibo.Face({editor:b,addButton:C.down(".ico_adface")});var a=new Weibo.AtSyntax({editor:b});var d=new Weibo.MovieSyntax({editor:b});this.editors[r]=b;var f=q.down("img.my_img").getAttribute("alt");this.insertText(x,"回复@"+f+":")}.bind(this);this.loadEditorJs(function(){e()})}else{if(C.style.display=="none"){C.show();var x=C.down("textarea");var B=q.down("img.my_img").getAttribute("alt");this.insertText(x,"回复@"+B+":")}else{C.hide()}}break;case"submit":Event.stop(t);var u=this.editors[r];var z=u.getLength();var s=q.down("textarea").value;var D=q.down("input[_type='rt']").checked;if(z>0&&z<=u.lengthExp.max&&!/^回复.*:$/.test(s)){this.server.AddTweetComment(s,serverData.tweetId,r,D,v,function(a){if(a&&a.value&&this.addCommentErrorCheck(a)){this.refreshComment()}}.bind(this))}else{if(z==0||/^回复.*:$/.test(s)){$alert("你还没有填写内容，请填写后提交。",null,null,4)}else{$alert("内容过长,请确认内容字符长度小于"+u.lengthExp.max+"。",null,null,4)}}break;case"deletecomment":Event.stop(t);var y=(v.getAttribute("isblack")!="0");var w=q.getAttribute("ftwitterid");this.loadDialogJs(function(){new Weibo.RemoveReplyDialog({tweetCommentId:r,isShowBlack:y,ftwitterid:w,callback:function(){q.remove()}})});break}}},refreshComment:function(){this.server.GetTweetCommentList(serverData.tweetId,this.roleType,this.pageIndex,function(b){if(b&&b.value){this.commentRegion.innerHTML=(b.value.html?b.value.html:"")}}.bind(this))}});var ReceiveInteractionCtrl=Class.create();Object.extend(ReceiveInteractionCtrl.prototype,{setCursor:function(h,g,e){g=g==null?h.value.length:g;e=e==null?0:e;h.focus();if(h.createTextRange){var f=h.createTextRange();f.move("character",g);f.moveEnd("character",e);f.select()}else{h.setSelectionRange(g,g+e)}},loadDialogJs:function(b){if(typeof(Weibo)!="undefined"&&typeof(Weibo.Dialog)!="undefined"){b()}else{$loadJs("/js/2011/weibo/popupDialog.js",function(){b()})}},loadEditorJs:function(b){if(typeof(Weibo)!="undefined"&&Weibo.Face&&Weibo.Image&&Weibo.Sync&&Weibo.Syntax&&Weibo.Topic&&Weibo.Video&&Weibo.MovieLinker){b()}else{if(debug){$loadJs(["/js/2011/weibo/editor/editor.js","/js/2011/weibo/editor/image.js","/js/2011/weibo/editor/face.js","/js/2011/weibo/editor/sync.js","/js/2011/weibo/editor/syntax.js","/js/2011/weibo/editor/movieLinker.js","/js/2011/weibo/editor/video.js","/js/2011/weibo/editor/topic.js"],function(){b()})}else{$loadJs("/js/2011/weiboEditor.js",function(){b()})}}},insertText:function(i,j,g,f,h){this.loadEditorJs(function(){i.value="";i.setAttribute("range","0&0");Weibo.TextareaUtils.insertText(i,j,0,f)})},server:{AddTweetComment:function(m,n,k,i,l,h){var j=Mtime.isValue(k)?[m,n,k,i,false,0,false,false]:[m,n,0,i,false,0,false,false];return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.TwitterService","AddTweetCommentWithOptionCrossDomainByFlash",j,h,"/Service/Twitter.msi","post","20000",l)}},options:{commentRegion:null,callback:null,replyTemplate:'<div class="t_rreply"><span class="tr_jt">&nbsp;</span><div class="clearfix  mb12"><span class="ico_adface fl" title="添加表情">&nbsp;</span><div class="replayarea"><textarea class="t_retextarea"></textarea><p class="mt3"><span class="fr" _type="fd"></span><input type="checkbox" _type="rt" class="mr6">同时转发到我的微评</p></div><a href="#" onclick="return false;" class="t_btn_b2 ml10 fl" method="submit" >发布</a></div></div>'},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeDom();this.initializeEvent()},initializeField:function(){this.commentRegion=$(this.commentRegion);if(Mtime.browser.ie&&Mtime.browser.ie<7){this.overRegionHandler=this.overRegion.bind(this);this.outRegionHandler=this.outRegion.bind(this)}this.clickRegionHandler=this.clickRegion.bind(this);this.editors={}},initializeDom:function(){},initializeEvent:function(){if(Mtime.browser.ie&&Mtime.browser.ie<7){Event.observe(this.commentRegion,"mouseover",this.overRegionHandler);Event.observe(this.commentRegion,"mouseout",this.outRegionHandler)}Event.observe(this.commentRegion,"click",this.clickRegionHandler)},destroy:function(){},destroyField:function(){},destroyDom:function(){},destroyEvent:function(){},overRegion:function(c){var d=Event.element(c);if(d.tagName.toLowerCase()!="li"){d=d.up("li")}if(d&&d.tagName.toLowerCase()=="li"){$$(".hidden",d).each(function(a){a.style.visibility="visible"})}},outRegion:function(c){var d=Event.element(c);if(d.tagName.toLowerCase()!="li"){d=d.up("li")}if(d&&d.tagName.toLowerCase()=="li"){$$(".hidden",d).each(function(a){a.style.visibility="hidden"})}},addCommentErrorCheck:function(i){var j=parseInt(i.value.success);if(j===1){var f=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"内容为空.";case -3:return"非法的用户.";case -4:return"微评不存在.";case -5:return"原回复已被删除.";case -6:return"在对方的黑名单中.";case -7:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var h=function(a){switch(a){case 0:return"保存失败.";case -1:return"内容过长.";case -2:return"非法的用户.";case -3:return"原微评不存在.";case -4:return"原微评不存在.";case -5:return"原作者微评正在审核中，如有不便敬请谅解！";default:return""}};var g="";if(parseInt(i.value.commentId,10)<=0){g=f(parseInt(i.value.commentId,10))}if(!g&&i.value.isForward&&parseInt(i.value.forwardTweetId,10)<=0){g=h(parseInt(i.value.forwardTweetId,10))}if(!g&&i.value.isCommentToRoot&&parseInt(i.value.commentToRootId,10)<=0){g=f(parseInt(i.value.commentToRootId,10))}if(g){$alert(g,null,null,4);return false}else{return true}}else{if(j===-4){this.loadDialogJs(function(){new Weibo.AlertDialog({message:'<h4 class="px14 mt3">你已被禁言，无法发布内容</h4><p class="mt9 song"><a href="'+siteMcUrl+'/bantalking/">查看禁言状态&gt;&gt;</a></p>'})});return false}else{if(j===-5){$alert("你的评论有被禁止的内容，请修改后发布。",null,null,4);return false}else{if(j===-20){$alert("你发布的速度太快了，休息一下吧：）",null,null,4);return false}else{if(j===-30){$alert("非法用户",null,null,4);return false}}}}}},clickRegion:function(s){var u=Event.element(s);if(u.hasAttribute("method")){var x=u.getAttribute("method");switch(x){case"reply":Event.stop(s);var q=u.up("li");var p=q.getAttribute("commentid");var B=q.getAttribute("tweetid");var y=q.getAttribute("nickname");var z=q.down(".t_rreply");if(!z){z=$(Builder.build(this.replyTemplate));q.down(".t_replaycont").appendChild(z);var v=z.down("textarea");AutoHeight.startAuto(v);var e=function(){var b=new Weibo.Editor({editor:v});new Weibo.Feedback({editor:b,digitFeedback:{target:z.down('[_type="fd"]'),normalTemplate:"{0}/{1}字",warnTemplate:'<span class="c_red">{0}/{1}字</span>'}});var c=new Weibo.Face({editor:b,addButton:z.down(".ico_adface")});var a=new Weibo.AtSyntax({editor:b});var d=new Weibo.MovieSyntax({editor:b});this.editors[p]=b;this.insertText(v,"回复@"+y+":")}.bind(this);this.loadEditorJs(function(){e()})}else{if(z.style.display=="none"){z.show();var v=z.down("textarea");this.insertText(v,"回复@"+y+":")}else{z.hide()}}break;case"submit":Event.stop(s);var q=u.up("li");var p=q.getAttribute("commentid");var B=q.getAttribute("tweetid");var y=q.getAttribute("nickname");var t=this.editors[p];var w=t.getLength();var r=q.down("textarea").value;var A=q.down("input[_type='rt']").checked;if(w>0&&w<=t.lengthExp.max&&!/^回复.*:$/.test(r)){this.server.AddTweetComment(r,B,p,A,u,function(b){if(b&&b.value&&this.addCommentErrorCheck(b)){$alert('<span class="ico_tright">&nbsp;</span> 回复成功',null,null,4);var a=q.down(".t_rreply");a&&a.hide()}}.bind(this))}else{if(w==0||/^回复.*:$/.test(r)){$alert("你还没有填写内容，请填写后提交。",null,null,4)}else{$alert("内容过长,请确认内容字符长度小于"+t.lengthExp.max+"。",null,null,4)}}break}}}});var BannerSliderControl=Class.create();Object.extend(BannerSliderControl.prototype,{options:{sliderClose:"sliderClose",sliderContentRegion:"sliderCont",sliderNums:"sliderNums"},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeEvent();this.load()},initializeField:function(){this.sliderClose=$(this.sliderClose);this.sliderNums=$(this.sliderNums);this.sliderContentRegion=$(this.sliderContentRegion);this.sliderIndex=0},initializeEvent:function(){this.sliderCloseClickHandler=this.sliderCloseClick.bind(this);this.sliderClose&&this.sliderClose.observe("click",this.sliderCloseClickHandler);this.sliderNumsClickHandler=this.sliderNumsClick.bind(this);this.sliderNums&&this.sliderNums.observe("click",this.sliderNumsClickHandler)},destroyDOM:function(){this.sliderClose=null;this.sliderNums=null;this.sliderContentRegion=null},destroyEvent:function(){this.sliderClose&&this.sliderClose.stopObserving("click",this.sliderCloseClickHandler);this.sliderNums&&this.sliderNums.stopObserving("click",this.sliderNumsClickHandler)},close:function(){this.destroyDOM();this.destroyEvent()},load:function(){if(this.sliderNums){this.sliderNums.down("a").addClassName("on");this.timeoutId=setTimeout(function(){this.slideTo(1)}.bind(this),3000)}this.checkMyCookie()},sliderNumsClick:function(g){var e=Event.findElement(g,"a");var f=e;if(f!=document){Event.stop(g);var h=e.previousSiblings().length;clearTimeout(this.timeoutId);this.slideTo(h)}},slideTo:function(i){var l=this.sliderContentRegion.childElements();var k=l.length;var m=this.sliderNums.childElements();var j=l[0].offsetHeight;if(i>=0&&i<=k-1){var h=-j*this.sliderIndex;var n=-j*i;this.animation(this.sliderContentRegion,"top",h,n,0.2,function(){m[i].addClassName("on");m[this.sliderIndex].removeClassName("on");this.sliderIndex=i;if(this.sliderIndex<k-1){this.timeoutId=setTimeout(function(){this.slideTo(this.sliderIndex+1)}.bind(this),3000)}else{this.timeoutId=setTimeout(function(){this.slideTo(0)}.bind(this),3000)}}.bind(this))}},animation:function(p,t,r,v,o,n){var m=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1000/60)}})();var q=60;var u=q*o;var s=(v-r)/(u);var l=function(){p.style[t]=r+"px";r+=s;if(u--<=0){p.style[t]=v+"px";n&&n();return}m(l)};m(l)},setCookie:function(f,h,g){var e=new Date();e.setTime(e.getTime()+g);document.cookie=f+"="+escape(h)+((g==null)?"":"; expires="+e.toGMTString())},sliderCloseClick:function(){this.sliderClose.up().hide();this.setCookie("IndexBannerSlider","1",24*60*60*1000)},checkMyCookie:function(){var b=getCookie("IndexBannerSlider");if(!b){this.sliderClose&&this.sliderClose.up().show()}}});var ScrollTweetList=Class.create();Object.extend(ScrollTweetList.prototype,{minTweetId:0,maxTweetId:0,getXY:function(h){var i=0,j=0;if(h.getBoundingClientRect){var a=h.getBoundingClientRect();var b=document.documentElement;i=a.left+Math.max(b.scrollLeft,document.body.scrollLeft)-b.clientLeft;j=a.top+Math.max(b.scrollTop,document.body.scrollTop)-b.clientTop}else{for(;h!=document.body;i+=h.offsetLeft,j+=h.offsetTop,h=h.offsetParent){}}return{x:i,y:j}},server:{getMoreTweetList:function(d,c){return appManager.$callback("/service/twitter.mt",d,c,null,"GetMoreTweetList")}},options:{requestParams:{},autoLoad:false,loadCallback:null},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeField();this.initializeEvent();if(this.autoLoad){this.loadTweet(this.flowIndex)}},initializeField:function(){this.tweetRegion=$(this.tweetRegion);this.ScrollTweetHandler=this.ScrollTweet.bind(this)},initializeEvent:function(){Event.observe(window,"scroll",this.ScrollTweetHandler);Event.observe(window,"resize",this.ScrollTweetHandler)},close:function(){this.destroy()},destroy:function(){if(!this.destroied){this.destroyEvent();this.destroyField();this.destroied=true}},destroyField:function(){this.ScrollTweetHandler=null},destroyEvent:function(){Event.stopObserving(window,"scroll",this.ScrollTweetHandler);Event.stopObserving(window,"resize",this.ScrollTweetHandler)},loadTweet:function(e,d){if(this.lock){return}this.lock=true;this.requestParams.flowIndex=e;var f=Builder.build('<div class="loading08"></div>');this.tweetRegion.appendChild(f);this.server.getMoreTweetList(this.requestParams,function(b){f.remove();if(b&&b.value){var a=b.value.isPageEnd;if(b.value.tweetsHTML){var j=b.value.tweetsHTML;var c=this.tweetRegion;var i=Builder.build("<div>"+j+"</div>");i.childElements().each(function(g){c.appendChild(g)})}if(b.value.maxTweetId&&b.value.maxTweetId>this.maxTweetId){this.maxTweetId=b.value.maxTweetId}if(b.value.minTweetId&&b.value.minTweetId>this.minTweetId){this.minTweetId=b.value.minTweetId}d&&d();this.loadCallback&&this.loadCallback();if(a){this.destroy()}}this.lock=false}.bind(this))},ScrollTweet:function(){if(this.lock){return}var d=(document.body.scrollTop||document.documentElement.scrollTop)+document.documentElement.clientHeight;var c=this.getXY(this.tweetRegion);if(d>=(c.y+this.tweetRegion.offsetHeight-150)){this.loadTweet(this.flowIndex+1,function(){++this.flowIndex}.bind(this))}}});var backTopControl=Class.create();Object.extend(backTopControl.prototype,{options:{backTop_HTML:'<a href="#" onclick="return false" id="backTop" class="backtop" style="display:none" title="返回顶部">返回顶部</a>'},setOptions:function(b){Object.extend(Object.extend(this,this.options),b)},initialize:function(b){this.setOptions(b);this.initializeEvent();this.load()},initializeEvent:function(){this.mybackTopandler=this.backTop.bind(this);Event.observe(window,"scroll",this.mybackTopandler)},destroyDOM:function(){this.backTopBtn.remove()},destroyEvent:function(){Event.stopObserving(window,"scroll",this.mybackTopandler)},close:function(){this.destroyDOM();this.destroyEvent()},load:function(){this.backTopBtn=Builder.build(this.backTop_HTML);document.body.appendChild(this.backTopBtn);Event.observe(this.backTopBtn,"click",function(){document.body.scrollIntoView()})},backTop:function(){var b=document.documentElement.scrollTop||document.body.scrollTop;if(Mtime.browser.ie&&Mtime.browser.ie<7){this.backTopBtn.style.top=document.documentElement.clientHeight+b-200+"px"}if(b==0){this.backTopBtn.style.display="none"}else{this.backTopBtn.style.display="block"}}});