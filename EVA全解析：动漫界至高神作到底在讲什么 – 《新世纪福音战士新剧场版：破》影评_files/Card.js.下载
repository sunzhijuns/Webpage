var Card=Class.create();Object.extend(Object.extend(Card.prototype),{server:{GetUserInfo:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetUserLayerInfo",[b],a,"/Service/Twitter.msi","get","20000")},GetPersonInfo:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetPersonLayerInfo",[b],a,"/Service/Twitter.msi","get","20000")},GetMovieInfo:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.MovieService","GetMovieLayerInfo",[b],a,"/Service/Movie.msi","get","20000")},GetUserLayerInfoByUserId:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetUserLayerInfoByUserId",[b],a,"/Service/Twitter.msi","get","20000")},GetMovieLayerInfoByMovieId:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.MovieService","GetMovieLayerInfoByMovieId",[b],a,"/Service/Movie.msi","get","20000")},GetPersonLayerInfoByPersonId:function(b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetPersonLayerInfoByPersonId",[b],a,"/Service/Twitter.msi","get","20000")},sendMessage:function(c,b,a){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.MessageService","SendUserMessageToNicknameCrossDomainByFlash",[c,b],a,"/Service/Message.msi","post","20000")},GetBadgeLayerInfo:function(c,b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","GetBadgeLayerInfo",[c,b],a,"/Service/Twitter.msi","get","20000")}},information:{},followBool:false,options:{mytimeContentRegion:"",loadTemplate:'<div class="inner w200"><span class="loading"></span></div>',callback:null},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},initialize:function(a){this.setOptions(a);this.initializeDOM();this.load();this.initializeEvent()},initializeDOM:function(){this.mytimeContentRegion=$(this.mytimeContentRegion);this.collectBoxTimeout=null},destroyDOM:function(){this.mytimeContentRegion=null;this.collectBoxId=null;this.followBool=false},initializeEvent:function(){if(this.mytimeContentRegion){this.onOverHandler=this.onOver.bind(this);this.mytimeContentRegion.observe("mouseover",this.onOverHandler);this.onOutHandler=this.onOut.bind(this);this.mytimeContentRegion.observe("mouseout",this.onOutHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.mytimeContentRegion){this.mytimeContentRegion.stopObserving("mouseover",this.onOverHandler);this.mytimeContentRegion.stopObserving("mouseout",this.onOutHandler);this.mytimeContentRegion.stopObserving("click",this.clickRegionHandler)}},load:function(){if(typeof(Follow)=="undefined"){$loadJs("/js/2011/weibo/Follow.js")}},render:function(){},onOver:function(b){var a=Event.element(b);this.cardElement=a;this.method=a.getAttribute("method");this.clientx=b.clientX;this.clienty=b.clientY;switch(this.method){case"usercard":this.userMethod(this.method);break;case"useridcard":this.userMethod(this.method);break;case"personcard":this.personMethod(this.method);break;case"personidcard":this.personMethod(this.method);break;case"moviecard":this.movieMethod(this.method);break;case"movieidcard":this.movieMethod(this.method);break;case"badgecard":this.badgeMethod(this.method);break}},userMethod:function(a){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var b;if(a==="usercard"){b=this.cardElement.readAttribute("ftwitterid")}else{if(a==="useridcard"){b=this.cardElement.readAttribute("userid")}}this.twitterId=b;this.key=a+b;this.cardElement.makePositioned();if(this.information[this.key]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(a==="usercard"){this.server.GetUserInfo(b,function(c){if(c&&c.value){var d=c.value.value;this.information[this.key]=d;this.overMy_leftMethod(this.cardElement,d)}}.bind(this))}else{if(a==="useridcard"){this.server.GetUserLayerInfoByUserId(b,function(c){if(c&&c.value){var d=c.value.value;this.information[this.key]=d;this.overMy_leftMethod(this.cardElement,d)}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[this.key])}},500,this)},movieMethod:function(a){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var b;if(a==="moviecard"){b=this.cardElement.readAttribute("ftwitterid")}else{if(a==="movieidcard"){b=this.cardElement.readAttribute("movieid")}}this.key=a+b;this.cardElement.makePositioned();if(this.information[this.key]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(a==="moviecard"){this.server.GetMovieInfo(b,function(g){if(g&&g.value){var c=g.value;var d;if(c.NotFound){var e=this.cardElement.readAttribute("alt");var f=e!==null?e:this.cardElement.innerHTML;f=f.replace("《","");f=f.replace("》","");d=String.format(c.value,f);c.value=d}else{d=c.value.replace('<div class="td">','<div class="td" style="height: 128px;">')}this.information[this.key]=c;this.overMy_leftMethod(this.cardElement,d);if(this.collectBox!=null&&c.isLogin){this.newMovieRatingButtonControl(c)}}}.bind(this))}else{if(a==="movieidcard"){this.server.GetMovieLayerInfoByMovieId(b,function(g){if(g&&g.value){var c=g.value;var d;if(c.NotFound){var e=this.cardElement.readAttribute("alt");var f=e!==null?e:this.cardElement.innerHTML;f=f.replace("《","");f=f.replace("》","");d=String.format(c.value,f);c.value=d}else{d=c.value.replace('<div class="td">','<div class="td" style="height: 128px;">')}this.information[this.key]=c;this.overMy_leftMethod(this.cardElement,d);if(this.collectBox!=null&&c.isLogin){this.newMovieRatingButtonControl(c)}}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[this.key].value);if(this.collectBox!=null&&this.information[this.key].isLogin){this.newMovieRatingButtonControl(this.information[this.key])}}this.statisticsMoive("display")},500,this)},newMovieRatingButtonControl:function(a){new MovieRatingControl({id:a.movieId,isLogin:a.isLogin,userRating:a.userMovieRating,movieRatingControlContainer:a.movieRatingButtonContainer,okCallback:this.movieRatingCallback.bind(this),initializeDOM:function(){this.movieRatingControlContainer=$(this.movieRatingControlContainer);var b=Builder.node("div",{className:"fl ele_grade_main clearfix",style:"position: relative;"});this.movieRatingControlContainer.innerHTML="";this.movieRatingControlContainer.appendChild(b);this.userRatingDescriptionLabel=$(Builder.node("div",{className:"describe",style:"right: -50px;"}));b.appendChild(this.userRatingDescriptionLabel);this.userRatingDescriptionLabel.hide();this.wantToSeeButton=$(Builder.node("a",{href:"#",className:"btn_w fl"},[Builder.node("span",["想看"])]));this.userRatingContainer=$(Builder.node("ul",{className:"clearfix srating fl ml9 mt3"}));this.userRatingResultLabel=$(Builder.node("b",{className:"c_green bold"}));this.updateUserRatingButton=$(Builder.node("a",{href:"#"},["修改"]));this.userRatingResultRegion=$(Builder.node("span",{className:"fl ml12"},["评分：",this.userRatingResultLabel," (",this.updateUserRatingButton,")"]));b.appendChild(this.wantToSeeButton);b.appendChild(this.userRatingContainer);b.appendChild(this.userRatingResultRegion)},load:function(){if(this.userRating.Rating>0){this.userRatingResultLabel.innerHTML=this.userRating.Rating;this.userRatingContainer.hide()}else{this.userRatingResultRegion.hide()}},renderUserRatingRegion:function(){if(this.userRating){if(this.userRating.Rating>0){this.userRatingControl.setValue(this.userRating.Rating);this.userRatingResultLabel.innerHTML=MovieRatingHelper.getRatingString(this.userRating.Rating);this.userRatingContainer.hide();this.userRatingResultRegion.show();this.renderUserRating(this.userRating.Rating);this.setWantToSeeButton(true)}else{this.userRatingControl.setValue(0);this.userRatingResultRegion.hide();this.userRatingContainer.show();this.renderUserRating(0);if(this.userRating.Attitude===1){this.setWantToSeeButton(false);this.setNotInterestButton(true)}else{if(this.userRating.Attitude===2){this.setWantToSeeButton(true);this.setNotInterestButton(false)}}}}},render:function(){if(this.userRatingControl){this.renderUserRatingRegion()}},onClickUpdateUserRatingButton:function(b){Event.stop(b);this.userRatingResultRegion.hide();this.userRatingContainer.show()}})},movieRatingCallback:function(a){this.information[this.key]=undefined},movieRatingClick:function(a){this.followBool=false},personMethod:function(a){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var b;if(a==="personcard"){b=this.cardElement.readAttribute("ftwitterid")}else{if(a==="personidcard"){b=this.cardElement.readAttribute("personid")}}var c=a+b;this.cardElement.makePositioned();if(this.information[c]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);if(a==="personcard"){this.server.GetPersonInfo(b,function(e){if(e&&e.value){var d=e.value.value.replace('<div class="td">','<div class="td" style="height: 128px;">');this.information[c]=d;this.overMy_leftMethod(this.cardElement,d)}}.bind(this))}else{if(a==="personidcard"){this.server.GetPersonLayerInfoByPersonId(b,function(e){if(e&&e.value){var d=e.value.value.replace('<div class="td">','<div class="td" style="height: 128px;">');this.information[c]=d;this.overMy_leftMethod(this.cardElement,d)}}.bind(this))}}}else{this.overMy_leftMethod(this.cardElement,this.information[c])}},500,this)},badgeMethod:function(a){this.handleOutTimer();this.collectBoxTimeout=FunctionExt.defer(function(){var d=this.cardElement.readAttribute("userid");var c=this.cardElement.readAttribute("medaltype");var b=a+c;this.cardElement.makePositioned();if(this.information[b]===undefined){this.overMy_leftMethod(this.cardElement,this.loadTemplate);this.server.GetBadgeLayerInfo(d,c,function(f){if(f&&f.value){var e=f.value.value;this.information[b]=e;this.overMy_leftMethod(this.cardElement,e)}}.bind(this))}else{this.overMy_leftMethod(this.cardElement,this.information[b])}},500,this)},onOut:function(b){var a=Event.element(b);var c=a.getAttribute("method");if(c==="usercard"||c==="moviecard"||c==="personcard"||c==="useridcard"||c==="movieidcard"||c==="personidcard"||c==="badgecard"){this.handleOutTimer();if(this.collectBox!=null){this.collectBoxTimeout=FunctionExt.defer(function(){if(this.followBool==false){this.closeCard()}},500,this)}}},clickCollectBox:function(f){var c=Event.element(f);if(Mtime.browser.ie&&Mtime.browser.ie>6){var e=c.up("div.ele_select");var m=c.hasClassName("ele_select")?c:null;var g=m||e;if(g){this.followBool=true;this.timedCount()}}var i=c.readAttribute("method");switch(i){case"message":var k=c.readAttribute("nickname");new Weibo.SendMessageDialog({user:{nickname:k}});this.closeCardIeMethod();break;case"at":var k=c.readAttribute("nickname");new Weibo.TwitterDialog({content:"对@"+k+" 说:"});this.closeCardIeMethod();break;case"remark":var h=c.readAttribute("ftwitterid");var l=c.readAttribute("remark");new Weibo.UpdateRemarkDialog({user:{id:h,remark:l},callback:function(){this.information[this.key]=undefined}.bind(this)});this.closeCardIeMethod();break;case"group":var h=c.readAttribute("ftwitterid");var k=c.readAttribute("nickname");new Weibo.FollowSuccDialog({user:{id:h,name:k}});this.closeCardIeMethod();break;case"aFollow":this.followBool=true;break;case"bFollow":this.followBool=true;break;case"quickticketbutton":this.statisticsMoive("buyTicket");var d=c.readAttribute("date");var j=c.readAttribute("movieid");var a=c.readAttribute("cityid");var b=c.readAttribute("cityname");TheaterQuickTicketsDialog&&new TheaterQuickTicketsDialog({city:{Id:a,NameCn:b},selectedMovieId:j,selectedDate:d});break;case"gotoshowtimespage":this.statisticsMoive("searchShowtimes");break}},timedCount:function(){if(this.isChanger){this.contentEnd=$("contentEnd");if(this.contentEnd){this.movieRating=this.contentEnd.down(".w330");if(this.movieRating){setTimeout(function(){this.timedCount()}.bind(this),1000)}else{if(this.collectBox!=null){this.closeCard();this.followBool=false}this.isChanger=false}}}else{setTimeout(function(){this.timedCount()}.bind(this),1000);this.isChanger=true}},closeCardIeMethod:function(){if(Mtime.browser.ie&&Mtime.browser.ie<7&&this.collectBox!=null){this.closeCard()}},overMy_leftMethod:function(a,b){if(this.collectBox!=null){this.closeCard()}this.isAutoClose=true;if(this.method==="moviecard"||this.method==="movieidcard"){this.isAutoClose=false}this.collectBox=new DialogBox({element:a,content:b,arrowNew:true,isAutoClose:this.isAutoClose,setupDimensions:function(){var k=0,m=0;var o=this.windowElement.getDimensions();var p=o.width;var n=o.height;var i=this.elementX+this.elementWidth/2;var j=this.elementY;var f=i;var g=j+this.elementHeight;if(this.arrowNew){var d=this.cardId.down("em."+this.indicationStyle)}else{var d=this.cardId.down("p."+this.indicationStyle)}var c;if(d===undefined||d===null){c=17}else{c=d.getHeight()}switch(this.positionType){case 0:k=f-47;m=g+c;break;case 1:k=f-(p-47);m=g+c;break;case 2:k=i-47;m=j-c-n;break;case 3:k=i-(p-47);m=j-c-n;break;default:k=f-47;m=g+c;break}var q=0;if(this.overlay){q=parseInt(this.overlay.getStyle("zIndex"),10)+1}else{q=Windows.getZIndex()+1}if(Mtime.browser.ie&&Mtime.browser.ie>=7){var e=this.element.getHeight();var h=this.element.getStyle("fontSize");var l=parseInt(h.slice(0,2),10);if(this.element.innerHTML!==""&&e>l+10){k=200}}this.windowElement.setStyle({position:"absolute",top:m+"px",left:k+"px",zIndex:q})}});this.collectBoxId=$(this.collectBox.id);this.isWordWrap(a);if(this.collectBoxId){this.overCollectBoxIdHandler=this.overCollectBox.bind(this);this.outCollectBoxIdHandler=this.outCollectBox.bind(this);this.clickCollectBoxIdHandler=this.clickCollectBox.bind(this);this.collectBoxId.observe("mouseover",this.overCollectBoxIdHandler);this.collectBoxId.observe("mouseout",this.outCollectBoxIdHandler);this.collectBoxId.observe("click",this.clickCollectBoxIdHandler)}if(this.method==="usercard"||this.method==="useridcard"){this.methodStr=this.method;this.follow=new Follow({container:this.collectBox.id,ischange:true,iscard:true,isuser:true,callback:this.getFollowBool.bind(this)})}},getFollowBool:function(b,a,c){this.followBool=a;if(this.twitterId){this.information[this.methodStr+this.twitterId]=undefined;this.twitterId=null}this.callback&&this.callback(c)},overCollectBox:function(a){Event.stop(a);this.handleOutTimer()},outCollectBox:function(a){Event.stop(a);this.collectBoxTimeout=FunctionExt.defer(function(){if(this.followBool==false){this.closeCard()}},500,this)},handleOutTimer:function(){if(this.collectBoxTimeout!=null){clearTimeout(this.collectBoxTimeout);this.collectBoxTimeout=null;this.collectBoxId=null}},isWordWrap:function(c){var d=c.getHeight();var i=c.getStyle("fontSize");var s=parseInt(i.slice(0,2),10);if(c.innerHTML!==""&&d>s+10){var p=c.up(0);var r=p.getWidth();var e=c.getWidth();var q=Position.cumulativeOffset(p);var k=Position.cumulativeOffset(c);var f=r-(this.collectBox.elementX-q[0]);var b;var n;var m;var h;var a=this.collectBoxId.down("em",0);if(this.collectBox.elementX<=this.clientx){b=Math.round(f/2);n=this.collectBox.elementX;m=k[1];h=m+d/2}else{var j=c.innerHTML.length;var t=(s*j-f)+(r-e);b=20;n=q[0];m=k[1]+d/2+5;h=this.collectBox.elementY+this.collectBox.elementHeight;if(this.collectBox.positionType===1){this.collectBox.positionType=0;if(a!==undefined||a!==null){a.className="tl_arrow"}}if(this.collectBox.positionType===3){this.collectBox.positionType=2;if(a!==undefined||a!==null){a.className="bl_arrow"}}}var o=0,u=0;var w=this.collectBoxId.getDimensions();var x=w.width;var v=w.height;var l=n+b;var g=l;if(a!==undefined||a!==null){arrowHeight=a.getHeight()}else{arrowHeight=10}switch(this.collectBox.positionType){case 0:o=g-67;u=h+arrowHeight;break;case 1:o=g-(x-47);u=h+arrowHeight;break;case 2:o=l-67;u=m-arrowHeight-v;break;case 3:o=l-(x-47);u=m-arrowHeight-v;break;default:o=g-67;u=h+arrowHeight;break}this.collectBoxId.setStyle({top:u+"px",left:o+"px"})}},statisticsMoive:function(a){var h="M13_MovieLayer_Other";var g="";var b=["M11_TwitterIndex","M13_News","M08_Movie_Overview"];var d=["http://my.mtime.com","http://news.mtime.com","http://movie.mtime.com"];var e=["http://my.test.com","http://news.test.com","http://movie.test.com"];var c;if(siteUrl.indexOf("http://www.mtime.com")==0){c=d}else{if(siteUrl.indexOf("http://www.test.com")==0){c=e}}for(var f=0;f<c.length;f++){if(location.href.indexOf(c[f])==0){h=b[f];break}}switch(h){case"M13_News":switch(a){case"display":g="M13_News_MovieLayer_Display";break;case"buyTicket":g="M13_News_MovieLayer_BuyTicket";break;case"searchShowtimes":g="M13_News_MovieLayer_SerachShowtimes";break}break;case"M08_Movie_Overview":switch(a){case"display":g="M08_Movie_Overview_MovieLayer_Display";break;case"buyTicket":g="M08_Movie_Overview_MovieLayer_BuyTicket";break;case"searchShowtimes":g="M08_Movie_Overview_MovieLayer_SerachShowtimes";break}break;case"M11_TwitterIndex":switch(a){case"display":g="M11_TwitterIndex_MovieLayer_Display";break;case"buyTicket":g="M11_TwitterIndex_MovieLayer_BuyTicket";break;case"searchShowtimes":g="M11_TwitterIndex_MovieLayer_SerachShowtimes";break}break;case"M13_MovieLayer_Other":switch(a){case"display":g="M13_MovieLayer_Other_Display";break;case"buyTicket":g="M13_MovieLayer_Other_BuyTicket";break;case"searchShowtimes":g="M13_MovieLayer_Other_SerachShowtimes";break}break}if(typeof(tracker)!=="undefined"){tracker.trackClick(h,g)}},closeCard:function(){if(this.collectBoxId){this.collectBoxId.stopObserving("mouseover",this.overCollectBoxIdHandler);this.collectBoxId.stopObserving("mouseout",this.outCollectBoxIdHandler)}this.collectBoxId=null;this.collectBox.close()},closed:false,close:function(){if(!this.closed){this.closed=true;this.destroyEvent();this.destroyDOM();this.information=null}}});